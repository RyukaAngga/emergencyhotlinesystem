<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Dashboard - EHS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-title p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 30px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: white;
            color: #ff6b35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .user-details span {
            display: block;
            font-size: 12px;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-stop-alarm {
            background: linear-gradient(135deg, #ff3e3e 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: none; 
            animation: pulse 1.5s infinite;
        }

        .btn-stop-alarm:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: scale(1.05);
        }

        .btn-stop-alarm.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 62, 62, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 62, 62, 0); }
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.orange {
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
        }

        .stat-icon.red {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }

        .stat-icon.green {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .stat-info h3 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .stat-info p {
            font-size: 14px;
            color: #666;
        }

        .filters {
            background: white;
            padding: 20px 25px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 11px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .cases-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .cases-header {
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cases-header h2 {
            font-size: 20px;
            color: #1a1a1a;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #22c55e;
            font-size: 14px;
            font-weight: 600;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        .cases-list {
            padding: 0;
            overflow-x: auto;
            cursor: grab;
        }

        .cases-list:active {
            cursor: grabbing;
        }

        .cases-list::-webkit-scrollbar {
            height: 8px;
        }

        .cases-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .cases-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .cases-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .case-item {
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s ease;
        }

        .case-item:hover {
            background: #fafafa;
        }

        .case-item:last-child {
            border-bottom: none;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .case-id {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 6px;
        }

        .case-time {
            font-size: 13px;
            color: #999;
        }

        .case-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .case-status.active {
            background: #fee;
            color: #dc2626;
        }

        .case-status.handled {
            background: #efe;
            color: #22c55e;
        }

        .case-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 25px;
        }

        .case-image {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .case-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .case-details {
            flex: 1;
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            min-width: 160px;
        }

        .detail-value {
            color: #1a1a1a;
        }

        .accident-type {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
        }

        .case-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-action.primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
        }

        .btn-action.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-action.secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-action.secondary:hover {
            background: #e5e5e5;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .popup-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .popup-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .popup-icon.success {
            color: #4CAF50;
        }

        .popup-icon.error {
            color: #f44336;
        }

        .popup-icon.warning {
            color: #ff9800;
        }

        .popup-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .popup-message {
            font-size: 15px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .chat-toggle .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .chat-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
        }

        .chat-panel.active {
            display: flex;
        }

        .chat-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.own {
            align-items: flex-end;
        }

        .chat-message-header {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .chat-message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
        }

        .chat-message.own .chat-message-bubble {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.other .chat-message-bubble {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .chat-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .chat-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
                margin: 20px auto;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .case-content {
                grid-template-columns: 1fr;
            }

            .case-image {
                width: 100%;
            }

            .case-actions {
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
                justify-content: center;
            }

            .popup-content {
                padding: 25px;
                max-width: 90%;
            }

            .popup-icon {
                font-size: 40px;
            }

            .popup-title {
                font-size: 20px;
            }

            .popup-message {
                font-size: 14px;
            }

            .chat-panel {
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .chat-toggle {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Audio Permission Overlay */
        .audio-permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .audio-permission-overlay.hidden {
            display: none;
        }

        .audio-permission-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .audio-permission-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .audio-permission-content h2 {
            color: #1a1a1a;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .audio-permission-content p {
            color: #666;
            font-size: 15px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .btn-enable-audio {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .btn-enable-audio:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.4);
        }

        .btn-enable-audio:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    
    <!-- Audio Permission Overlay -->
    <div class="audio-permission-overlay" id="audioPermissionOverlay">
        <div class="audio-permission-content">
            <div class="audio-permission-icon">
                <i class="fas fa-volume-up"></i>
            </div>
            <h2>üîî Aktifkan Notifikasi Suara</h2>
            <p>Dashboard ini memerlukan izin untuk memutar alarm saat ada kasus darurat baru. Klik tombol di bawah untuk mengaktifkan suara notifikasi.</p>
            <button class="btn-enable-audio" id="btnEnableAudio">
                <i class="fas fa-bell"></i> Aktifkan Suara Alarm
            </button>
        </div>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-title" id="popupTitle"></div>
            <div class="popup-message" id="popupMessage"></div>
            <button class="popup-btn" onclick="closePopup()">OK</button>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-truck-medical"></i>
                </div>
                <div class="header-title">
                    <h1>Emergency Dashboard</h1>
                    <p>Real-time Emergency Response System</p>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-stop-alarm" id="btnStopAlarm" onclick="stopEmergencyAlarm()">
                    <i class="fas fa-volume-mute"></i> Stop Alarm
                </button>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">ER</div>
                    <div class="user-details">
                        <strong id="userName">Emergency Responder</strong>
                        <span id="userRole">Emergency Access</span>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="statActive">0</h3>
                    <p>Kasus Aktif</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-info">
                    <h3 id="statToday">0</h3>
                    <p>Darurat Hari Ini</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="statHandled">0</h3>
                    <p>Telah Ditangani</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="statAvgResponse">0</h3>
                    <p>Rata-rata Respons (menit)</p>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="filterStatus">Status</label>
                <select id="filterStatus">
                    <option value="all">Semua Status</option>
                    <option value="active">Aktif</option>
                    <option value="handled">Ditangani</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterType">Jenis Kecelakaan</label>
                <select id="filterType">
                    <option value="all">Semua Jenis</option>
                    <option value="medical">Medis</option>
                    <option value="fire">Kebakaran</option>
                    <option value="crime">Kejahatan</option>
                    <option value="accident">Kecelakaan</option>
                    <option value="other">Lainnya</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterDate">Tanggal</label>
                <input type="date" id="filterDate">
            </div>
            <button class="btn-refresh" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <div class="cases-container">
            <div class="cases-header">
                <h2>Kasus Darurat</h2>
                <div class="live-indicator">
                    <div class="pulse-dot"></div>
                    Live Updates
                </div>
            </div>
            <div class="cases-list" id="casesList">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Tidak Ada Kasus Darurat</h3>
                    <p>Sistem akan menampilkan kasus darurat secara real-time ketika tombol emergency ditekan</p>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-toggle" id="chatToggle">
        <i class="fas fa-comments"></i>
        <div class="badge" id="chatBadge" style="display: none;">0</div>
    </div>

    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <h3>
                <i class="fas fa-comments"></i>
                Emergency Chat
            </h3>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">
                <i class="fas fa-comment-dots"></i>
                <p>Belum ada pesan</p>
            </div>
        </div>
        <div class="chat-input-area">
            <form class="chat-input-form" id="chatForm">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Ketik pesan..."
                    autocomplete="off"
                    required
                >
                <button type="submit" class="chat-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        const token = sessionStorage.getItem('emergency_token');
        const currentUser = JSON.parse(sessionStorage.getItem('emergency_user') || '{}');

        if (!token) {
            window.location.href = 'login-emergency.html';
        }

        if (currentUser.name) {
            document.getElementById('userName').textContent = currentUser.name;
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatar').textContent = initials;
        }
        if (currentUser.role) {
            document.getElementById('userRole').textContent = currentUser.role;
        }

        const socket = io();

        function logout() {
            sessionStorage.removeItem('emergency_token');
            sessionStorage.removeItem('emergency_user');
            window.location.href = 'login-emergency.html';
        }

        async function loadCases() {
            try {

                const status = document.getElementById('filterStatus').value;
                const type = document.getElementById('filterType').value;
                const date = document.getElementById('filterDate').value;
                
                console.log(' Loading cases with filters:', { status, type, date });

                const params = new URLSearchParams();
                if (status && status !== 'all') params.append('status', status);
                if (type && type !== 'all') params.append('type', type);
                if (date) params.append('date', date);
                
                const response = await fetch(`/api/emergency-cases?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {

                        console.error(' Unauthorized - Token expired or invalid');
                        sessionStorage.removeItem('emergency_token');
                        sessionStorage.removeItem('emergency_user');
                        window.location.href = 'login-emergency.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log(' Loaded cases:', result);

                if (result.success) {
                    updateStats(result.stats);
                    renderCases(result.cases);
                } else {
                    console.error(' API returned error:', result.error);
                    showPopup('Error', 'Gagal memuat data kasus darurat', 'error');
                }
            } catch (error) {
                console.error(' Error loading cases:', error);
                showPopup('Error', 'Gagal memuat data: ' + error.message, 'error');
            }
        }

        function updateStats(stats) {
            document.getElementById('statActive').textContent = stats.active || 0;
            document.getElementById('statToday').textContent = stats.today || 0;
            document.getElementById('statHandled').textContent = stats.handled || 0;
            document.getElementById('statAvgResponse').textContent = stats.avgResponse || 0;
        }

        function renderCases(cases) {
            const container = document.getElementById('casesList');

            console.log(' renderCases called with:', cases);
            console.log(' Number of cases:', cases?.length);

            if (!cases || cases.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Tidak Ada Kasus Darurat</h3>
                        <p>Sistem akan menampilkan kasus darurat secara real-time ketika tombol emergency ditekan</p>
                    </div>
                `;
                return;
            }

            console.log(' Rendering cases:', cases); // Debug

            container.innerHTML = cases.map(caseData => {
                console.log(' Rendering case:', caseData);
                console.log(' Case photo data:', { 
                    scanPhoto: caseData.scanPhoto, 
                    userPhoto: caseData.userPhoto 
                }); // Debug
                
                const scanId = caseData.scanId || `SCAN-${caseData.id}`;
                const scanTime = caseData.timestamp;
                const location = caseData.location || { latitude: -6.9559, longitude: 107.6411 };
                const coordinates = `${location.latitude}, ${location.longitude}`;
                const mapLink = 'https://maps.app.goo.gl/rnx3LPv4myKpDTfAA';
                
                return `
                <div class="case-item">
                    <div class="case-header">
                        <div>
                            <div class="case-id">#${caseData.id}</div>
                            <div class="case-time">
                                <i class="fas fa-clock"></i> ${formatDateTime(scanTime)}
                            </div>
                        </div>
                        <div class="case-status ${caseData.status}">
                            ${caseData.status === 'active' ? 'AKTIF' : 'DITANGANI'}
                        </div>
                    </div>
                    <div class="case-content">
                        <div class="case-image">
                            ${caseData.scanPhoto || caseData.userPhoto ? 
                                `<img src="${caseData.scanPhoto || caseData.userPhoto}" alt="Scan Photo" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="photo-placeholder" style="display:none; width:100%; height:100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 60px; align-items: center; justify-content: center; border-radius: 12px;">
                                    <i class="fas fa-user-circle"></i>
                                </div>` 
                                : 
                                `<div class="photo-placeholder" style="display:flex; width:100%; height:100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 60px; align-items: center; justify-content: center; border-radius: 12px;">
                                    <i class="fas fa-user-circle"></i>
                                </div>`
                            }
                        </div>
                        <div class="case-details">
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-${getAccidentIcon(caseData.accidentType)}"></i>
                                    Jenis Kecelakaan:
                                </span>
                                <span class="accident-type ${caseData.accidentType}">
                                    ${getAccidentName(caseData.accidentType)}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-barcode"></i> ID Scan:
                                </span>
                                <span class="detail-value">${scanId}</span>
                            </div>
                            ${caseData.bodyTemperature ? `
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-thermometer-half"></i> Suhu Tubuh:
                                </span>
                                <span class="detail-value">
                                    ${parseFloat(caseData.bodyTemperature) < 37.3 ? 
                                        `<span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 13px; border: 1px solid #a7f3d0;">${caseData.bodyTemperature}¬∞C - Normal</span>` :
                                        parseFloat(caseData.bodyTemperature) < 37.6 ?
                                        `<span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 13px; border: 1px solid #fde68a;">${caseData.bodyTemperature}¬∞C - Hangat</span>` :
                                        `<span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 13px; border: 1px solid #fecaca;">${caseData.bodyTemperature}¬∞C - Demam</span>`
                                    }
                                </span>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-calendar-alt"></i> Waktu Scan:
                                </span>
                                <span class="detail-value">${formatDateTime(scanTime)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-map-marker-alt"></i> Lokasi:
                                </span>
                                <span class="detail-value">SMK MARHAS Margahayu</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">
                                    <i class="fas fa-map-pin"></i> Koordinat:
                                </span>
                                <span class="detail-value">${coordinates}</span>
                            </div>
                            <div class="case-actions">
                                <a href="${mapLink}" target="_blank" class="btn-action primary">
                                    <i class="fas fa-map-marked-alt"></i> Buka Google Maps
                                </a>
                                ${caseData.status === 'active' ? `
                                <button class="btn-action secondary" onclick="markHandled('${caseData.id}')">
                                    <i class="fas fa-check"></i> Tandai Ditangani
                                </button>
                                ` : `
                                <div class="handled-info">
                                    <i class="fas fa-check-circle"></i> Ditangani oleh: ${caseData.respondedBy || 'System'}
                                    ${caseData.responseTime ? `<br><small>Response time: ${Math.round(caseData.responseTime / 60000)} menit</small>` : ''}
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getAccidentIcon(type) {
            const icons = {
                medical: 'hospital',
                fire: 'fire',
                crime: 'shield-alt',
                accident: 'car-crash',
                other: 'exclamation-triangle'
            };
            return icons[type] || 'exclamation-triangle';
        }
        
        function getAccidentName(type) {
            const names = {
                medical: 'MEDIS',
                fire: 'KEBAKARAN',
                crime: 'KRIMINAL',
                accident: 'KECELAKAAN',
                other: 'LAINNYA'
            };
            return names[type] || 'LAINNYA';
        }

        function showPopup(title, message, type = 'success') {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');

            const icons = {
                success: '',
                error: '',
                warning: ''
            };

            icon.textContent = icons[type] || icons.success;
            icon.className = `popup-icon ${type}`;
            titleEl.textContent = title;
            messageEl.textContent = message;

            overlay.classList.add('active');
        }

        function closePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('active');
        }

        function markHandled(id) {

            const confirmOverlay = document.createElement('div');
            confirmOverlay.className = 'popup-overlay active';
            confirmOverlay.innerHTML = `
                <div class="popup-content">
                    <div class="popup-icon warning"></div>
                    <div class="popup-title">Konfirmasi</div>
                    <div class="popup-message">Tandai kasus ini sebagai sudah ditangani?</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="popup-btn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);" onclick="confirmHandle(${id}, this)">Ya, Tangani</button>
                        <button class="popup-btn" style="background: linear-gradient(135deg, #f44336 0%, #da190b 100%);" onclick="cancelHandle(this)">Batal</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmOverlay);
        }

        function confirmHandle(id, btnElement) {
            const confirmOverlay = btnElement.closest('.popup-overlay');
            confirmOverlay.remove();

            fetch(`/api/emergency-cases/${id}/handle`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    respondedBy: currentUser.email,
                    notes: 'Ditangani via Emergency Dashboard'
                })
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    showPopup(' Berhasil', 'Kasus telah ditandai sebagai ditangani', 'success');
                    loadCases();
                } else {
                    showPopup(' Gagal', result.error || 'Terjadi kesalahan', 'error');
                }
            })
            .catch(err => {
                showPopup(' Error', err.message, 'error');
            });
        }

        function cancelHandle(btnElement) {
            const confirmOverlay = btnElement.closest('.popup-overlay');
            confirmOverlay.remove();
        }

        function refreshData() {
            loadCases();
        }

        const emergencyAlarmAudio = new Audio('./alarm/emergency-alarm.mp3');
        emergencyAlarmAudio.volume = 1.0; // Maximum volume (100%)
        let alarmPlayCount = 0;
        const maxAlarmRepeats = 3;
        const btnStopAlarm = document.getElementById('btnStopAlarm');
        
        // Track user interaction for audio autoplay policy
        let userHasInteracted = false;
        let pendingAlarm = false;
        const audioPermissionOverlay = document.getElementById('audioPermissionOverlay');
        const btnEnableAudio = document.getElementById('btnEnableAudio');

        // Check if user already enabled audio (saved in sessionStorage)
        if (sessionStorage.getItem('audioEnabled') === 'true') {
            userHasInteracted = true;
            audioPermissionOverlay.classList.add('hidden');
        }

        // Enable audio when user clicks the button
        btnEnableAudio.addEventListener('click', () => {
            userHasInteracted = true;
            sessionStorage.setItem('audioEnabled', 'true');
            audioPermissionOverlay.classList.add('hidden');
            
            // Play a short test sound to "unlock" audio
            emergencyAlarmAudio.volume = 0.1;
            emergencyAlarmAudio.play().then(() => {
                emergencyAlarmAudio.pause();
                emergencyAlarmAudio.currentTime = 0;
                emergencyAlarmAudio.volume = 1.0;
                console.log('‚úÖ Audio enabled successfully');
                
                // If there was a pending alarm, play it now
                if (pendingAlarm) {
                    pendingAlarm = false;
                    playEmergencyAlarm();
                }
            }).catch(err => {
                console.error('Audio test failed:', err);
            });
        });

        // Also enable audio on any click in the document
        document.addEventListener('click', () => {
            if (!userHasInteracted) {
                userHasInteracted = true;
                sessionStorage.setItem('audioEnabled', 'true');
            }
        }, { once: true });

        function playEmergencyAlarm() {
            // If user hasn't interacted yet, show the overlay and queue the alarm
            if (!userHasInteracted) {
                console.log('‚ö†Ô∏è Audio not enabled yet, showing permission overlay');
                pendingAlarm = true;
                audioPermissionOverlay.classList.remove('hidden');
                return;
            }
            
            alarmPlayCount = 0;
            btnStopAlarm.classList.add('active'); // Show stop button
            playAlarmOnce();
        }

        function playAlarmOnce() {
            if (alarmPlayCount < maxAlarmRepeats) {
                emergencyAlarmAudio.currentTime = 0; // Reset to beginning
                emergencyAlarmAudio.play()
                    .then(() => {
                        console.log(`üîä Alarm playing (${alarmPlayCount + 1}/${maxAlarmRepeats})`);
                        alarmPlayCount++;
                    })
                    .catch(err => {
                        console.error('Error playing alarm:', err);
                        btnStopAlarm.classList.remove('active');
                        
                        // If autoplay blocked, show permission overlay
                        if (err.name === 'NotAllowedError') {
                            userHasInteracted = false;
                            pendingAlarm = true;
                            audioPermissionOverlay.classList.remove('hidden');
                        }
                    });
            }
        }

        emergencyAlarmAudio.addEventListener('ended', () => {
            if (alarmPlayCount < maxAlarmRepeats) {
                playAlarmOnce();
            } else {
                console.log(' Alarm completed (3x repeats)');
                btnStopAlarm.classList.remove('active'); // Hide stop button
            }
        });

        function stopEmergencyAlarm() {
            emergencyAlarmAudio.pause();
            emergencyAlarmAudio.currentTime = 0;
            alarmPlayCount = maxAlarmRepeats; // Prevent further repeats
            btnStopAlarm.classList.remove('active'); // Hide stop button
            console.log('‚èπ Alarm stopped manually');
        }

        socket.on('emergency-alert', (data) => {
            console.log(' New emergency received via WebSocket:', data);
            console.log(' Accident Type from WebSocket:', data.accidentType);
            
            loadCases();

            playEmergencyAlarm();

            if ('Notification' in window && Notification.permission === 'granted') {
                const typeNames = {
                    medical: 'MEDIS',
                    fire: 'KEBAKARAN',
                    crime: 'KRIMINAL',
                    accident: 'KECELAKAAN',
                    other: 'LAINNYA'
                };
                const typeName = typeNames[data.accidentType] || 'DARURAT';
                
                new Notification(` ${typeName} BARU!`, {
                    body: `Kasus emergency di SMK MARHAS Margahayu`,
                    icon: './img/logo.png'
                });
            }
        });

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        document.getElementById('filterStatus').addEventListener('change', loadCases);
        document.getElementById('filterType').addEventListener('change', loadCases);
        document.getElementById('filterDate').addEventListener('change', loadCases);

        loadCases();
        setInterval(loadCases, 30000); // Refresh every 30 seconds

        const chatToggle = document.getElementById('chatToggle');
        const chatPanel = document.getElementById('chatPanel');
        const chatClose = document.getElementById('chatClose');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        const chatBadge = document.getElementById('chatBadge');

        let unreadMessages = 0;
        let isChatOpen = false;

        chatToggle.addEventListener('click', () => {
            isChatOpen = !isChatOpen;
            chatPanel.classList.toggle('active');
            if (isChatOpen) {
                unreadMessages = 0;
                chatBadge.style.display = 'none';
                chatInput.focus();
            }
        });

        chatClose.addEventListener('click', () => {
            isChatOpen = false;
            chatPanel.classList.remove('active');
        });

        socket.emit('join-chat', {
            name: currentUser.name || currentUser.email || 'Emergency Responder',
            role: 'emergency'
        });

        socket.on('chat-history', (history) => {
            console.log(' Chat history received:', history);
            renderChatMessages(history);
        });

        socket.on('new-message', (message) => {
            console.log(' New message:', message);
            addChatMessage(message);
            
            if (!isChatOpen) {
                unreadMessages++;
                chatBadge.textContent = unreadMessages;
                chatBadge.style.display = 'flex';
            }
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            
            if (text) {
                socket.emit('send-message', { text });
                chatInput.value = '';
            }
        });

        function renderChatMessages(messages) {
            if (!messages || messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="chat-empty">
                        <i class="fas fa-comment-dots"></i>
                        <p>Belum ada pesan</p>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(msg => createChatMessageHTML(msg)).join('');
            scrollChatToBottom();
        }

        function addChatMessage(message) {
            const emptyState = chatMessages.querySelector('.chat-empty');
            if (emptyState) {
                emptyState.remove();
            }

            const messageHTML = createChatMessageHTML(message);
            chatMessages.insertAdjacentHTML('beforeend', messageHTML);
            scrollChatToBottom();
        }

        function createChatMessageHTML(message) {
            const isOwn = message.userName === (currentUser.name || currentUser.email || 'Emergency Responder');
            const time = new Date(message.timestamp).toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const roleIcon = message.userRole === 'emergency' ? '' : '';

            return `
                <div class="chat-message ${isOwn ? 'own' : 'other'}">
                    <div class="chat-message-header">
                        ${roleIcon} ${message.userName} ‚Ä¢ ${time}
                    </div>
                    <div class="chat-message-bubble">
                        ${escapeHtml(message.text)}
                    </div>
                </div>
            `;
        }

        function scrollChatToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const casesList = document.getElementById('casesList');
        let isDown = false;
        let startX;
        let scrollLeft;

        casesList.addEventListener('mousedown', (e) => {
            isDown = true;
            casesList.style.cursor = 'grabbing';
            startX = e.pageX - casesList.offsetLeft;
            scrollLeft = casesList.scrollLeft;
        });

        casesList.addEventListener('mouseleave', () => {
            isDown = false;
            casesList.style.cursor = 'grab';
        });

        casesList.addEventListener('mouseup', () => {
            isDown = false;
            casesList.style.cursor = 'grab';
        });

        casesList.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - casesList.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            casesList.scrollLeft = scrollLeft - walk;
        });

        console.log(' Emergency Dashboard with Chat initialized');
    </script>
</body>
</html>
