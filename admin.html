<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Emergency System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            color: #111827;
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .header-title p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .user-info {
            text-align: right;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-email {
            font-size: 14px;
            font-weight: 600;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.9;
        }

        .menu-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .sidebar-menu {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .sidebar-menu.active {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .sidebar-user {
            padding: 20px 24px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-user-email {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .sidebar-user-role {
            font-size: 12px;
            color: #6b7280;
        }

        .sidebar-menu-items {
            padding: 16px 0;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: #111827;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            background: #f9fafb;
            border-left-color: #dc2626;
        }

        .sidebar-menu-item i {
            width: 20px;
            text-align: center;
            color: #6b7280;
        }

        .sidebar-menu-item:hover i {
            color: #dc2626;
        }

        .sidebar-menu-item.logout {
            color: #dc2626;
            border-top: 1px solid #e5e7eb;
            margin-top: 8px;
        }

        .sidebar-menu-item.logout:hover {
            background: #fee2e2;
        }

        .sidebar-menu-item.logout i {
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .sidebar-menu {
                width: 100%;
                right: -100%;
            }

            .sidebar-menu.active {
                right: 0;
            }
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid #f3f4f6;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #fecaca;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }

        .stat-card.emergency {
            border-color: #fecaca;
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #fee2e2;
            color: #dc2626;
        }

        .stat-icon.secondary {
            background: #dbeafe;
            color: #2563eb;
        }

        .stat-icon.success {
            background: #d1fae5;
            color: #059669;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .stat-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-trend.up {
            color: #059669;
        }

        .stat-trend.down {
            color: #dc2626;
        }

        .filter-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid #f3f4f6;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-header h2 {
            font-size: 18px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-item label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .filter-item input,
        .filter-item select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-export {
            background: white;
            color: #059669;
            border: 2px solid #d1fae5;
        }

        .btn-export:hover {
            background: #d1fae5;
        }

        .table-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid #f3f4f6;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            font-size: 18px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .table-wrapper {
            overflow-x: auto;
            cursor: grab;
        }

        .table-wrapper:active {
            cursor: grabbing;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        th {
            padding: 14px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #fef2f2;
            cursor: pointer;
        }

        td {
            padding: 16px;
            font-size: 14px;
            color: #111827;
        }

        .scan-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scan-image:hover {
            transform: scale(1.1);
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .scan-image-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 24px;
            border: 2px solid #e5e7eb;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-emergency {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            animation: pulse 2s infinite;
        }

        .badge-normal {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-view {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-view:hover {
            background: #bfdbfe;
        }

        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-delete:hover {
            background: #fecaca;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
        }

        .pagination-info {
            font-size: 14px;
            color: #6b7280;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #dc2626;
            color: #dc2626;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
            margin: 20px;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #fecaca;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid #e5e7eb;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 16px;
            color: #111827;
            font-weight: 600;
        }

        .modal-logout {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal-logout.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-logout-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.7) translateY(30px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-logout-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            border: 4px solid #fca5a5;
        }

        .modal-logout-icon i {
            font-size: 36px;
            color: #dc2626;
        }

        .modal-logout-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }

        .modal-logout-text {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .modal-logout-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-logout-cancel,
        .btn-logout-confirm {
            flex: 1;
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .btn-logout-cancel {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-logout-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-logout-cancel:active {
            transform: translateY(0);
        }

        .btn-logout-confirm {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-logout-confirm:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            transform: translateY(-2px);
        }

        .btn-logout-confirm:active {
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            .modal-logout-content {
                padding: 24px;
            }

            .modal-logout-icon {
                width: 70px;
                height: 70px;
            }

            .modal-logout-icon i {
                font-size: 32px;
            }

            .modal-logout-title {
                font-size: 20px;
            }

            .modal-logout-buttons {
                flex-direction: column;
            }

            .btn-logout-cancel,
            .btn-logout-confirm {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #fee2e2;
            border-top-color: #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            color: #d1d5db;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: #9ca3af;
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                gap: 12px;
                align-items: center;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
                align-items: center;
                text-align: center;
                width: 100%;
            }

            .header-title {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .header-title h1 {
                font-size: 18px;
            }

            .header-title p {
                font-size: 12px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                width: 100%;
            }

            .table-wrapper {
                overflow-x: scroll;
            }

            table {
                min-width: 800px;
            }

            .pagination {
                flex-direction: column;
                gap: 16px;
            }
        }

        .alert-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .alert-popup-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-popup-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .alert-popup-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .alert-popup-icon.success {
            color: #4CAF50;
        }

        .alert-popup-icon.error {
            color: #f44336;
        }

        .alert-popup-icon.warning {
            color: #ff9800;
        }

        .alert-popup-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .alert-popup-message {
            font-size: 15px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .alert-popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    
    <div class="alert-popup-overlay" id="alertPopupOverlay">
        <div class="alert-popup-content">
            <div class="alert-popup-icon" id="alertPopupIcon"></div>
            <div class="alert-popup-title" id="alertPopupTitle"></div>
            <div class="alert-popup-message" id="alertPopupMessage"></div>
            <button class="alert-popup-btn" onclick="closeAlertPopup()">OK</button>
        </div>
    </div>

    <header class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <div class="header-title">
                    <h1>Admin Dashboard</h1>
                    <p>Emergency System Management</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfoToggle">
                    <div class="user-email" id="userEmail">Loading...</div>
                    <div class="user-role">Administrator</div>
                </div>
                <button class="menu-toggle" id="menuToggle" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button class="sidebar-close" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-user">
            <div class="sidebar-user-email" id="sidebarUserEmail">Loading...</div>
            <div class="sidebar-user-role">Administrator</div>
        </div>
        <div class="sidebar-menu-items">
            <a href="register-face.html" class="sidebar-menu-item">
                <i class="fas fa-user-plus"></i>
                <span>Registrasi Wajah</span>
            </a>
            <a href="view-registered-faces.html" class="sidebar-menu-item">
                <i class="fas fa-users"></i>
                <span>Daftar Wajah</span>
            </a>
            <a href="analytics.html" class="sidebar-menu-item">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <button class="sidebar-menu-item logout" id="sidebarLogoutBtn" style="width: 100%; border: none; background: none; cursor: pointer; text-align: left;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="admin-container">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="statTotalToday">0</div>
                        <div class="stat-label">Scans Hari Ini</div>
                    </div>
                    <div class="stat-icon success">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                </div>
                <div class="stat-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span id="trendToday">0%</span>
                </div>
            </div>

            <div class="stat-card emergency">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="statEmergency">0</div>
                        <div class="stat-label">Emergency Bulan Ini</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                </div>
                <div class="stat-trend down">
                    <i class="fas fa-arrow-down"></i>
                    <span id="trendEmergency">0%</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="statTotalMonth">0</div>
                        <div class="stat-label">Total Scan Bulan Ini</div>
                    </div>
                    <div class="stat-icon secondary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span id="trendMonth">0%</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="statTotalAll">0</div>
                        <div class="stat-label">Total Semua Scan</div>
                    </div>
                    <div class="stat-icon secondary">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-header">
                <h2>
                    <i class="fas fa-filter"></i>
                    Filter Data
                </h2>
            </div>
            <div class="filter-grid">
                <div class="filter-item">
                    <label for="filterYear">Tahun</label>
                    <select id="filterYear">
                        <option value="">Semua Tahun</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="filterMonth">Bulan</label>
                    <select id="filterMonth">
                        <option value="">Semua Bulan</option>
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="filterDateFrom">Tanggal Dari</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="filter-item">
                    <label for="filterDateTo">Tanggal Sampai</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="filter-item">
                    <label for="filterStatus">Status</label>
                    <select id="filterStatus">
                        <option value="">Semua</option>
                        <option value="emergency">Emergency Only</option>
                        <option value="normal">Normal Only</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFilterBtn">
                    <i class="fas fa-check"></i>
                    Terapkan Filter
                </button>
                <button class="btn btn-secondary" id="resetFilterBtn">
                    <i class="fas fa-undo"></i>
                    Reset
                </button>
                <button class="btn btn-export" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Export CSV
                </button>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-table"></i>
                    Data Scan Wajah
                </h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Cari scan ID...">
                </div>
            </div>

            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p>Memuat data...</p>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3>Tidak Ada Data</h3>
                <p>Belum ada data scan wajah yang tersedia</p>
            </div>

            <div id="tableContainer" style="display: none;">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Scan ID</th>
                                <th>Tanggal & Waktu</th>
                                <th>Suhu Tubuh</th>
                                <th>Status</th>
                                <th>Emergency Time</th>
                                <th>Telegram</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <div class="pagination-info" id="paginationInfo">
                        Showing 1-10 of 100
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="prevPageBtn">
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                        <button class="pagination-btn active" id="currentPageBtn">1</button>
                        <button class="pagination-btn" id="nextPageBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-info-circle"></i>
                    Detail Scan
                </h3>
                <button class="modal-close" id="closeModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                
            </div>
        </div>
    </div>

    <div class="modal-logout" id="logoutModal">
        <div class="modal-logout-content">
            <div class="modal-logout-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3 class="modal-logout-title">Konfirmasi Logout</h3>
            <p class="modal-logout-text">Apakah Anda yakin ingin keluar dari akun admin?</p>
            <div class="modal-logout-buttons">
                <button class="btn-logout-cancel" id="cancelLogoutBtn">
                    <i class="fas fa-times"></i>
                    Batal
                </button>
                <button class="btn-logout-confirm" id="confirmLogoutBtn">
                    <i class="fas fa-check"></i>
                    Ya, Logout
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>

        const SUPABASE_URL = 'https://fvayuhanwcwinkvvvisk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2YXl1aGFud2N3aW5rdnZ2aXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDk1NTYsImV4cCI6MjA3NTQ4NTU1Nn0.AP0ZYsrUQ1ACD7fmX1wTM88_zzMtvyKXmgc9wCVvRrM';
        const STORAGE_BUCKET = 'faces'; // Nama bucket storage untuk foto

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentPage = 1;
        let itemsPerPage = 10;
        let totalData = 0;
        let allScans = [];
        let filteredScans = [];
        let currentUser = null;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {

                window.location.href = 'login-admin.html';
                return;
            }

            currentUser = session.user;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;

            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') {
                    window.location.href = 'login-admin.html';
                }
            });

            await loadAllData();
        }

        checkAuth();

        const menuToggle = document.getElementById('menuToggle');
        const userInfoToggle = document.getElementById('userInfoToggle');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');

        function openSidebar() {
            sidebarMenu.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebarMenu.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', openSidebar);
        }
        if (userInfoToggle) {
            userInfoToggle.addEventListener('click', openSidebar);
        }
        if (sidebarClose) {
            sidebarClose.addEventListener('click', closeSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        document.querySelectorAll('.sidebar-menu-item:not(.logout)').forEach(item => {
            item.addEventListener('click', () => {
                setTimeout(closeSidebar, 100);
            });
        });

        const logoutModal = document.getElementById('logoutModal');
        const logoutBtn = document.getElementById('logoutBtn');
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');

        function showLogoutModal() {
            logoutModal.classList.add('active');
            closeSidebar();
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', showLogoutModal);
        }
        if (sidebarLogoutBtn) {
            sidebarLogoutBtn.addEventListener('click', showLogoutModal);
        }

        cancelLogoutBtn.addEventListener('click', () => {
            logoutModal.classList.remove('active');
        });

        logoutModal.addEventListener('click', (e) => {
            if (e.target === logoutModal) {
                logoutModal.classList.remove('active');
            }
        });

        confirmLogoutBtn.addEventListener('click', async () => {

            logoutModal.classList.remove('active');

            confirmLogoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
            confirmLogoutBtn.disabled = true;

            await supabase.auth.signOut();

            localStorage.clear();
            sessionStorage.clear();

            window.location.href = 'login-admin.html';
        });

        window.addEventListener('beforeunload', async (e) => {

            await supabase.auth.signOut();
            localStorage.clear();
            sessionStorage.clear();
        });

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'hidden') {

                sessionStorage.setItem('lastActiveTime', Date.now());
            } else if (document.visibilityState === 'visible') {

                const lastActive = sessionStorage.getItem('lastActiveTime');
                if (lastActive) {
                    const inactiveTime = Date.now() - parseInt(lastActive);
                    const THIRTY_MINUTES = 30 * 60 * 1000;
                    
                    if (inactiveTime > THIRTY_MINUTES) {

                        await supabase.auth.signOut();
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'login-admin.html';
                    }
                }
            }
        });

        async function loadAllData() {
            try {
                showLoading(true);

                const { data: scansData, error: scansError } = await supabase
                    .from('face_scans')
                    .select('*')
                    .order('scantime', { ascending: false });

                if (scansError) {

                }

                const { data: alertsData, error: alertsError } = await supabase
                    .from('emergency_alerts')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (alertsError) {

                }

                const normalScans = (scansData || []).map(scan => ({
                    scanid: scan.scanid,
                    scantime: scan.scantime,
                    scanphoto: scan.scanphoto || scan.imagepath,
                    imagepath: scan.imagepath || scan.scanphoto,
                    isemergency: scan.isemergency || false,
                    emergencytime: scan.emergencytime || null,
                    telegramsent: scan.telegramsent || false,
                    year: scan.year,
                    month: scan.month,
                    date: scan.date,
                    body_temperature: scan.body_temperature || null,
                    dataSource: 'face_scans',
                    accidentType: null,
                    userName: null
                }));

                const emergencyScans = (alertsData || []).map(alert => {
                    const timestamp = alert.timestamp || alert.created_at;
                    const scanDate = new Date(timestamp);

                    let photoPath = alert.scan_photo || alert.user_photo;
                    if (photoPath && photoPath.includes('/storage/v1/object/public/faces/')) {

                        photoPath = photoPath.split('/storage/v1/object/public/faces/')[1];
                    }
                    
                    return {
                        scanid: alert.scan_id || alert.alert_id,
                        scantime: timestamp,
                        scanphoto: photoPath,
                        imagepath: photoPath, // Add imagepath for compatibility
                        isemergency: true, // Always true for emergency_alerts
                        emergencytime: timestamp,
                        telegramsent: alert.telegram_sent || false,
                        year: scanDate.getFullYear(),
                        month: scanDate.getMonth() + 1,
                        date: scanDate.getDate(),
                        body_temperature: null,
                        dataSource: 'emergency_alerts',
                        accidentType: alert.accident_type || 'other',
                        userName: alert.user_name || 'Anonymous',
                        status: alert.status || 'active',
                        emergencyButtonPressed: alert.emergency_button_pressed || false
                    };
                });

                allScans = [...normalScans, ...emergencyScans].sort((a, b) => {
                    return new Date(b.scantime) - new Date(a.scantime);
                });

                filteredScans = [...allScans];
                totalData = allScans.length;

                updateStatistics();

                populateYearFilter();

                renderTable();

                showLoading(false);

            } catch (error) {
                showLoading(false);
                showAlertPopup(' Error', 'Gagal memuat data: ' + error.message, 'error');
            }
        }

        function showAlertPopup(title, message, type = 'success') {
            const overlay = document.getElementById('alertPopupOverlay');
            const icon = document.getElementById('alertPopupIcon');
            const titleEl = document.getElementById('alertPopupTitle');
            const messageEl = document.getElementById('alertPopupMessage');

            const icons = {
                success: '',
                error: '',
                warning: ''
            };

            icon.textContent = icons[type] || icons.success;
            icon.className = `alert-popup-icon ${type}`;
            titleEl.textContent = title;
            messageEl.textContent = message;

            overlay.classList.add('active');
        }

        function closeAlertPopup() {
            const overlay = document.getElementById('alertPopupOverlay');
            overlay.classList.remove('active');
        }

        function updateStatistics() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const totalToday = allScans.filter(scan => {
                const scanDate = new Date(scan.scantime);
                return scanDate >= today;
            }).length;

            const emergencyMonth = allScans.filter(scan => {
                const scanDate = new Date(scan.scantime);
                return scanDate >= thisMonth && scan.isemergency === true;
            }).length;

            const totalMonth = allScans.filter(scan => {
                const scanDate = new Date(scan.scantime);
                return scanDate >= thisMonth;
            }).length;

            document.getElementById('statTotalToday').textContent = totalToday;
            document.getElementById('statEmergency').textContent = emergencyMonth;
            document.getElementById('statTotalMonth').textContent = totalMonth;
            document.getElementById('statTotalAll').textContent = allScans.length;

            document.getElementById('trendToday').textContent = '+12%';
            document.getElementById('trendEmergency').textContent = '-8%';
            document.getElementById('trendMonth').textContent = '+15%';
        }

        function populateYearFilter() {
            const years = [...new Set(allScans.map(scan => scan.year))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('filterYear');
            
            yearSelect.innerHTML = '<option value="">Semua Tahun</option>';
            years.forEach(year => {
                if (year) {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                }
            });
        }

        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const status = document.getElementById('filterStatus').value;

            filteredScans = allScans.filter(scan => {

                if (year && scan.year != year) return false;

                if (month && scan.month != month) return false;

                if (dateFrom) {
                    const scanDate = new Date(scan.scantime);
                    const fromDate = new Date(dateFrom);
                    if (scanDate < fromDate) return false;
                }

                if (dateTo) {
                    const scanDate = new Date(scan.scantime);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (scanDate > toDate) return false;
                }

                if (status === 'emergency' && !scan.isemergency) return false;
                if (status === 'normal' && scan.isemergency) return false;

                return true;
            });

            currentPage = 1;
            renderTable();
        });

        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById('filterYear').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchInput').value = '';

            filteredScans = [...allScans];
            currentPage = 1;
            renderTable();
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();

            if (searchTerm === '') {
                filteredScans = [...allScans];
            } else {
                filteredScans = allScans.filter(scan => 
                    scan.scanid.toLowerCase().includes(searchTerm) ||
                    (scan.usernote && scan.usernote.toLowerCase().includes(searchTerm))
                );
            }

            currentPage = 1;
            renderTable();
        });

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredScans.slice(startIndex, endIndex);

            if (filteredScans.length === 0) {
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            tbody.innerHTML = '';

            pageData.forEach(scan => {

                const imagePath = scan.scanphoto || scan.imagepath;

                let emergencyBadge = '';
                if (scan.isemergency) {
                    const typeIcons = {
                        medical: '',
                        fire: '',
                        crime: '',
                        accident: '',
                        other: ''
                    };
                    const typeNames = {
                        medical: 'MEDIS',
                        fire: 'KEBAKARAN',
                        crime: 'KRIMINAL',
                        accident: 'KECELAKAAN',
                        other: 'LAINNYA'
                    };
                    const icon = scan.accidentType ? typeIcons[scan.accidentType] || '' : '';
                    const typeName = scan.accidentType ? typeNames[scan.accidentType] || '' : '';
                    emergencyBadge = `<span class="badge badge-emergency">
                        <i class="fas fa-bell"></i> EMERGENCY ${typeName ? '- ' + icon + ' ' + typeName : ''}
                    </span>`;
                } else {
                    emergencyBadge = `<span class="badge badge-normal">
                        <i class="fas fa-check"></i> Normal
                    </span>`;
                }

                let tempDisplay = '-';
                if (scan.body_temperature) {
                    const temp = parseFloat(scan.body_temperature);
                    if (temp < 37.3) {
                        tempDisplay = `<span class="badge badge-normal">${temp}C</span>`;
                    } else if (temp < 37.6) {
                        tempDisplay = `<span class="badge" style="background: #fef3c7; color: #92400e; border: 1px solid #fde68a;">${temp}C</span>`;
                    } else {
                        tempDisplay = `<span class="badge badge-emergency">${temp}C</span>`;
                    }
                } else {
                    tempDisplay = '<span style="color: #9ca3af; font-size: 13px;">-</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${getImageHTML(imagePath, scan.scanid)}
                    </td>
                    <td>
                        <strong>${scan.scanid}</strong>
                        ${scan.userName ? '<br><small style="color: #6b7280;">' + scan.userName + '</small>' : ''}
                        ${scan.dataSource === 'emergency_alerts' ? '<br><span style="font-size: 11px; color: #dc2626; font-weight: 600;"> EMERGENCY ALERT</span>' : ''}
                    </td>
                    <td>${formatDateTime(scan.scantime)}</td>
                    <td>${tempDisplay}</td>
                    <td>${emergencyBadge}</td>
                    <td>${scan.emergencytime ? formatDateTime(scan.emergencytime) : '-'}</td>
                    <td>
                        ${scan.telegramsent || scan.telegrammessagesent ? '<i class="fas fa-check-circle" style="color: #059669;"></i> Sent' : '<i class="fas fa-times-circle" style="color: #9ca3af;"></i> Not sent'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="viewDetail('${scan.scanid}', '${scan.dataSource}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteRecord('${scan.scanid}', '${scan.dataSource}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        function getImageHTML(imagePath, scanId) {
            if (!imagePath) {
                return `<div class="scan-image-placeholder"><i class="fas fa-user"></i></div>`;
            }

            if (imagePath.startsWith('data:image')) {
                return `<img src="${imagePath}" alt="${scanId}" class="scan-image" onclick="viewImageModal('${imagePath}')">`;
            }

            if (imagePath.startsWith('http')) {
                return `<img src="${imagePath}" alt="${scanId}" class="scan-image" onclick="viewImageModal('${imagePath}')" crossorigin="anonymous">`;
            }

            const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(imagePath);
            
            if (data && data.publicUrl) {
                return `<img src="${data.publicUrl}" alt="${scanId}" class="scan-image" onclick="viewImageModal('${data.publicUrl}')" crossorigin="anonymous">`;
            } else {
                return `<div class="scan-image-placeholder"><i class="fas fa-image"></i></div>`;
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            
            return date.toLocaleDateString('id-ID', options);
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredScans.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredScans.length);

            document.getElementById('paginationInfo').textContent = 
                `Showing ${start}-${end} of ${filteredScans.length}`;
            
            document.getElementById('currentPageBtn').textContent = currentPage;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredScans.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        function viewDetail(scanId, dataSource) {
            const scan = allScans.find(s => s.scanid === scanId);
            if (!scan) return;

            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');

            let imageHTML = '';
            const imagePath = scan.scanphoto || scan.imagepath;
            if (imagePath) {
                if (imagePath.startsWith('data:image')) {

                    imageHTML = `<img src="${imagePath}" alt="${scan.scanid}" class="modal-image">`;
                } else {

                    const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(imagePath);
                    if (data && data.publicUrl) {
                        imageHTML = `<img src="${data.publicUrl}" alt="${scan.scanid}" class="modal-image">`;
                    }
                }
            }

            const typeNames = {
                medical: ' MEDIS',
                fire: ' KEBAKARAN',
                crime: ' KRIMINAL',
                accident: ' KECELAKAAN',
                other: ' LAINNYA'
            };
            const accidentTypeName = scan.accidentType ? typeNames[scan.accidentType] || scan.accidentType : '-';

            let tempDetail = '-';
            if (scan.body_temperature) {
                const temp = parseFloat(scan.body_temperature);
                let tempStatus = '';
                let tempBadge = '';
                
                if (temp < 37.3) {
                    tempStatus = 'Normal';
                    tempBadge = `<span class="badge badge-normal">${temp}C - ${tempStatus}</span>`;
                } else if (temp < 37.6) {
                    tempStatus = 'Hangat';
                    tempBadge = `<span class="badge" style="background: #fef3c7; color: #92400e; border: 1px solid #fde68a;">${temp}C - ${tempStatus}</span>`;
                } else {
                    tempStatus = 'Demam';
                    tempBadge = `<span class="badge badge-emergency">${temp}C - ${tempStatus}</span>`;
                }
                tempDetail = tempBadge;
            }

            modalBody.innerHTML = `
                ${imageHTML}
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Scan ID / Alert ID</div>
                        <div class="detail-value">${scan.scanid}</div>
                    </div>
                    ${scan.userName ? `
                    <div class="detail-item">
                        <div class="detail-label">Nama User</div>
                        <div class="detail-value">${scan.userName}</div>
                    </div>
                    ` : ''}
                    <div class="detail-item">
                        <div class="detail-label">Data Source</div>
                        <div class="detail-value">
                            <span style="background: ${scan.dataSource === 'emergency_alerts' ? '#fee2e2' : '#dbeafe'}; color: ${scan.dataSource === 'emergency_alerts' ? '#991b1b' : '#1e40af'}; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                ${scan.dataSource === 'emergency_alerts' ? ' EMERGENCY ALERT' : ' FACE SCAN'}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Waktu ${scan.dataSource === 'emergency_alerts' ? 'Emergency' : 'Scan'}</div>
                        <div class="detail-value">${formatDateTime(scan.scantime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Suhu Tubuh</div>
                        <div class="detail-value">${tempDetail}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tahun</div>
                        <div class="detail-value">${scan.year || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bulan</div>
                        <div class="detail-value">${scan.month ? getMonthName(scan.month) : '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tanggal</div>
                        <div class="detail-value">${scan.date || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status Emergency</div>
                        <div class="detail-value">
                            <span class="badge ${scan.isemergency ? 'badge-emergency' : 'badge-normal'}">
                                ${scan.isemergency ? 'EMERGENCY' : 'Normal'}
                            </span>
                        </div>
                    </div>
                    ${scan.accidentType ? `
                    <div class="detail-item">
                        <div class="detail-label">Jenis Emergency</div>
                        <div class="detail-value">${accidentTypeName}</div>
                    </div>
                    ` : ''}
                    ${scan.emergencyButtonPressed ? `
                    <div class="detail-item">
                        <div class="detail-label">Emergency Button</div>
                        <div class="detail-value" style="color: #dc2626; font-weight: 700;"> PRESSED</div>
                    </div>
                    ` : ''}
                    ${scan.emergencytime ? `
                    <div class="detail-item">
                        <div class="detail-label">Waktu Emergency</div>
                        <div class="detail-value">${formatDateTime(scan.emergencytime)}</div>
                    </div>
                    ` : ''}
                    <div class="detail-item">
                        <div class="detail-label">Telegram Notification</div>
                        <div class="detail-value">${scan.telegramsent || scan.telegrammessagesent ? ' Terkirim' : ' Belum terkirim'}</div>
                    </div>
                    ${scan.status ? `
                    <div class="detail-item">
                        <div class="detail-label">Status Penanganan</div>
                        <div class="detail-value">
                            <span style="background: ${scan.status === 'handled' ? '#d1fae5' : '#fee2e2'}; color: ${scan.status === 'handled' ? '#065f46' : '#991b1b'}; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                ${scan.status === 'handled' ? ' HANDLED' : ' ACTIVE'}
                            </span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');
        }

        function getMonthName(month) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return months[month - 1] || '-';
        }

        function viewImageModal(imageUrl) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `<img src="${imageUrl}" class="modal-image" style="max-height: 80vh;">`;
            modal.classList.add('active');
        }

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('detailModal').classList.remove('active');
        });

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                document.getElementById('detailModal').classList.remove('active');
            }
        });

        async function deleteRecord(scanId, dataSource) {

            const confirmOverlay = document.createElement('div');
            confirmOverlay.className = 'alert-popup-overlay active';
            confirmOverlay.innerHTML = `
                <div class="alert-popup-content">
                    <div class="alert-popup-icon warning"></div>
                    <div class="alert-popup-title">Konfirmasi Hapus</div>
                    <div class="alert-popup-message">Yakin ingin menghapus data "${scanId}"?<br><br>Peringatan: Ini akan menghapus data permanen!</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="alert-popup-btn" style="background: linear-gradient(135deg, #f44336 0%, #da190b 100%);" onclick="confirmDelete('${scanId}', '${dataSource}', this)">Ya, Hapus</button>
                        <button class="alert-popup-btn" style="background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);" onclick="cancelDelete(this)">Batal</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmOverlay);
        }

        async function confirmDelete(scanId, dataSource, btnElement) {
            const confirmOverlay = btnElement.closest('.alert-popup-overlay');
            confirmOverlay.remove();

            try {
                let error;

                if (dataSource === 'emergency_alerts') {
                    const { error: alertError } = await supabase
                        .from('emergency_alerts')
                        .delete()
                        .or(`scan_id.eq.${scanId},alert_id.eq.${scanId}`);
                    error = alertError;
                } else {
                    const { error: scanError } = await supabase
                        .from('face_scans')
                        .delete()
                        .eq('scanid', scanId);
                    error = scanError;
                }

                if (error) throw error;

                showAlertPopup(' Berhasil', 'Data berhasil dihapus!', 'success');
                await loadAllData(); // Reload data

            } catch (error) {
                showAlertPopup(' Error', 'Gagal menghapus data: ' + error.message, 'error');
            }
        }

        function cancelDelete(btnElement) {
            const confirmOverlay = btnElement.closest('.alert-popup-overlay');
            confirmOverlay.remove();
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (filteredScans.length === 0) {
                showAlertPopup(' Peringatan', 'Tidak ada data untuk di-export', 'warning');
                return;
            }

            const headers = ['Scan ID', 'Waktu Scan', 'Suhu Tubuh (C)', 'Status Suhu', 'Tahun', 'Bulan', 'Tanggal', 'Status Emergency', 'Waktu Emergency', 'Telegram Sent', 'Telegram Message ID', 'Image Path', 'Catatan'];

            const rows = filteredScans.map(scan => {
                let tempStatus = '-';
                if (scan.body_temperature) {
                    const temp = parseFloat(scan.body_temperature);
                    if (temp < 37.3) tempStatus = 'Normal';
                    else if (temp < 37.6) tempStatus = 'Hangat';
                    else tempStatus = 'Demam';
                }
                
                return [
                    scan.scanid,
                    formatDateTime(scan.scantime),
                    scan.body_temperature || '-',
                    tempStatus,
                    scan.year || '',
                    scan.month || '',
                    scan.day || '',
                    scan.isemergency ? 'EMERGENCY' : 'Normal',
                    scan.emergencytimestamp ? formatDateTime(scan.emergencytimestamp) : '',
                    scan.telegrammessagesent ? 'Yes' : 'No',
                    scan.telegrammessageid || '',
                    scan.imagepath || '',
                    scan.usernote || ''
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `face_scans_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('tableContainer').style.display = show ? 'none' : 'block';
        }

        const tableWrapper = document.querySelector('.table-wrapper');
        let isDown = false;
        let startX;
        let scrollLeft;

        tableWrapper.addEventListener('mousedown', (e) => {
            isDown = true;
            tableWrapper.style.cursor = 'grabbing';
            startX = e.pageX - tableWrapper.offsetLeft;
            scrollLeft = tableWrapper.scrollLeft;
        });

        tableWrapper.addEventListener('mouseleave', () => {
            isDown = false;
            tableWrapper.style.cursor = 'grab';
        });

        tableWrapper.addEventListener('mouseup', () => {
            isDown = false;
            tableWrapper.style.cursor = 'grab';
        });

        tableWrapper.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - tableWrapper.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            tableWrapper.scrollLeft = scrollLeft - walk;
        });
    </script>
</body>
</html>
