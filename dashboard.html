<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dashboard - Emergency Hotline System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            color: #1a1a1a;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dashboard-main {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100vw;
        }

        .voice-assistant-wrapper {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 14px;
            z-index: 250;
        }

        .voice-assistant-status {
            max-width: 300px;
            background: rgba(59, 130, 246, 0.92);
            color: #fff;
            padding: 14px 16px;
            border-radius: 14px;
            font-size: 14px;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.35);
            display: none;
            backdrop-filter: blur(6px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 245;
        }

        .voice-assistant-status.highlight {
            background: rgba(239, 68, 68, 0.96);
            box-shadow: 0 16px 36px rgba(239, 68, 68, 0.45);
        }

        .voice-assistant-status.minimized {
            max-width: 200px;
            padding: 10px 14px;
        }

        .voice-assistant-status.minimized strong {
            margin-bottom: 0;
        }

        .voice-assistant-status.minimized p {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-top: 0;
        }

        .voice-assistant-status strong {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.85;
            margin-bottom: 6px;
            transition: margin-bottom 0.3s ease;
        }

        .voice-assistant-status-toggle {
            font-size: 16px;
            opacity: 0.7;
            transition: transform 0.3s ease, opacity 0.2s ease;
        }

        .voice-assistant-status:hover .voice-assistant-status-toggle {
            opacity: 1;
        }

        .voice-assistant-status.minimized .voice-assistant-status-toggle {
            transform: rotate(180deg);
        }

        .voice-assistant-status p {
            margin: 0;
            line-height: 1.4;
            font-weight: 500;
            max-height: 300px;
            opacity: 1;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            padding-right: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .voice-assistant-status p::-webkit-scrollbar {
            width: 6px;
        }

        .voice-assistant-status p::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .voice-assistant-status p::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .voice-assistant-status p::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .voice-assistant-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 18px 30px rgba(37, 99, 235, 0.35);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .voice-assistant-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 22px 38px rgba(37, 99, 235, 0.45);
        }

        .voice-assistant-button:active {
            transform: scale(0.96);
        }

        .voice-assistant-button .fa-microphone {
            font-size: 24px;
        }

        .voice-assistant-button.listening {
            animation: pulseGlow 1.2s infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 18px 30px rgba(239, 68, 68, 0.4);
        }

        .voice-assistant-button.disabled {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 18px 30px rgba(239, 68, 68, 0.3);
            }

            50% {
                transform: scale(1.08);
                box-shadow: 0 24px 42px rgba(239, 68, 68, 0.5);
            }
        }

        @media (max-width: 640px) {
            .voice-assistant-wrapper {
                right: 16px;
                bottom: 18px;
            }

            .voice-assistant-button {
                width: 56px;
                height: 56px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 20px;
            }

            .voice-assistant-status {
                max-width: 200px;
                font-size: 12px;
                padding: 10px 12px;
            }

            .voice-assistant-status strong {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .voice-assistant-status p {
                font-size: 11px;
                line-height: 1.3;
                max-height: 200px;
                overflow-y: auto;
            }
        }

        .voice-assistant-tooltip {
            position: absolute;
            bottom: 88px;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.45;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.32);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            max-width: 260px;
            z-index: 255;
        }

        .voice-assistant-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .voice-assistant-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 18px;
            border-width: 8px;
            border-style: solid;
            border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
        }

        .voice-assistant-tooltip i {
            margin-top: 2px;
            color: #38bdf8;
        }

        .voice-tooltip-close {
            margin-left: auto;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.65);
            cursor: pointer;
            padding: 0;
            font-size: 12px;
            transition: color 0.2s ease;
        }

        .voice-tooltip-close:hover {
            color: #fff;
        }

        @media (max-width: 640px) {
            .voice-assistant-tooltip {
                max-width: 180px;
                font-size: 11px;
                padding: 8px 10px;
                bottom: 70px;
                gap: 6px;
            }

            .voice-assistant-tooltip::after {
                right: 14px;
                border-width: 6px;
            }
        }

        @media (max-width: 480px) {
            .voice-assistant-tooltip {
                max-width: 160px;
                font-size: 10px;
                padding: 6px 8px;
                bottom: 64px;
            }
        }

        @media (max-width: 400px) {
            .voice-assistant-tooltip {
                max-width: 140px;
                font-size: 9px;
                bottom: 60px;
            }
        }

        .voice-assistant-popover {
            position: absolute;
            bottom: 96px;
            right: 0;
            width: 320px;
            max-height: 420px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 22px 48px rgba(15, 23, 42, 0.25);
            padding: 18px;
            display: none;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(226, 232, 240, 0.7);
            z-index: 260;
        }

        .voice-assistant-popover.open {
            display: flex;
        }

        .voice-popover-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }

        .voice-popover-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
        }

        .voice-popover-header p {
            margin: 6px 0 0;
            font-size: 13px;
            color: #475569;
            line-height: 1.45;
        }

        .voice-popover-close {
            margin-left: auto;
            background: rgba(15, 23, 42, 0.05);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .voice-popover-close:hover {
            background: rgba(15, 23, 42, 0.12);
            color: #111827;
        }

        .voice-conversation-log {
            flex: 1;
            min-height: 160px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .voice-conversation-log::-webkit-scrollbar {
            width: 6px;
        }

        .voice-conversation-log::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 6px;
        }

        .voice-conversation-entry {
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(226, 232, 240, 0.7);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-conversation-entry .voice-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #2563eb;
            display: block;
            margin-bottom: 4px;
        }

        .voice-conversation-answer .voice-label {
            color: #0f172a;
        }

        .voice-conversation-entry p {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            color: #1e293b;
        }

        .voice-conversation-placeholder {
            background: rgba(59, 130, 246, 0.08);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            color: #1d4ed8;
            font-size: 13px;
            border: 1px dashed rgba(37, 99, 235, 0.4);
        }

        .voice-conversation-placeholder i {
            display: block;
            font-size: 20px;
            margin-bottom: 6px;
        }

        .voice-bubbles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 16px;
            z-index: 1;
            pointer-events: none;
        }

        .voice-bubble {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            filter: blur(2px);
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            will-change: transform, opacity;
        }

        @keyframes floatUp1 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            25% {
                transform: translate(15px, -25px) scale(1.1);
                opacity: 0.5;
            }

            50% {
                transform: translate(-10px, -50px) scale(0.9);
                opacity: 0.4;
            }

            75% {
                transform: translate(20px, -75px) scale(1.05);
                opacity: 0.35;
            }
        }

        @keyframes floatUp2 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.35;
            }

            30% {
                transform: translate(-20px, -30px) scale(0.95);
                opacity: 0.5;
            }

            60% {
                transform: translate(10px, -60px) scale(1.08);
                opacity: 0.4;
            }

            90% {
                transform: translate(-15px, -90px) scale(1);
                opacity: 0.3;
            }
        }

        @keyframes floatDiagonal1 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 0.4;
            }

            33% {
                transform: translate(25px, -20px) rotate(120deg) scale(1.1);
                opacity: 0.5;
            }

            66% {
                transform: translate(50px, -40px) rotate(240deg) scale(0.95);
                opacity: 0.45;
            }
        }

        @keyframes floatDiagonal2 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 0.35;
            }

            40% {
                transform: translate(-30px, -25px) rotate(-140deg) scale(1.05);
                opacity: 0.5;
            }

            80% {
                transform: translate(-60px, -50px) rotate(-280deg) scale(0.9);
                opacity: 0.4;
            }
        }

        @keyframes floatCircular {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            25% {
                transform: translate(20px, -15px) scale(1.08);
                opacity: 0.45;
            }

            50% {
                transform: translate(0, -30px) scale(0.95);
                opacity: 0.5;
            }

            75% {
                transform: translate(-20px, -15px) scale(1.05);
                opacity: 0.4;
            }

            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
        }

        @keyframes floatWave {

            0%,
            100% {
                transform: translateX(0) translateY(0) scale(1);
                opacity: 0.4;
            }

            25% {
                transform: translateX(15px) translateY(-20px) scale(1.1);
                opacity: 0.5;
            }

            50% {
                transform: translateX(0) translateY(-40px) scale(0.9);
                opacity: 0.45;
            }

            75% {
                transform: translateX(-15px) translateY(-20px) scale(1.05);
                opacity: 0.4;
            }
        }

        .voice-popover-header,
        .voice-conversation-log {
            position: relative;
            z-index: 10;
        }

        @media (max-width: 640px) {
            .voice-assistant-popover {
                width: calc(100vw - 32px);
                right: 16px;
                bottom: 92px;
            }

            .voice-assistant-tooltip {
                max-width: 220px;
            }
        }

        @media (max-width: 480px) {
            .voice-assistant-wrapper {
                right: 12px;
                bottom: 12px;
            }

            .voice-assistant-button {
                width: 52px;
                height: 52px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 18px;
            }

            .voice-assistant-status {
                max-width: 170px;
                font-size: 11px;
                padding: 8px 10px;
            }

            .voice-assistant-status strong {
                font-size: 10px;
                margin-bottom: 3px;
            }

            .voice-assistant-status p {
                font-size: 10px;
                line-height: 1.25;
                max-height: 180px;
                overflow-y: auto;
            }

            .voice-assistant-status.minimized {
                max-width: 140px;
                padding: 6px 8px;
            }

            .voice-assistant-status-toggle {
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            .voice-assistant-wrapper {
                right: 10px;
                bottom: 10px;
            }

            .voice-assistant-button {
                width: 48px;
                height: 48px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 16px;
            }

            .voice-assistant-status {
                max-width: 150px;
                font-size: 10px;
                padding: 7px 9px;
            }

            .voice-assistant-status strong {
                font-size: 9px;
            }

            .voice-assistant-status p {
                font-size: 9px;
                max-height: 150px;
                overflow-y: auto;
            }

            .voice-assistant-status.minimized {
                max-width: 120px;
                padding: 5px 7px;
            }
        }

        .app-header {
            width: 100%;
            background: #3b82f6;
            padding: 48px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .app-brand-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 14px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            max-width: 90%;
        }

        .app-logo {
            height: 56px;
            width: auto;
            object-fit: contain;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.025em;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-section h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .welcome-section p {
            font-size: 16px;
            color: #6b7280;
            font-weight: 400;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 500px;
            align-items: center;
            justify-content: center;
        }

        .red-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 40px;
            background: #dc2626;
            color: white;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            letter-spacing: -0.025em;
            width: 100%;
        }

        .red-btn::before {
            display: none;
        }

        .red-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .red-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .red-btn i {
            margin-right: 12px;
            font-size: 22px;
        }

        .emergency-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 32px;
            background: #3b82f6;
            color: white;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            letter-spacing: -0.025em;
            width: 100%;
        }

        .emergency-btn::before {
            display: none;
        }

        .emergency-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .emergency-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .emergency-btn i {
            margin-right: 8px;
            font-size: 18px;
        }

        .emergency-btn-service {
            background: #10b981 !important;
        }

        .emergency-btn-service:hover {
            background: #059669 !important;
        }

        .shortcut-hint {
            margin-left: 8px;
            font-size: 11px;
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .shortcut-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .shortcut-popup {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shortcut-popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .shortcut-popup-header i {
            font-size: 24px;
            color: #3b82f6;
        }

        .shortcut-popup-header h3 {
            flex: 1;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .shortcut-popup-close {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .shortcut-popup-close:hover {
            color: #1f2937;
        }

        .shortcut-popup-content {
            padding: 20px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .shortcut-item:hover {
            background: #f3f4f6;
        }

        .shortcut-item:last-child {
            margin-bottom: 0;
        }

        .shortcut-key {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }

        .shortcut-desc {
            flex: 1;
            font-size: 15px;
            color: #374151;
        }

        .ai-voice-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeIn 0.3s ease;
            padding: 20px;
            overflow: hidden;
        }

        .ai-voice-popup-overlay::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            animation: bubbleFloat 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes bubbleFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            33% {
                transform: translate(30px, -30px) scale(1.1);
                opacity: 0.4;
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
                opacity: 0.35;
            }
        }

        .ai-voice-bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.15);
            pointer-events: none;
            animation: bubbleMove 15s ease-in-out infinite;
        }

        .ai-voice-bubble:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .ai-voice-bubble:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            right: 15%;
            animation-delay: 2s;
            background: rgba(16, 185, 129, 0.15);
        }

        .ai-voice-bubble:nth-child(3) {
            width: 60px;
            height: 60px;
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
            background: rgba(139, 92, 246, 0.15);
        }

        .ai-voice-bubble:nth-child(4) {
            width: 100px;
            height: 100px;
            top: 30%;
            right: 30%;
            animation-delay: 6s;
            background: rgba(59, 130, 246, 0.12);
        }

        @keyframes bubbleMove {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            25% {
                transform: translate(20px, -30px) scale(1.1);
                opacity: 0.4;
            }

            50% {
                transform: translate(-15px, 20px) scale(0.9);
                opacity: 0.35;
            }

            75% {
                transform: translate(30px, 10px) scale(1.05);
                opacity: 0.38;
            }
        }

        .ai-voice-popup {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .ai-voice-bubbles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            
            pointer-events: none;
        }

        .ai-voice-bubble {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            filter: blur(1px);
            animation-timing-function: linear;
            
            animation-iteration-count: infinite;
            will-change: transform, opacity;
        }

        .ai-voice-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .ai-voice-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ai-voice-logo {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .ai-voice-title h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .ai-voice-title p {
            margin: 4px 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .ai-voice-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .ai-voice-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .ai-voice-content {
            padding: 32px 28px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-voice-circle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 32px;
            min-height: 200px;
        }

        .ai-voice-circle {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-voice-circle-inner {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
        }

        .ai-voice-circle.listening .ai-voice-circle-inner {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulseCircle 1.5s ease-in-out infinite;
        }

        .ai-voice-circle.speaking .ai-voice-circle-inner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulseCircle 1s ease-in-out infinite;
        }

        @keyframes pulseCircle {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
            }
        }

        .ai-voice-ripple {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 3px solid #3b82f6;
            border-radius: 50%;
            opacity: 0;
            animation: ripple 2s ease-out infinite;
        }

        .ai-voice-circle.listening .ai-voice-ripple {
            border-color: #ef4444;
            animation: ripple 1.5s ease-out infinite;
        }

        .ai-voice-circle.speaking .ai-voice-ripple {
            border-color: #10b981;
            animation: ripple 1s ease-out infinite;
        }

        .ai-voice-ripple:nth-child(2) {
            animation-delay: 0s;
        }

        .ai-voice-ripple:nth-child(3) {
            animation-delay: 0.5s;
        }

        .ai-voice-ripple:nth-child(4) {
            animation-delay: 1s;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .ai-voice-model-selector {
            margin-bottom: 32px;
        }

        .ai-voice-model-selector h3 {
            margin: 0 0 16px;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .ai-voice-models {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .ai-voice-model-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ai-voice-model-btn:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .ai-voice-model-btn.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
        }

        .ai-voice-model-btn i {
            font-size: 32px;
            color: #3b82f6;
        }

        .ai-voice-model-btn.active i {
            color: #2563eb;
        }

        .voice-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .voice-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .ai-voice-subtitle-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .ai-voice-subtitle-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .ai-voice-subtitle-content {
            flex: 1;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            color: #1f2937;
            min-height: 0;
        }

        .ai-voice-subtitle-content p {
            margin: 8px 0;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .ai-subtitle-placeholder {
            color: #9ca3af !important;
            font-style: italic;
            text-align: center;
            padding: 20px !important;
        }

        .ai-subtitle-user {
            border-left-color: #10b981 !important;
        }

        .ai-subtitle-ai {
            border-left-color: #3b82f6 !important;
        }

        .ai-voice-footer {
            padding: 20px 28px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .ai-voice-control-btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .ai-voice-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .ai-voice-control-btn.listening {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .ai-voice-control-btn.speaking {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        @media screen and (max-width: 768px) {
            .ai-voice-popup {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .ai-voice-circle {
                width: 150px;
                height: 150px;
            }

            .ai-voice-circle-inner {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }

            .ai-voice-models {
                grid-template-columns: 1fr;
            }
        }

        .emergency-btn-admin {
            background: #dc2626 !important;
        }

        .emergency-btn-admin:hover {
            background: #b91c1c !important;
        }

        .service-popup-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            animation: slideInFromBottom 0.3s ease-out;
            overflow: hidden;
            touch-action: manipulation;
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .service-popup-header {
            background: #3b82f6;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10001;
        }

        .service-popup-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .service-popup-title i {
            font-size: 20px;
        }

        .service-popup-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            position: relative;
        }

        .service-popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .service-popup-close:active {
            transform: rotate(90deg) scale(0.95);
        }

        .service-popup-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            height: calc(100vh - 72px);
            position: relative;
        }

        @media screen and (max-width: 1280px) and (min-width: 800px) {
            .dashboard-main {
                padding: 16px;
            }

            .header {
                padding: 16px 20px;
            }

            .header-title {
                font-size: 20px;
            }

            .welcome-section h1 {
                font-size: 24px;
            }

            .welcome-section p {
                font-size: 15px;
            }

            .button-container {
                gap: 16px;
                padding: 20px;
            }

            .red-btn,
            .emergency-btn {
                padding: 18px 24px;
                font-size: 15px;
            }

            .red-btn i,
            .emergency-btn i {
                font-size: 18px;
            }

            .footer {
                padding: 12px 20px;
                font-size: 13px;
            }

            .voice-assistant-button {
                width: 56px;
                height: 56px;
                font-size: 22px;
            }

            .voice-assistant-status {
                max-width: 280px;
                padding: 12px 14px;
                font-size: 13px;
            }
        }

        @media screen and (max-width: 1024px) {
            .service-popup-header {
                padding: 14px 16px;
            }

            .service-popup-title {
                font-size: 16px;
            }

            .service-popup-title i {
                font-size: 18px;
            }

            .service-popup-close {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        @media screen and (max-width: 768px) {
            .service-popup-header {
                padding: 12px 16px;
            }

            .service-popup-title {
                font-size: 15px;
                gap: 10px;
            }

            .service-popup-title i {
                font-size: 16px;
            }

            .service-popup-close {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .service-popup-content {
                height: calc(100vh - 64px);
            }
        }

        @media screen and (max-width: 480px) {
            .service-popup-header {
                padding: 10px 12px;
            }

            .service-popup-title {
                font-size: 14px;
                gap: 8px;
            }

            .service-popup-title i {
                font-size: 14px;
            }

            .service-popup-close {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .service-popup-content {
                height: calc(100vh - 56px);
            }
        }

        @media screen and (max-width: 1280px) and (min-width: 800px) and (orientation: landscape) {
            .dashboard-main {
                padding: 12px 16px;
            }

            .header {
                padding: 14px 18px;
            }

            .header-title {
                font-size: 20px;
            }

            .welcome-section {
                padding: 20px;
            }

            .welcome-section h1 {
                font-size: 24px;
            }

            .welcome-section p {
                font-size: 15px;
            }

            .button-container {
                gap: 14px;
                padding: 18px;
            }

            .red-btn,
            .emergency-btn {
                padding: 16px 22px;
                font-size: 15px;
                min-height: 56px;
            }

            .red-btn i,
            .emergency-btn i {
                font-size: 18px;
                margin-right: 8px;
            }

            .red-btn span,
            .emergency-btn span {
                font-size: 15px;
            }

            .footer {
                padding: 10px 18px;
                font-size: 13px;
            }

            .voice-assistant-button {
                width: 56px;
                height: 56px;
                font-size: 22px;
                right: 20px;
                bottom: 20px;
            }

            .voice-assistant-status {
                max-width: 280px;
                padding: 12px 14px;
                font-size: 13px;
            }

            .service-popup-header {
                padding: 14px 18px;
            }

            .service-popup-title {
                font-size: 17px;
            }

            .service-chat-messages {
                padding: 14px;
            }

            .service-message {
                max-width: 70%;
                font-size: 15px;
                padding: 10px 14px;
            }

            .service-chat-input-container {
                padding: 12px 16px;
            }
        }

        .service-chat-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .service-chat-header-controls {
            padding: 12px 16px;
            background: rgba(59, 130, 246, 0.05);
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .service-online-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .service-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #f44336;
            transition: background-color 0.3s;
        }

        .service-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .service-message {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
            animation: slideIn 0.2s ease;
        }

        .service-message-own {
            align-self: flex-end;
            background: #3b82f6;
            color: white;
            border-radius: 12px 12px 4px 12px;
        }

        .service-message-other {
            align-self: flex-start;
            background: #e5e7eb;
            color: #1f2937;
            border-radius: 12px 12px 12px 4px;
        }

        .service-message-system {
            align-self: center;
            background: #f3f4f6;
            color: #6b7280;
            font-style: italic;
            text-align: center;
            max-width: 90%;
            padding: 8px 12px;
        }

        .service-message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .service-message-text {
            font-size: 15px;
            line-height: 1.4;
        }

        .service-message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
        }

        .service-typing-indicator {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
        }

        .service-typing-dots {
            display: flex;
            gap: 4px;
        }

        .service-typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite;
        }

        .service-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .service-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .service-chat-input-container {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
            position: sticky;
            bottom: 0;
            z-index: 999;
            display: block;
            width: 100%;
            box-sizing: border-box;
            min-height: 70px;
            flex-shrink: 0;
        }

        .service-shortcut-hint {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 16px;
            background: rgba(59, 130, 246, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            animation: fadeInHint 0.5s ease 0.8s forwards;
            pointer-events: none;
            z-index: 15;
        }

        .service-shortcut-hint::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            width: 12px;
            height: 12px;
            background: rgba(59, 130, 246, 0.95);
            transform: rotate(45deg);
            border-radius: 2px;
        }

        .service-shortcut-hint i {
            font-size: 14px;
            opacity: 0.9;
        }

        .service-shortcut-hint .shortcut-key {
            background: rgba(255, 255, 255, 0.25);
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        @keyframes fadeInHint {
            0% {
                opacity: 0;
                transform: translateY(5px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .service-chat-input-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            width: 100%;
        }

        .service-chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 16px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            display: block;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        .service-chat-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .service-chat-btn {
            padding: 10px 16px;
            min-width: 44px;
            height: 44px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .service-btn-send {
            background: #3b82f6;
            color: white;
        }

        .service-btn-send:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .service-btn-send:active {
            transform: scale(0.95);
        }

        @media screen and (min-width: 1024px) and (max-width: 1280px) and (orientation: landscape) {
            .service-popup-fullscreen {
                z-index: 99999;
            }

            .service-chat-wrapper {
                height: 100vh;
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .service-chat-messages {
                padding: 16px;
                margin-bottom: 80px;
            }

            .service-chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 16px 20px;
                background: white;
                border-top: 2px solid #e5e7eb;
                z-index: 99999;
                box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
                min-height: 80px;
            }

            .service-chat-input {
                font-size: 16px;
                min-height: 48px;
                padding: 12px 16px;
            }

            .service-chat-btn {
                min-width: 48px;
                height: 48px;
            }
        }

        @media screen and (max-width: 768px) {
            .service-chat-messages {
                padding: 12px;
                margin-bottom: 80px;
            }

            .service-message {
                max-width: 85%;
                font-size: 14px;
                padding: 8px 12px;
            }

            .service-chat-input-container {
                padding: 12px 16px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 99999;
                background: white;
                box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            }
        }

        @media screen and (max-width: 480px) {
            .service-chat-messages {
                padding: 8px;
            }

            .service-message {
                max-width: 90%;
                font-size: 13px;
                padding: 8px 10px;
            }

            .service-chat-input-container {
                padding: 8px 10px;
            }

            .service-chat-input {
                font-size: 14px;
                padding: 8px 12px;
                min-height: 40px;
            }

            .service-chat-btn {
                min-width: 40px;
                min-height: 40px;
                padding: 8px;
            }
        }

        .settings-btn {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 20px;
            position: absolute;
            right: 24px;
            z-index: 10;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .settings-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-sidebar.active {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .settings-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .settings-content {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .settings-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .settings-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .settings-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background: #f3f4f6;
        }

        .settings-item.disabled .settings-item-icon {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        }

        .settings-item.disabled .settings-item-content h3,
        .settings-item.disabled .settings-item-content p {
            color: #9ca3af;
        }

        .settings-item-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .settings-item-icon.red {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }

        .settings-item-icon.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .settings-item-icon.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .settings-item-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .settings-item-content p {
            font-size: 13px;
            color: #6b7280;
        }

        .settings-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 24px 0;
        }

        .settings-info {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .settings-info-icon {
            color: #d97706;
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .settings-info-content {
            flex: 1;
        }

        .settings-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 6px;
        }

        .settings-info p {
            font-size: 13px;
            color: #78350f;
            line-height: 1.5;
        }

        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }

        .custom-popup {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            text-align: center;
            animation: slideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .popup-icon {
            display: none;
        }

        .popup-title {
            color: #0f172a;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .popup-message {
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            letter-spacing: -0.01em;
        }

        .popup-btn-confirm {
            background: #dc2626;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .popup-btn-confirm:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .popup-btn-cancel {
            background: #f3f4f6;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .popup-btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media screen and (max-width: 768px) {
            .custom-popup {
                padding: 30px 20px;
                margin: 20px;
            }

            .popup-icon {
                width: 60px;
                height: 60px;
            }

            .popup-icon i {
                font-size: 2rem;
            }

            .popup-title {
                font-size: 1.5rem;
            }

            .popup-message {
                font-size: 1rem;
            }

            .popup-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .popup-btn {
                width: 100%;
            }
        }

        .kiosk-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            backdrop-filter: blur(10px);
        }

        .kiosk-password-modal.active {
            display: flex;
        }

        .kiosk-password-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: kioskSlideIn 0.4s ease-out;
        }

        @keyframes kioskSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .kiosk-password-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .kiosk-password-icon i {
            font-size: 36px;
            color: white;
        }

        .kiosk-password-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .kiosk-password-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .kiosk-password-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
            text-align: center;
            letter-spacing: 4px;
            font-weight: 600;
        }

        .kiosk-password-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .kiosk-password-input.error {
            border-color: #ef4444;
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .kiosk-password-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: -12px;
            margin-bottom: 16px;
            display: none;
        }

        .kiosk-password-error.show {
            display: block;
        }

        .kiosk-password-buttons {
            display: flex;
            gap: 12px;
        }

        .kiosk-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .kiosk-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .kiosk-btn-cancel:hover {
            background: #e5e7eb;
        }

        .kiosk-btn-submit {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .kiosk-btn-submit:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .settings-item-icon.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .footer {
            width: 100%;
            background: #3b82f6;
            padding: 16px 20px;
            text-align: center;
            color: #ffffff;
            font-size: 14px;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
        }

        .system-status {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .system-status.ready {
            background: #d1fae5;
            border-color: #6ee7b7;
            color: #065f46;
        }

        .system-status.warning {
            background: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }

        .system-status.error {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        .toast-notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000000;
            min-width: 300px;
            max-width: 500px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #3b82f6;
        }

        .toast-notification.show {
            display: flex;
        }

        .toast-notification.success {
            border-left-color: #10b981;
        }

        .toast-notification.success .toast-icon {
            color: #10b981;
        }

        .toast-notification.error {
            border-left-color: #ef4444;
        }

        .toast-notification.error .toast-icon {
            color: #ef4444;
        }

        .toast-notification.info {
            border-left-color: #3b82f6;
        }

        .toast-notification.info .toast-icon {
            color: #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .toast-message {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #4b5563;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast-notification.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        @media (max-width: 640px) {
            .toast-notification {
                bottom: 20px;
                right: 20px;
                left: 20px;
                min-width: auto;
                max-width: none;
            }
        }

        html.kiosk-fullscreen,
        body.kiosk-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }

        html.kiosk-fullscreen {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%) !important;
        }

        .kiosk-fullscreen .dashboard-main {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }

        .kiosk-fullscreen::-webkit-scrollbar {
            display: none !important;
        }

        .kiosk-fullscreen {
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        @media screen and (max-width: 768px) {
            .app-logo {
                height: 40px;
            }

            .app-title {
                font-size: 16px;
            }

            .app-header {
                padding: 24px 16px;
            }

            .app-brand-container {
                padding: 10px 16px;
                gap: 8px;
            }

            .welcome-section h1 {
                font-size: 24px;
            }

            .welcome-section p {
                font-size: 14px;
            }

            .red-btn {
                font-size: 16px;
                padding: 18px 32px;
            }

            .emergency-btn {
                font-size: 14px;
                padding: 14px 24px;
            }

            .content-area {
                padding: 24px 16px;
            }
        }

        @media screen and (max-width: 480px) {
            .app-logo {
                height: 36px;
            }

            .app-title {
                font-size: 14px;
            }

            .app-header {
                padding: 20px 12px;
            }

            .app-brand-container {
                padding: 8px 12px;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .welcome-section {
                margin-bottom: 24px;
            }

            .welcome-section h1 {
                font-size: 20px;
            }

            .welcome-section p {
                font-size: 13px;
            }

            .red-btn {
                font-size: 15px;
                padding: 16px 28px;
            }

            .emergency-btn {
                font-size: 13px;
                padding: 12px 20px;
            }

            .content-area {
                padding: 20px 12px;
            }

            .footer {
                padding: 12px 16px;
                font-size: 12px;
            }
        }

        .error-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .error-popup-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-popup-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .error-popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .error-popup-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }

        .error-popup-message {
            font-size: 15px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
            text-align: left;
            white-space: pre-line;
        }

        .error-popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media screen and (max-width: 400px) {
            .app-header {
                padding: 16px 8px;
            }

            .app-brand-container {
                padding: 6px 10px;
                gap: 6px;
                max-width: 95%;
            }

            .app-logo {
                height: 32px;
            }

            .app-title {
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .welcome-section h1 {
                font-size: 18px;
            }

            .welcome-section p {
                font-size: 12px;
            }

            .red-btn {
                font-size: 14px;
                padding: 14px 24px;
                width: 100%;
                max-width: 280px;
            }

            .emergency-btn {
                font-size: 12px;
                padding: 10px 18px;
                width: 100%;
                max-width: 280px;
            }
        }

        @media screen and (orientation: landscape) and (max-height: 500px) {
            .app-header {
                padding: 32px 20px;
            }

            .app-logo {
                height: 40px;
            }

            .app-title {
                font-size: 16px;
            }

            .content-area {
                padding: 20px 16px;
            }

            .welcome-section {
                margin-bottom: 20px;
            }

            .welcome-section h1 {
                font-size: 20px;
            }

            .welcome-section p {
                font-size: 13px;
            }

            .red-btn {
                padding: 16px 28px;
                font-size: 16px;
            }

            .emergency-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        .emergency-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .emergency-modal-overlay.active {
            display: flex;
        }

        .emergency-modal {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .emergency-modal-header {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            padding: 24px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(21, 101, 192, 0.3);
            flex-shrink: 0;
        }

        .emergency-modal-content {
            padding: 30px 24px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
        }

        .emergency-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .emergency-modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            margin: 10px 0;
        }

        .emergency-modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .emergency-modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
        }

        .emergency-modal-title-section {
            flex: 1;
        }

        .emergency-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin: 0 0 6px 0;
        }

        .emergency-modal-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .emergency-modal-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            position: relative;
        }

        .emergency-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .emergency-numbers-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .emergency-number-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 18px;
            text-decoration: none;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .emergency-number-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #1976D2 0%, #1565C0 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .emergency-number-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(25, 118, 210, 0.25);
        }

        .emergency-number-card:hover::before {
            opacity: 1;
        }

        .emergency-number-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            color: white;
        }

        .icon-police {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .icon-ambulance {
            background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .icon-fire {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .icon-rescue {
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .icon-disaster {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }

        .emergency-number-details {
            flex: 1;
        }

        .emergency-number-name {
            font-size: 16px;
            font-weight: 500;
            color: #546e7a;
            margin-bottom: 6px;
            letter-spacing: 0.02em;
        }

        .emergency-number-value {
            font-size: 28px;
            font-weight: 700;
            color: #1976D2;
            letter-spacing: 2px;
        }

        @media screen and (max-width: 768px) {
            .emergency-modal {
                width: 95%;
                max-height: 90vh;
            }

            .emergency-modal-header {
                padding: 20px;
            }

            .emergency-modal-title {
                font-size: 20px;
            }

            .emergency-modal-subtitle {
                font-size: 13px;
            }

            .emergency-modal-content {
                padding: 24px 20px;
            }

            .emergency-number-card {
                padding: 18px;
            }

            .emergency-number-icon {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }

            .emergency-number-name {
                font-size: 15px;
            }

            .emergency-number-value {
                font-size: 24px;
            }
        }

        @media screen and (max-width: 480px) {
            .emergency-modal-header {
                padding: 18px;
            }

            .emergency-modal-title {
                font-size: 18px;
            }

            .emergency-modal-subtitle {
                font-size: 12px;
            }

            .emergency-modal-content {
                padding: 20px 16px;
            }

            .emergency-number-card {
                padding: 16px;
                gap: 14px;
            }

            .emergency-number-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .emergency-number-name {
                font-size: 14px;
            }

            .emergency-number-value {
                font-size: 22px;
            }
        }
    </style>
</head>

<body>
    
    <div class="error-popup-overlay" id="errorPopupOverlay">
        <div class="error-popup-content">
            <div class="error-popup-icon" id="errorPopupIcon"></div>
            <div class="error-popup-title" id="errorPopupTitle">Error</div>
            <div class="error-popup-message" id="errorPopupMessage"></div>
            <button class="error-popup-btn" onclick="closeErrorPopup()">OK</button>
        </div>
    </div>

    <div class="dashboard-main">
        <div class="app-header">
            <div class="app-brand-container">
                <img src="./img/logo.png" alt="EHS Logo" class="app-logo"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="logo-fallback" style="display:none; font-size: 2rem; color: #e74c3c;"></div>
                <div class="app-title">Emergency Hotline System</div>
            </div>
            <button class="settings-btn" id="settingsBtn" title="Pengaturan">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <div class="content-area">
            <div class="welcome-section">
                <h1 id="welcomeTitle">Selamat Datang!</h1>
                <p id="welcomeSubtitle">Pilih layanan darurat yang Anda butuhkan</p>
                <div id="userIdentity"
                    style="margin-top: 16px; padding: 12px 20px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                        <i id="userIcon" class="fas fa-user" style="color: #3b82f6;"></i>
                        <div style="text-align: left;">
                            <div id="userName" style="font-weight: 600; color: #1f2937; font-size: 16px;"></div>
                            <div id="userBadge" style="font-size: 12px; color: #6b7280; margin-top: 4px;"></div>
                        </div>
                    </div>
                </div>
                <div id="systemStatus" class="system-status"
                    style="margin-top: 20px; padding: 10px; border-radius: 8px; font-size: 0.9rem; display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="statusText">Checking system status...</span>
                </div>
            </div>

            <div class="button-container">
                <button class="red-btn" onclick="sendEmergencyAlert()" id="emergencyButton">
                    <i class="fas fa-hand-paper"></i>
                    <span>TEKAN UNTUK MEMANGGIL <span class="shortcut-hint">[1]</span></span>
                </button>

                <button class="emergency-btn" onclick="openEmergencyNumbersModal()" id="emergencyCallButton">
                    <i class="fas fa-phone-volume"></i>
                    <span>EMERGENCY CALL <span class="shortcut-hint">[2]</span></span>
                </button>

                <button class="emergency-btn emergency-btn-service" onclick="openServicePopup()" id="serviceButton">
                    <i class="fas fa-comments"></i>
                    <span>SERVICE <span class="shortcut-hint">[3]</span></span>
                </button>
            </div>

            <div class="shortcut-popup-overlay" id="shortcutPopup" style="display: none;">
                <div class="shortcut-popup">
                    <div class="shortcut-popup-header">
                        <i class="fas fa-keyboard"></i>
                        <h3>Shortcut Keyboard</h3>
                        <button class="shortcut-popup-close" onclick="closeShortcutPopup()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="shortcut-popup-content">
                        <div class="shortcut-item">
                            <span class="shortcut-key">[1]</span>
                            <span class="shortcut-desc">Tekan untuk memanggil</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">[2]</span>
                            <span class="shortcut-desc">Emergency Call</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">[3]</span>
                            <span class="shortcut-desc">Service Chat</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 Emergency Hotline System. All rights reserved.</p>
        </div>
    </div>

    <div class="emergency-modal-overlay" id="emergencyNumbersModal">
        <div class="emergency-modal">
            <div class="emergency-modal-header">
                <div class="emergency-modal-title-section">
                    <h2 class="emergency-modal-title">Nomor Darurat</h2>
                    <p class="emergency-modal-subtitle">Pilih layanan darurat yang Anda butuhkan</p>
                </div>
                <button class="emergency-modal-close" onclick="closeEmergencyNumbersModal()" title="Tutup [7]">
                    <i class="fas fa-times"></i>
                    <span class="shortcut-hint"
                        style="position: absolute; top: -20px; right: 0; font-size: 10px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; white-space: nowrap;">[7]</span>
                </button>
            </div>
            <div class="emergency-modal-content">
                <div class="emergency-numbers-list">
                    <a href="tel:110" class="emergency-number-card">
                        <div class="emergency-number-icon icon-police">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Polisi</div>
                            <div class="emergency-number-value">110</div>
                        </div>
                    </a>

                    <a href="tel:118" class="emergency-number-card">
                        <div class="emergency-number-icon icon-ambulance">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Ambulans</div>
                            <div class="emergency-number-value">118</div>
                        </div>
                    </a>

                    <a href="tel:113" class="emergency-number-card">
                        <div class="emergency-number-icon icon-fire">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Pemadam Kebakaran</div>
                            <div class="emergency-number-value">113</div>
                        </div>
                    </a>

                    <a href="tel:115" class="emergency-number-card">
                        <div class="emergency-number-icon icon-rescue">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">SAR (Pencarian & Penyelamatan)</div>
                            <div class="emergency-number-value">115</div>
                        </div>
                    </a>

                    <a href="tel:112" class="emergency-number-card">
                        <div class="emergency-number-icon icon-disaster">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Nomor Darurat Nasional</div>
                            <div class="emergency-number-value">112</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="voice-assistant-wrapper" aria-live="polite">
        <div class="voice-assistant-tooltip" id="voiceAssistantTooltip">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Butuh bantuan cepat?</strong>
                <p>Jika ingin bertanya untuk penanganan medis, tekan tombol mikrofon ini.</p>
            </div>
            <button type="button" class="voice-tooltip-close" id="voiceAssistantTooltipClose"
                aria-label="Tutup petunjuk">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="voice-assistant-popover" id="voiceAssistantPopover" aria-hidden="true" role="dialog">
            
            <div class="voice-bubbles-container" id="voiceBubblesContainer"></div>

            <div class="voice-popover-header">
                <div>
                    <h3>Asisten Pertolongan Pertama</h3>
                    <p>Tekan tombol mikrofon, ajukan pertanyaan, dan dengarkan panduan langkah demi langkah.</p>
                </div>
                <button class="voice-popover-close" id="voiceAssistantPopoverClose" type="button"
                    aria-label="Tutup asisten">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="voice-conversation-log" id="voiceAssistantConversation">
                <div class="voice-conversation-placeholder">
                    <i class="fas fa-headset"></i>
                    <p>Mulai percakapan dengan menekan mikrofon. Pertanyaan dan jawaban akan muncul di sini.</p>
                </div>
            </div>
        </div>
        <div class="voice-assistant-status" id="voiceAssistantStatus">
            <strong id="voiceAssistantStatusLabel">
                Asisten Pertolongan Pertama
                <i class="fas fa-chevron-up voice-assistant-status-toggle"></i>
            </strong>
            <p id="voiceAssistantStatusMessage">Tekan tombol mikrofon untuk mulai bertanya.</p>
        </div>
        <button id="voiceAssistantButton" class="voice-assistant-button" type="button"
            aria-label="Asisten suara pertolongan pertama" title="AI Voice Assistant [4]">
            <i class="fas fa-microphone"></i>
            <span class="shortcut-hint-microphone"
                style="position: absolute; top: 50%; left: -145px; transform: translateY(-50%); font-size: 11px; background: linear-gradient(135deg, rgba(37, 99, 235, 0.95) 0%, rgba(29, 78, 216, 0.95) 100%); color: white; padding: 5px 10px; border-radius: 8px; white-space: nowrap; font-weight: 600; box-shadow: 0 3px 10px rgba(37, 99, 235, 0.4); z-index: 1000; pointer-events: none;">Tekan
                [4] untuk AI Voice</span>
        </button>
    </div>

    <div id="aiVoicePopup" class="ai-voice-popup-overlay" style="display: none;">
        <div class="ai-voice-popup">
            
            <div class="ai-voice-bubbles-container" id="aiVoiceBubblesContainer"></div>

            <div class="ai-voice-header">
                <div class="ai-voice-brand">
                    <div class="ai-voice-logo">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-voice-title">
                        <h2>rayfain.ai</h2>
                        <p>Powered by SMK MARHAS Margahayu</p>
                    </div>
                </div>
                <button class="ai-voice-close" onclick="closeAIVoicePopup()" title="Tutup [1]">
                    <i class="fas fa-times"></i>
                    <span class="shortcut-hint"
                        style="position: absolute; top: -20px; right: 0; font-size: 10px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">[1]</span>
                </button>
            </div>

            <div class="ai-voice-content">
                
                <div class="ai-voice-circle-container">
                    <div class="ai-voice-circle" id="aiVoiceCircle">
                        <div class="ai-voice-circle-inner">
                            <i class="fas fa-microphone" id="aiVoiceIcon"></i>
                        </div>
                        <div class="ai-voice-ripple" id="aiVoiceRipple1"></div>
                        <div class="ai-voice-ripple" id="aiVoiceRipple2"></div>
                        <div class="ai-voice-ripple" id="aiVoiceRipple3"></div>
                    </div>
                </div>

                <div class="ai-voice-subtitle-container">
                    <div class="ai-voice-subtitle-header">
                        <i class="fas fa-closed-captioning"></i>
                        <span>Transkrip Percakapan</span>
                    </div>
                    <div class="ai-voice-subtitle-content" id="aiVoiceSubtitle">
                        <p class="ai-subtitle-placeholder">Mulai berbicara untuk melihat transkrip...</p>
                    </div>
                </div>
            </div>

            <div class="ai-voice-footer">
                <button class="ai-voice-control-btn" id="aiVoiceControlBtn" onclick="toggleAIVoiceListening()">
                    <i class="fas fa-microphone"></i>
                    <span>Mulai Berbicara <span class="shortcut-hint"
                            style="margin-left: 8px; font-size: 11px; opacity: 0.8;">[2]</span></span>
                </button>
            </div>
        </div>
    </div>

    <div id="servicePopup" class="service-popup-fullscreen" style="display: none;">
        <div class="service-popup-header">
            <div class="service-popup-title">
                <i class="fas fa-comments"></i>
                <span>Service Chat</span>
            </div>
            <button class="service-popup-close" onclick="closeServicePopup()" aria-label="Tutup" title="Tutup [8]">
                <span class="shortcut-hint"
                    style="position: absolute; top: 50%; right: 45px; transform: translateY(-50%); font-size: 10px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; white-space: nowrap;">[8]</span>
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="service-popup-content" id="servicePopupContent">
            
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay"></div>

    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-header">
            <h2>
                <i class="fas fa-cog"></i>
                Pengaturan
            </h2>
            <button class="settings-close" id="settingsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="settings-content">
            
            <div class="settings-section">
                <div class="settings-section-title">Administrator</div>

                <div id="adminPanelItem" class="settings-item" style="cursor: pointer;"
                    onclick="navigateToAdminPanel()">
                    <div class="settings-item-icon red">
                        <i class="fas fa-shield-halved"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Admin Panel</h3>
                        <p>Akses dashboard administrator</p>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <div class="settings-section">
                <div class="settings-section-title">Emergency Response</div>

                <div id="emergencyDashboardItem" class="settings-item" style="cursor: pointer;"
                    onclick="navigateToEmergencyDashboard()">
                    <div class="settings-item-icon orange">
                        <i class="fas fa-truck-medical"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Emergency Dashboard</h3>
                        <p>Monitor & tangani kasus darurat</p>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <div class="settings-section">
                <div class="settings-section-title">Kiosk Mode</div>

                <div class="settings-item" id="enterKioskModeBtn" style="cursor: pointer;">
                    <div class="settings-item-icon green">
                        <i class="fas fa-expand"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Masuk Kiosk Mode</h3>
                        <p>Aktifkan mode layar penuh (perlu password)</p>
                    </div>
                </div>

                <div class="settings-item" id="exitKioskModeBtn" style="cursor: pointer;">
                    <div class="settings-item-icon purple">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Keluar dari Kiosk Mode</h3>
                        <p>Keluar dari mode layar penuh (perlu password)</p>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <div class="settings-info">
                <div class="settings-info-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="settings-info-content">
                    <h4>Auto Redirect</h4>
                    <p>Halaman ini akan otomatis kembali ke scan wajah setelah 3 menit untuk keamanan.</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 12px; color: #9ca3af;">Emergency Hotline System</p>
                <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Version 2.0.0 - October 2025</p>
            </div>
        </div>
    </div>

    <div class="emergency-modal-overlay" id="emergencyNumbersModal">
        <div class="emergency-modal">
            <div class="emergency-modal-header">
                <div class="emergency-modal-title-section">
                    <h2 class="emergency-modal-title">Nomor Darurat</h2>
                    <p class="emergency-modal-subtitle">Pilih layanan darurat yang Anda butuhkan</p>
                </div>
                <button class="emergency-modal-close" onclick="closeEmergencyNumbersModal()" title="Tutup [7]">
                    <i class="fas fa-times"></i>
                    <span class="shortcut-hint"
                        style="position: absolute; top: -20px; right: 0; font-size: 10px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; white-space: nowrap;">[7]</span>
                </button>
            </div>
            <div class="emergency-modal-content">
                <div class="emergency-numbers-list">
                    <a href="tel:110" class="emergency-number-card">
                        <div class="emergency-number-icon icon-police">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Polisi</div>
                            <div class="emergency-number-value">110</div>
                        </div>
                    </a>

                    <a href="tel:118" class="emergency-number-card">
                        <div class="emergency-number-icon icon-ambulance">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Ambulans</div>
                            <div class="emergency-number-value">118</div>
                        </div>
                    </a>

                    <a href="tel:113" class="emergency-number-card">
                        <div class="emergency-number-icon icon-fire">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Pemadam Kebakaran</div>
                            <div class="emergency-number-value">113</div>
                        </div>
                    </a>

                    <a href="tel:115" class="emergency-number-card">
                        <div class="emergency-number-icon icon-rescue">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">SAR (Pencarian & Penyelamatan)</div>
                            <div class="emergency-number-value">115</div>
                        </div>
                    </a>

                    <a href="tel:112" class="emergency-number-card">
                        <div class="emergency-number-icon icon-disaster">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="emergency-number-details">
                            <div class="emergency-number-name">Nomor Darurat Nasional</div>
                            <div class="emergency-number-value">112</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>

        function getServerURL() {
            // Production: Railway atau domain lain dengan HTTPS
            // Jika halaman diakses via HTTPS, gunakan origin yang sama (relative URL)
            if (window.location.protocol === 'https:') {
                return window.location.origin;
            }
            
            const WIFI_IPS = ['192.168.18.30', '192.168.18.31'];
            const PORT = 3003;

            // Localhost development
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return `http://localhost:${PORT}`;
            }

            // IP Address development (LAN)
            if (window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return `http://${window.location.hostname}:${PORT}`;
            }

            // Fallback untuk local WiFi
            return `http://${WIFI_IPS[0]}:${PORT}`;
        }

        function getWebSocketURL() {
            const serverURL = getServerURL();
            // Untuk HTTPS, gunakan WSS
            if (serverURL.startsWith('https://')) {
                return serverURL.replace('https://', 'wss://');
            }
            return serverURL.replace('http://', 'ws://');
        }

        const SERVER_URL = getServerURL();
        const WS_URL = getWebSocketURL();
        console.log(' Server URL:', SERVER_URL);
        console.log(' WebSocket URL:', WS_URL);

        const EMERGENCY_CONTACTS = [
            { name: 'Petugas Utama', phone: '+628814554581' },
            { name: 'Petugas Backup 1', phone: '+6288362272732' },
            { name: 'Petugas Backup 2', phone: '+6288647356283' }
        ];

        const EMERGENCY_LOCATION = {
            name: 'SMK MARHAS Margahayu',
            address: 'Jl. Raya Margahayu No.186, Margahayu, Kec. Margahayu, Kabupaten Bandung, Jawa Barat',
            latitude: -6.9759367,
            longitude: 107.5704834,
            googleMaps: 'https://maps.app.goo.gl/iUSHhmnRQdGKwj8x8'
        };

        const MESSAGE_TEMPLATE = {
            title: ' NOTIFIKASI DARURAT ',
            footer: 'Pesan otomatis dari Emergency Hotline System - Kiosk SMK MARHAS Margahayu'
        };

        const AUTO_REDIRECT_SECONDS = 900;

        function showCustomConfirm(title, message, onConfirm, onCancel) {
            activePopup = 'confirm'; // Set popup active

            const overlay = document.createElement('div');
            overlay.className = 'custom-popup-overlay';
            overlay.innerHTML = `
                <div class="custom-popup">
                    <div class="popup-title">${title}</div>
                    <div class="popup-message">${message}</div>
                    <div class="popup-buttons">
                        <button class="popup-btn popup-btn-confirm" onclick="handleConfirm()" data-shortcut="1">
                            Ya, Lanjutkan <span class="shortcut-badge" style="margin-left: 8px; background: rgba(16, 185, 129, 0.1); color: #059669; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[1]</span>
                        </button>
                        <button class="popup-btn popup-btn-cancel" onclick="handleCancel()" data-shortcut="2">
                            Batal <span class="shortcut-badge" style="margin-left: 8px; background: rgba(239, 68, 68, 0.1); color: #dc2626; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[2]</span>
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            window.handleConfirm = function () {
                activePopup = null; // Clear popup state
                document.body.removeChild(overlay);
                delete window.handleConfirm;
                delete window.handleCancel;
                if (onConfirm) onConfirm();
            };

            window.handleCancel = function () {
                activePopup = null; // Clear popup state
                document.body.removeChild(overlay);
                delete window.handleConfirm;
                delete window.handleCancel;
                if (onCancel) onCancel();
            };

            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) {
                    window.handleCancel();
                }
            });

            const confirmKeyHandler = function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                const key = e.key;
                const isNumber = /^[1-2]$/.test(key);

                if (!isNumber) {

                    if (e.key === 'Escape') {
                        window.handleCancel();
                        document.removeEventListener('keydown', confirmKeyHandler);
                    }
                    return;
                }

                const num = parseInt(key);
                e.preventDefault();

                switch (num) {
                    case 1:
                        window.handleConfirm();
                        break;
                    case 2:
                        window.handleCancel();
                        break;
                }

                document.removeEventListener('keydown', confirmKeyHandler);
            };

            document.addEventListener('keydown', confirmKeyHandler);
        }

        async function sendEmergencyAlert() {

            showEmergencyTypeDialog();
        }

        function showEmergencyTypeDialog() {
            activePopup = 'emergency-type'; // Set popup active

            const overlay = document.createElement('div');
            overlay.id = 'emergency-type-overlay';
            overlay.innerHTML = `
                <div class="emergency-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(4px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                    box-sizing: border-box;
                ">
                    <div class="emergency-dialog" style="
                        background: #fff;
                        border-radius: 12px;
                        max-width: 420px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                        animation: slideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                    ">
                        <div class="emergency-header" style="
                            padding: 24px 24px 16px;
                            border-bottom: 1px solid #f1f5f9;
                        ">
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">Jenis Keadaan Darurat</h2>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #64748b;">Pilih kategori yang sesuai</p>
                        </div>
                        
                        <div class="emergency-body" style="padding: 20px 24px 24px;">
                            <div class="emergency-type-grid" style="
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 12px;
                                margin-bottom: 20px;
                            ">
                                <button class="emergency-type-btn" data-type="medical" data-shortcut="1" style="
                                    background: #fff;
                                    color: #dc2626;
                                    border: 1.5px solid #fecaca;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    position: relative;
                                ">
                                    <i class="fas fa-heartbeat" style="font-size: 24px;"></i>
                                    <span>Medis</span>
                                    <span class="shortcut-badge" style="position: absolute; top: 4px; right: 4px; background: rgba(220, 38, 38, 0.1); color: #dc2626; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[1]</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="fire" data-shortcut="2" style="
                                    background: #fff;
                                    color: #ea580c;
                                    border: 1.5px solid #fed7aa;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    position: relative;
                                ">
                                    <i class="fas fa-fire-alt" style="font-size: 24px;"></i>
                                    <span>Kebakaran</span>
                                    <span class="shortcut-badge" style="position: absolute; top: 4px; right: 4px; background: rgba(234, 88, 12, 0.1); color: #ea580c; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[2]</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="crime" data-shortcut="3" style="
                                    background: #fff;
                                    color: #2563eb;
                                    border: 1.5px solid #bfdbfe;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    position: relative;
                                ">
                                    <i class="fas fa-shield-alt" style="font-size: 24px;"></i>
                                    <span>Kriminal</span>
                                    <span class="shortcut-badge" style="position: absolute; top: 4px; right: 4px; background: rgba(37, 99, 235, 0.1); color: #2563eb; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[3]</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="accident" data-shortcut="4" style="
                                    background: #fff;
                                    color: #7c3aed;
                                    border: 1.5px solid #ddd6fe;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    position: relative;
                                ">
                                    <i class="fas fa-car-crash" style="font-size: 24px;"></i>
                                    <span>Kecelakaan</span>
                                    <span class="shortcut-badge" style="position: absolute; top: 4px; right: 4px; background: rgba(124, 58, 237, 0.1); color: #7c3aed; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[4]</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="other" data-shortcut="5" style="
                                    background: #fff;
                                    color: #475569;
                                    border: 1.5px solid #e2e8f0;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    grid-column: span 2;
                                    position: relative;
                                ">
                                    <i class="fas fa-ellipsis-h" style="font-size: 24px;"></i>
                                    <span>Lainnya</span>
                                    <span class="shortcut-badge" style="position: absolute; top: 4px; right: 4px; background: rgba(71, 85, 105, 0.1); color: #475569; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[5]</span>
                                </button>
                            </div>
                            
                            <button class="cancel-btn" onclick="closeEmergencyTypeDialog()" data-shortcut="6" style="
                                width: 100%;
                                background: #f8fafc;
                                color: #64748b;
                                border: 1px solid #e2e8f0;
                                border-radius: 8px;
                                padding: 12px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.2s;
                                position: relative;
                            ">
                                Batal <span class="shortcut-badge" style="position: absolute; right: 12px; background: rgba(100, 116, 139, 0.1); color: #64748b; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[6]</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    .emergency-type-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                    }
                    
                    .emergency-type-btn:active {
                        transform: translateY(0);
                    }

                    .cancel-btn:hover {
                        background: #f1f5f9;
                        border-color: #cbd5e1;
                    }
                    
                    @media screen and (max-width: 480px) {
                        .emergency-overlay {
                            padding: 16px !important;
                        }
                        
                        .emergency-dialog {
                            max-width: 100% !important;
                        }
                        
                        .emergency-header {
                            padding: 20px 20px 14px !important;
                        }
                        
                        .emergency-header h2 {
                            font-size: 16px !important;
                        }
                        
                        .emergency-header p {
                            font-size: 12px !important;
                        }
                        
                        .emergency-body {
                            padding: 16px 20px 20px !important;
                        }
                        
                        .emergency-type-grid {
                            gap: 10px !important;
                        }
                        
                        .emergency-type-btn {
                            padding: 16px 10px !important;
                            font-size: 13px !important;
                        }

                        .emergency-type-btn i {
                            font-size: 22px !important;
                        }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            const buttons = overlay.querySelectorAll('.emergency-type-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const type = this.getAttribute('data-type');
                    selectEmergencyType(type);
                });
            });

            const emergencyTypeKeyHandler = function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                const key = e.key;
                const isNumber = /^[1-6]$/.test(key);

                if (!isNumber) {

                    if (e.key === 'Escape') {
                        closeEmergencyTypeDialog();
                        document.removeEventListener('keydown', emergencyTypeKeyHandler);
                    }
                    return;
                }

                const num = parseInt(key);
                e.preventDefault();

                switch (num) {
                    case 1:
                        selectEmergencyType('medical');
                        break;
                    case 2:
                        selectEmergencyType('fire');
                        break;
                    case 3:
                        selectEmergencyType('crime');
                        break;
                    case 4:
                        selectEmergencyType('accident');
                        break;
                    case 5:
                        selectEmergencyType('other');
                        break;
                    case 6:
                        closeEmergencyTypeDialog();
                        break;
                }

                document.removeEventListener('keydown', emergencyTypeKeyHandler);
            };

            document.addEventListener('keydown', emergencyTypeKeyHandler);
        }

        function closeEmergencyTypeDialog() {
            activePopup = null; // Clear popup state
            const overlay = document.getElementById('emergency-type-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function selectEmergencyType(type) {

            const typeNames = {
                'medical': 'Medis',
                'fire': 'Kebakaran',
                'crime': 'Kriminal',
                'accident': 'Kecelakaan',
                'other': 'Lainnya'
            };

            const typeIcons = {
                'medical': '',
                'fire': '',
                'crime': '',
                'accident': '',
                'other': ''
            };

            const selectedTypeName = typeNames[type] || 'Lainnya';
            const selectedTypeIcon = typeIcons[type] || '';

            closeEmergencyTypeDialog();

            showCustomConfirm(
                `${selectedTypeIcon} KONFIRMASI EMERGENCY`,
                `Tipe Emergency: <strong>${selectedTypeName}</strong><br><br>Sistem akan mengirim notifikasi darurat ke grup Telegram emergency.<br><br>Semua petugas akan mendapat notifikasi realtime!<br><br>Apakah Anda yakin ingin melanjutkan?`,
                async function () {

                    await proceedWithEmergencyAlert(type);
                },
                function () {

                }
            );
        }

        async function proceedWithEmergencyAlert(accidentType = 'other') {

            showLoadingAlert('Mengirim notifikasi emergency ke Telegram...');

            try {

                let scanId = null;
                let scanTimestamp = null;
                let imagePath = null;
                let userName = null;
                let userPhoto = null;
                let bodyTemperature = null;

                try {
                    const lastPhotoData = localStorage.getItem('lastPhotoData');
                    if (lastPhotoData) {
                        const photoData = JSON.parse(lastPhotoData);
                        scanId = photoData.scanId;
                        scanTimestamp = photoData.timestamp;
                        userPhoto = photoData.photoUrl;
                    }
                } catch (e) {

                }

                scanId = scanId || localStorage.getItem('current_scan_id') || `EMERGENCY-${Date.now()}`;
                scanTimestamp = scanTimestamp || localStorage.getItem('scan_timestamp') || new Date().toLocaleString('id-ID');
                imagePath = imagePath || localStorage.getItem('image_path') || 'N/A';
                userName = userName || localStorage.getItem('user_name') || 'User';
                userPhoto = userPhoto || localStorage.getItem('user_photo') || null;
                bodyTemperature = localStorage.getItem('body_temperature') || null;

                const response = await fetch(`${SERVER_URL}/send-emergency`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'Emergency Alert',
                        message: `Emergency button pressed - ${accidentType}`,
                        userName: userName,
                        userPhoto: userPhoto,
                        emergencyButtonPressed: true,
                        accidentType: accidentType, // CRITICAL: Ensure this is sent
                        scanId: scanId,
                        scanPhoto: userPhoto,
                        bodyTemperature: bodyTemperature,
                        location: {
                            latitude: EMERGENCY_LOCATION.latitude,
                            longitude: EMERGENCY_LOCATION.longitude
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                hideLoadingAlert();

                if (result.success) {
                    showSuccessAlert(result, accidentType);
                } else {
                    showErrorPopup(
                        ' Gagal Mengirim Emergency Alert!',
                        'Error: ' + (result.error || 'Unknown error') + '\n\n' +
                        'Pastikan:\n' +
                        '1. Telegram Bot sudah dikonfigurasi\n' +
                        '2. Backend server berjalan di port 3003\n' +
                        '3. Bot sudah ditambahkan ke grup emergency'
                    );
                }

            } catch (error) {
                hideLoadingAlert();
                showErrorPopup(
                    ' Terjadi Kesalahan!',
                    'Gagal mengirim emergency alert.\n' +
                    'Error: ' + error.message + '\n\n' +
                    'Pastikan backend server berjalan di port 3003.'
                );
            }
        }

        function showErrorPopup(title, message) {
            activePopup = 'error'; // Set popup active
            const overlay = document.getElementById('errorPopupOverlay');
            const titleEl = document.getElementById('errorPopupTitle');
            const messageEl = document.getElementById('errorPopupMessage');

            titleEl.textContent = title;
            messageEl.textContent = message;
            overlay.classList.add('active');

            const errorKeyHandler = function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                if (e.key === 'Escape' || e.key === 'Enter') {
                    closeErrorPopup();
                    document.removeEventListener('keydown', errorKeyHandler);
                }
            };

            document.addEventListener('keydown', errorKeyHandler);
        }

        function closeErrorPopup() {
            activePopup = null; // Clear popup state
            const overlay = document.getElementById('errorPopupOverlay');
            overlay.classList.remove('active');
        }

        function openEmergencyNumbersModal() {
            handleUserInteraction();
            if (typeof safeResetAutoRedirect === 'function') {
                safeResetAutoRedirect();
            }
            const modal = document.getElementById('emergencyNumbersModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';

                const emergencyModalKeyHandler = function (e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                        return;
                    }

                    const key = e.key;
                    const isNumber = /^[7]$/.test(key);

                    if (isNumber) {
                        const num = parseInt(key);
                        if (num === 7) {
                            e.preventDefault();
                            closeEmergencyNumbersModal();
                            document.removeEventListener('keydown', emergencyModalKeyHandler);
                        }
                        return;
                    }

                    if (e.key === 'Escape') {
                        closeEmergencyNumbersModal();
                        document.removeEventListener('keydown', emergencyModalKeyHandler);
                    }
                };

                document.addEventListener('keydown', emergencyModalKeyHandler);
                window.emergencyModalKeyHandler = emergencyModalKeyHandler;
            }
        }

        function closeEmergencyNumbersModal() {
            activePopup = null; // Clear popup state
            const modal = document.getElementById('emergencyNumbersModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            if (window.emergencyModalKeyHandler) {
                document.removeEventListener('keydown', window.emergencyModalKeyHandler);
                window.emergencyModalKeyHandler = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('emergencyNumbersModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeEmergencyNumbersModal();
                    }
                });
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('emergencyNumbersModal');
                if (modal && modal.classList.contains('active')) {
                    closeEmergencyNumbersModal();
                }
            }
        });

        async function sendSMSViaTwilio(toNumber, message, contactName = 'Unknown') {
            try {

                const twilioUrl = `https://api.twilio.com/2010-04-01/Accounts/${TWILIO_CONFIG.accountSid}/Messages.json`;

                const formData = new URLSearchParams();
                formData.append('To', toNumber);
                formData.append('From', TWILIO_CONFIG.phoneNumber);
                formData.append('Body', message);

                const response = await fetch(twilioUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(TWILIO_CONFIG.accountSid + ':' + TWILIO_CONFIG.authToken),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        success: true,
                        phone: toNumber,
                        contactName: contactName,
                        messageSid: data.sid,
                        data: data
                    };
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { message: errorText };
                    }

                    return {
                        success: false,
                        phone: toNumber,
                        contactName: contactName,
                        error: errorData,
                        statusCode: response.status
                    };
                }

            } catch (error) {
                return {
                    success: false,
                    phone: toNumber,
                    contactName: contactName,
                    error: { message: error.message, type: 'Network Error' }
                };
            }
        }

        function showLoadingAlert(message = 'Mengirim notifikasi darurat...') {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-alert';
            loadingDiv.innerHTML = `
                <div class="loading-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(25, 118, 210, 0.95);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    padding: 15px;
                ">
                    <div class="loading-card" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
                        padding: 40px;
                        border-radius: 20px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(25, 118, 210, 0.3);
                        border: 2px solid rgba(25, 118, 210, 0.1);
                        max-width: 400px;
                        width: 100%;
                    ">
                        <div class="loading-spinner" style="
                            width: 60px;
                            height: 60px;
                            border: 4px solid rgba(25, 118, 210, 0.2);
                            border-top: 4px solid #1976D2;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 25px;
                        "></div>
                        <div class="loading-message" style="
                            color: #1976D2;
                            font-size: 1.2rem;
                            font-weight: 600;
                            margin-bottom: 10px;
                        ">${message}</div>
                        <div class="loading-subtitle" style="
                            color: #1565C0;
                            font-size: 0.9rem;
                            opacity: 0.8;
                        ">Mohon tunggu sebentar...</div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    @media screen and (max-width: 480px) {
                        .loading-overlay {
                            padding: 10px !important;
                        }
                        
                        .loading-card {
                            padding: 30px 20px !important;
                            border-radius: 16px !important;
                        }
                        
                        .loading-spinner {
                            width: 50px !important;
                            height: 50px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .loading-message {
                            font-size: 1rem !important;
                            margin-bottom: 8px !important;
                        }
                        
                        .loading-subtitle {
                            font-size: 0.85rem !important;
                        }
                    }
                    
                    @media screen and (max-width: 360px) {
                        .loading-card {
                            padding: 25px 15px !important;
                        }
                        
                        .loading-message {
                            font-size: 0.95rem !important;
                        }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingAlert() {
            const el = document.getElementById('loading-alert');
            if (el) el.remove();
        }

        function showSuccessAlert(result, accidentType = 'other') {
            activePopup = 'success'; // Set popup active

            const typeNames = {
                'medical': 'Medis',
                'fire': 'Kebakaran',
                'crime': 'Kriminal',
                'accident': 'Kecelakaan',
                'other': 'Lainnya'
            };

            const typeIcons = {
                'medical': '',
                'fire': '',
                'crime': '',
                'accident': '',
                'other': ''
            };

            const typeName = typeNames[accidentType] || 'Lainnya';
            const typeIcon = typeIcons[accidentType] || '';

            const alertDiv = document.createElement('div');
            alertDiv.id = 'success-alert';
            alertDiv.innerHTML = `
                <div class="success-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(25, 118, 210, 0.95);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 15px;
                ">
                    <div class="success-card" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
                        padding: 40px;
                        border-radius: 20px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(25, 118, 210, 0.3);
                        border: 2px solid rgba(25, 118, 210, 0.1);
                        max-width: 500px;
                        width: 100%;
                        animation: slideIn 0.3s ease-out;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 25px;
                            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
                        ">
                            <i class="fas fa-check" style="font-size: 2.5rem; color: white;"></i>
                        </div>
                        <div class="success-title" style="
                            color: #1976D2;
                            font-size: 1.8rem;
                            font-weight: 700;
                            margin-bottom: 15px;
                        ">Emergency Alert Terkirim!</div>
                        <div class="success-subtitle" style="
                            color: #1565C0;
                            font-size: 1.1rem;
                            line-height: 1.6;
                            margin-bottom: 25px;
                        ">Notifikasi darurat telah berhasil dikirim ke semua petugas.</div>
                        <div class="success-info" style="
                            background: rgba(25, 118, 210, 0.1);
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 25px;
                            text-align: left;
                        ">
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Tipe Emergency:</span>
                                <span style="color: #1976D2; text-align: right;">${typeIcon} ${typeName}</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Telegram:</span>
                                <span style="color: #1976D2; text-align: right;">Pesan terkirim</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Grup:</span>
                                <span style="color: #1976D2; text-align: right;">Emergency Team</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Status:</span>
                                <span style="color: #1976D2; text-align: right;">Realtime (instant)</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Lokasi:</span>
                                <span style="color: #1976D2; text-align: right;">SMK MARHAS Margahayu</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Waktu:</span>
                                <span style="color: #1976D2; text-align: right;">${new Date().toLocaleString('id-ID')}</span>
                            </div>
                        </div>
                        <button onclick="hideSuccessAlert()" id="successAlertCloseBtn" data-shortcut="1" style="
                            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 12px;
                            font-size: 1.1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
                            position: relative;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(25, 118, 210, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(25, 118, 210, 0.3)'">
                            Tutup <span class="shortcut-badge" style="margin-left: 8px; background: rgba(255, 255, 255, 0.2); color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 600;">[1]</span>
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    @media screen and (max-width: 480px) {
                        .success-overlay {
                            padding: 10px !important;
                        }
                        
                        .success-card {
                            padding: 25px 20px !important;
                            border-radius: 16px !important;
                            max-height: 95vh !important;
                        }
                        
                        .success-card > div:first-child {
                            width: 60px !important;
                            height: 60px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .success-card > div:first-child i {
                            font-size: 2rem !important;
                        }
                        
                        .success-title {
                            font-size: 1.4rem !important;
                            margin-bottom: 12px !important;
                        }
                        
                        .success-subtitle {
                            font-size: 0.95rem !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .success-info {
                            padding: 15px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .info-row {
                            font-size: 0.85rem !important;
                            margin-bottom: 6px !important;
                            flex-wrap: wrap;
                        }
                        
                        .success-card button {
                            padding: 12px 25px !important;
                            font-size: 1rem !important;
                            width: 100%;
                        }
                    }
                    
                    @media screen and (max-width: 360px) {
                        .success-card {
                            padding: 20px 15px !important;
                        }
                        
                        .success-title {
                            font-size: 1.2rem !important;
                        }
                        
                        .success-subtitle {
                            font-size: 0.9rem !important;
                        }
                        
                        .info-row {
                            font-size: 0.8rem !important;
                        }
                    }
                </style>
            `;
            document.body.appendChild(alertDiv);

            const successKeyHandler = function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                const key = e.key;
                const isNumber = /^[1]$/.test(key);

                if (!isNumber) {

                    if (e.key === 'Escape') {
                        hideSuccessAlert();
                        document.removeEventListener('keydown', successKeyHandler);
                    }
                    return;
                }

                const num = parseInt(key);
                e.preventDefault();

                if (num === 1) {
                    hideSuccessAlert();
                    document.removeEventListener('keydown', successKeyHandler);
                }
            };

            document.addEventListener('keydown', successKeyHandler);
        }

        function hideSuccessAlert() {
            activePopup = null; // Clear popup state
            const el = document.getElementById('success-alert');
            if (el) el.remove();
        }

        let inactivityTimeout;
        let hasUserInteraction = false;
        const INITIAL_TIMEOUT = 60 * 1000; // 60 detik = 1 menit
        const EXTENDED_TIMEOUT = 5 * 60 * 1000; // 5 menit setelah ada interaksi

        function startInactivityTimer() {
            clearTimeout(inactivityTimeout);

            const timeoutDuration = hasUserInteraction ? EXTENDED_TIMEOUT : INITIAL_TIMEOUT;

            inactivityTimeout = setTimeout(() => {
                window.location.href = 'scan.html';
            }, timeoutDuration);
        }

        function handleUserInteraction() {
            if (!hasUserInteraction) {
                hasUserInteraction = true;
            }
            startInactivityTimer(); // Reset timer
        }

        const originalProceedEmergency = window.proceedWithEmergencyAlert;
        window.proceedWithEmergencyAlert = function (accidentType) {
            handleUserInteraction();
            if (originalProceedEmergency) return originalProceedEmergency(accidentType);
        };

        function startCountdown() {
            let secondsLeft = AUTO_REDIRECT_SECONDS;
            const countdownInterval = setInterval(() => {
                secondsLeft -= 60;
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 60000);
        }

        async function checkSystemStatus() {

            const statusElement = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');

            if (statusElement && statusText) {
                statusElement.style.display = 'flex';
                statusElement.className = 'system-status warning';
                statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengecek Telegram Bot server...';
            }

            try {

                const response = await fetch(`${SERVER_URL}/health`);
                if (!response.ok) {
                    throw new Error('Backend server tidak berjalan');
                }

                const telegramResponse = await fetch(`${SERVER_URL}/telegram-status`);
                const telegramData = await telegramResponse.json();

                if (telegramData.success) {

                    if (statusElement && statusText) {
                        statusElement.className = 'system-status ready';
                        statusText.innerHTML = '<i class="fas fa-check-circle"></i> Sistem siap untuk emergency alert';
                    }
                } else {
                    throw new Error('Telegram Bot tidak dikonfigurasi: ' + telegramData.error);
                }

            } catch (error) {

                if (statusElement && statusText) {
                    statusElement.className = 'system-status error';
                    statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Telegram Bot tidak dikonfigurasi';
                }
            }
        }

        const voiceAssistantButton = document.getElementById('voiceAssistantButton');
        const voiceAssistantStatus = document.getElementById('voiceAssistantStatus');
        const voiceAssistantStatusLabel = document.getElementById('voiceAssistantStatusLabel');
        const voiceAssistantStatusMessage = document.getElementById('voiceAssistantStatusMessage');
        const voiceAssistantTooltip = document.getElementById('voiceAssistantTooltip');
        const voiceAssistantTooltipClose = document.getElementById('voiceAssistantTooltipClose');
        const voiceAssistantPopover = document.getElementById('voiceAssistantPopover');
        const voiceAssistantPopoverClose = document.getElementById('voiceAssistantPopoverClose');
        const voiceAssistantConversation = document.getElementById('voiceAssistantConversation');

        let recognitionInstance = null;
        let speechSynthesisAPI = window.speechSynthesis;
        let currentUtterance = null;
        let isListening = false;
        let isProcessingAI = false;
        let hasGreetedUser = false;
        let assistantTooltipDismissed = false;
        let assistantTooltipTimer = null;
        let isStatusMinimized = false;
        let conversationHistory = [];

        function safeResetAutoRedirect() {
            if (typeof resetAutoRedirect === 'function') {
                resetAutoRedirect();
            }
        }

        function updateAssistantStatus(label, message, { show = true, highlight = false } = {}) {

            const labelText = label.replace(/<i[^>]*><\/i>/g, '').trim();
            voiceAssistantStatusLabel.innerHTML = `
                ${labelText}
                <i class="fas fa-chevron-up voice-assistant-status-toggle"></i>
            `;

            let formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**  <strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*  <em>
                .replace(/__(.*?)__/g, '<strong>$1</strong>')      // __bold__  <strong>
                .replace(/_(.*?)_/g, '<em>$1</em>')                // _italic_  <em>
                .replace(/\n/g, '<br>');                           // newline  <br>

            voiceAssistantStatusMessage.innerHTML = formattedMessage;

            if (show) {
                voiceAssistantStatus.classList.add('show');
            } else {
                voiceAssistantStatus.classList.remove('show');
            }
            if (highlight) {
                voiceAssistantStatus.classList.add('highlight');
            } else {
                voiceAssistantStatus.classList.remove('highlight');
            }
        }

        function showVoiceAssistantTooltip() {
            if (!assistantTooltipDismissed && voiceAssistantTooltip) {
                voiceAssistantTooltip.classList.add('show');
            }
        }

        function hideVoiceAssistantTooltip() {
            if (voiceAssistantTooltip) {
                voiceAssistantTooltip.classList.remove('show');
            }
        }

        function openVoiceAssistantPopover() {
            if (!voiceAssistantPopover) {
                return;
            }
            voiceAssistantPopover.classList.add('open');
            voiceAssistantPopover.setAttribute('aria-hidden', 'false');
        }

        function closeVoiceAssistantPopover() {
            if (!voiceAssistantPopover) {
                return;
            }
            voiceAssistantPopover.classList.remove('open');
            voiceAssistantPopover.setAttribute('aria-hidden', 'true');
        }

        function appendConversationEntry(type, text) {
            if (!voiceAssistantConversation) {
                return;
            }

            const placeholder = voiceAssistantConversation.querySelector('.voice-conversation-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const entry = document.createElement('div');
            entry.className = 'voice-conversation-entry';
            if (type === 'answer') {
                entry.classList.add('voice-conversation-answer');
            }

            const label = document.createElement('span');
            label.className = 'voice-label';
            label.textContent = type === 'question' ? 'Anda' : 'Asisten';

            const body = document.createElement('p');
            const lines = (text || '').split('\n');
            lines.forEach((line, index) => {
                body.appendChild(document.createTextNode(line.trim()));
                if (index < lines.length - 1) {
                    body.appendChild(document.createElement('br'));
                }
            });

            entry.appendChild(label);
            entry.appendChild(body);
            voiceAssistantConversation.appendChild(entry);
            voiceAssistantConversation.scrollTop = voiceAssistantConversation.scrollHeight;
        }

        function cancelSpeechIfSpeaking() {
            if (speechSynthesisAPI && (speechSynthesisAPI.speaking || speechSynthesisAPI.pending)) {
                speechSynthesisAPI.cancel();
            }
            currentUtterance = null;
        }

        function speakText(text) {
            if (!speechSynthesisAPI) {
                return;
            }

            cancelSpeechIfSpeaking();

            let cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Hapus ** untuk bold
                .replace(/\*(.*?)\*/g, '$1')      // Hapus * untuk italic
                .replace(/__(.*?)__/g, '$1')      // Hapus __ untuk bold
                .replace(/_(.*?)_/g, '$1')        // Hapus _ untuk italic
                .replace(/```.*?```/gs, '')       // Hapus code blocks
                .replace(/`(.*?)`/g, '$1')        // Hapus inline code
                .replace(/#{1,6}\s/g, '')         // Hapus # untuk headers
                .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Hapus links, simpan text
                .replace(/\n+/g, '. ')            // Replace newlines dengan pause
                .trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'id-ID';
            utterance.pitch = 1;
            utterance.rate = 1.25;
            utterance.volume = 1;
            utterance.onend = () => {
                currentUtterance = null;
                if (!isListening) {
                    updateAssistantStatus('Asisten Pertolongan Pertama', 'Tekan tombol mikrofon untuk mulai bertanya.');
                }
            };
            utterance.onerror = () => {
                currentUtterance = null;
            };
            currentUtterance = utterance;
            speechSynthesisAPI.speak(utterance);
        }

        function stopListening() {
            if (recognitionInstance && isListening) {
                recognitionInstance.stop();
            }
            isListening = false;
            voiceAssistantButton.classList.remove('listening');
            updateAssistantStatus('Asisten Pertolongan Pertama', 'Tekan tombol mikrofon untuk mulai bertanya.');
        }

        function handleUserQuery(queryText) {
            const cleanedQuery = (queryText || '').trim();

            if (!cleanedQuery) {
                const retryText = 'Maaf, saya tidak mendengar pertanyaan Anda. Tolong ulangi dengan suara yang lebih jelas.';
                updateAssistantStatus('Silakan ulangi', retryText);
                speakText(retryText);
                return;
            }

            updateAssistantStatus('Anda berkata', `"${cleanedQuery}"`);

            generateAIResponse(cleanedQuery);
        }

        async function generateAIResponse(userQuestion) {
            if (isProcessingAI) {
                return;
            }

            isProcessingAI = true;
            updateAssistantStatus('AI Sedang Berpikir', 'Memproses pertanyaan Anda...', { highlight: true });

            try {

                conversationHistory.push({
                    role: 'user',
                    content: userQuestion
                });

                const response = await fetch('/api/ai-assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: userQuestion,
                        conversationHistory: conversationHistory.slice(-10)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'AI response failed');
                }

                const aiAnswer = data.answer;

                conversationHistory.push({
                    role: 'assistant',
                    content: aiAnswer
                });

                if (conversationHistory.length > 10) {
                    conversationHistory.splice(0, conversationHistory.length - 10);
                }

                setTimeout(() => {
                    updateAssistantStatus('Asisten AI Menjawab', aiAnswer);
                    speakText(aiAnswer);
                }, 300);

                isProcessingAI = false;
            } catch (error) {
                const fallbackResponse = generateAssistantResponseFallback(userQuestion);
                updateAssistantStatus('Asisten Menjawab', fallbackResponse);
                speakText(fallbackResponse);
                isProcessingAI = false;
            }
        }

        function generateAssistantResponseFallback(query) {
            const lower = query.toLowerCase();

            const knowledgeBase = [
                {
                    keywords: ['pertolongan pertama', 'first aid', 'p3k', 'drsabc', 'drs abc'],
                    answer: `Langkah dasar pertolongan pertama mengikuti prinsip DRS ABC:
1. Danger: pastikan lokasi aman dari bahaya bagi Anda dan korban.
2. Response: panggil korban, tepuk bahu, lihat apakah ada respons.
3. Send for help: jika tidak respons, segera panggil bantuan (112 atau 119).
4. Airway: buka jalan napas dengan head tilt-chin lift.
5. Breathing: periksa napas selama 10 detik, lihat dada naik turun.
6. Circulation: bila tidak ada napas normal, mulai CPR atau gunakan AED bila tersedia.
Sambil menunggu bantuan, terus pantau kondisi korban dan jaga tetap hangat.`
                },
                {
                    keywords: ['luka', 'perdarahan', 'darah', 'bleeding'],
                    answer: `Penanganan perdarahan eksternal:
1. Cuci tangan atau gunakan sarung tangan jika tersedia.
2. Tekan langsung luka dengan kain/perban bersih selama minimal 10 menit.
3. Angkat bagian tubuh yang luka di atas jantung bila memungkinkan.
4. Jangan lepaskan tekanan untuk melihat luka; tambahkan perban jika darah merembes.
5. Jika perdarahan tidak berhenti atau luka dalam, segera bawa ke fasilitas medis.`
                },
                {
                    keywords: ['cpr', 'resusitasi', 'jantung'],
                    answer: `Langkah CPR dewasa (jika tidak bernapas normal):
1. Panggil bantuan, aktifkan 112/119 atau minta orang lain hubungi.
2. Posisikan korban telentang, lutut di samping dada.
3. Letakkan telapak tangan di tengah dada (tulang dada), tangan kedua di atasnya.
4. Tekan sedalam 56 cm dengan ritme 100120 kompresi per menit.
5. Jika terlatih, lakukan siklus 30 kompresi : 2 napas bantuan.
6. Lanjut sampai korban sadar, tim medis datang, atau Anda lelah.`
                },
                {
                    keywords: ['nomor darurat', 'telepon darurat', 'emergency call'],
                    answer: `Nomor layanan darurat nasional Indonesia:
 112  Layanan darurat terpadu (polisi, ambulans, pemadam kebakaran).
 119  Layanan gawat darurat medis.
 110  Polisi.
 113  Pemadam kebakaran.
 115  SAR/Basarnas.
 118  Ambulans (beberapa wilayah).`
                }
            ];

            const matched = knowledgeBase.find(item => item.keywords.some(keyword => lower.includes(keyword)));
            if (matched) {
                return matched.answer;
            }

            return 'Saya dapat membantu menjelaskan pertolongan pertama seperti menghentikan perdarahan, penanganan luka bakar, atau CPR. Silakan ajukan pertanyaan yang lebih spesifik agar saya bisa membantu dengan detail.';
        }

        function initialiseRecognition() {
            if (!SpeechRecognitionAPI) {
                voiceAssistantButton.classList.add('disabled');
                updateAssistantStatus('Perlu Browser Chrome', 'Browser Anda belum mendukung asisten suara.');
                return;
            }
            recognitionInstance = new SpeechRecognitionAPI();
            recognitionInstance.lang = 'id-ID';
            recognitionInstance.interimResults = false;
            recognitionInstance.maxAlternatives = 1;
            recognitionInstance.continuous = false;

            recognitionInstance.addEventListener('start', () => {
                isListening = true;
                voiceAssistantButton.classList.add('listening');
                updateAssistantStatus('Mendengarkan', 'Silakan bicara, saya siap membantu.');
            });

            recognitionInstance.addEventListener('result', (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join(' ');
                handleUserQuery(transcript);
            });

            recognitionInstance.addEventListener('end', () => {
                isListening = false;
                voiceAssistantButton.classList.remove('listening');
                safeResetAutoRedirect();
            });

            recognitionInstance.addEventListener('error', (event) => {
                let errorMessage = 'Terjadi kendala saat mendengarkan.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Izin mikrofon dibutuhkan.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Saya tidak mendengar suara.';
                }
                updateAssistantStatus('Asisten Pertolongan Pertama', errorMessage);
                speakText(errorMessage);
                stopListening();
            });
        }

        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateAssistantStatus('Error', 'Browser tidak mendukung Speech Recognition');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.lang = 'id-ID';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                console.log(' Speech recognition started');

                cancelSpeechIfSpeaking();

                isListening = true;
                voiceAssistantButton.classList.add('listening');
                updateAssistantStatus('Mendengarkan', 'Silakan bicara...', { highlight: true });
                updateAIVoiceCircle('listening');
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;

                if (aiVoicePopupOpen) {
                    addAISubtitle(transcript, 'user');
                }

                updateAssistantStatus('Anda berkata', `"${transcript}"`);

                isListening = false;
                voiceAssistantButton.classList.remove('listening');
                updateAIVoiceCircle('idle');

                updateAssistantStatus('Memproses', 'Tunggu sebentar...', { highlight: true });
                if (aiVoicePopupOpen) {
                    addAISubtitle('Tunggu sebentar...', 'system');
                }

                await handleUserQuery(transcript);
            };

            recognition.onerror = (event) => {
                isListening = false;
                voiceAssistantButton.classList.remove('listening');
                updateAIVoiceCircle('idle');

                let errorMessage = 'Terjadi kendala saat mendengarkan.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Izin mikrofon dibutuhkan.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Saya tidak mendengar suara.';
                }
                updateAssistantStatus('Error', errorMessage);
            };

            recognition.onend = () => {
                isListening = false;
                voiceAssistantButton.classList.remove('listening');
                updateAIVoiceCircle('idle');
            };

            return recognition;
        }

        function startListening() {
            if (isListening) {
                stopListening();
                return;
            }

            if (!recognitionInstance) {
                recognitionInstance = initializeSpeechRecognition();
                if (!recognitionInstance) {
                    return;
                }
            }

            try {
                recognitionInstance.start();
            } catch (error) {
                updateAssistantStatus('Error', 'Gagal memulai pengenalan suara.');
            }
        }

        function stopListening() {
            if (recognitionInstance && isListening) {
                recognitionInstance.stop();
            }
            isListening = false;
            voiceAssistantButton.classList.remove('listening');
            updateAIVoiceCircle('idle');
        }

        async function handleUserQuery(queryText) {
            const cleanedQuery = (queryText || '').trim();

            if (!cleanedQuery) {
                const retryText = 'Maaf, saya tidak mendengar pertanyaan Anda. Tolong ulangi dengan suara yang lebih jelas.';
                updateAssistantStatus('Silakan ulangi', retryText);
                speakText(retryText);
                return;
            }

            await generateAIResponse(cleanedQuery);
        }

        async function generateAIResponse(userQuestion) {
            if (isProcessingAI) {
                return;
            }

            isProcessingAI = true;
            updateAssistantStatus('AI Sedang Berpikir', 'Memproses pertanyaan Anda...', { highlight: true });

            try {

                conversationHistory.push({
                    role: 'user',
                    content: userQuestion
                });

                const response = await fetch('/api/ai-assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: userQuestion,
                        conversationHistory: conversationHistory.slice(-10)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'AI response failed');
                }

                const aiAnswer = data.answer;

                conversationHistory.push({
                    role: 'assistant',
                    content: aiAnswer
                });

                if (conversationHistory.length > 10) {
                    conversationHistory.splice(0, conversationHistory.length - 10);
                }

                if (aiVoicePopupOpen) {
                    addAISubtitle(aiAnswer, 'ai');
                }

                updateAssistantStatus('AI Menjawab', aiAnswer);

                speakText(aiAnswer);

            } catch (error) {
                const errorMessage = 'Maaf, terjadi kesalahan saat memproses pertanyaan Anda.';
                updateAssistantStatus('Error', errorMessage);
                speakText(errorMessage);
            } finally {
                isProcessingAI = false;
            }
        }

        function cancelSpeechIfSpeaking() {
            if (speechSynthesisAPI && (speechSynthesisAPI.speaking || speechSynthesisAPI.pending)) {
                speechSynthesisAPI.cancel();
            }
            currentUtterance = null;
        }

        function speakText(text) {
            if (!speechSynthesisAPI) {
                return;
            }

            cancelSpeechIfSpeaking();

            let cleanedText = text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')  // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')  // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')  // Transport and Map
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')  // Flags
                .replace(/[\u{2600}-\u{26FF}]/gu, '')    // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')    // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')  // Supplemental Symbols and Pictographs
                .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '')  // Chess Symbols
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // Symbols and Pictographs Extended-A

            let cleanText = cleanedText
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Remove ** for bold
                .replace(/\*(.*?)\*/g, '$1')      // Remove * for italic
                .replace(/__(.*?)__/g, '$1')      // Remove __ for bold
                .replace(/_(.*?)_/g, '$1')        // Remove _ for italic
                .replace(/```.*?```/gs, '')       // Remove code blocks
                .replace(/`(.*?)`/g, '$1')        // Remove inline code
                .replace(/#{1,6}\s/g, '')         // Remove # for headers
                .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Remove links, keep text
                .replace(/\n+/g, '. ')            // Replace newlines with pause
                .trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'id-ID';
            utterance.pitch = 1;
            utterance.rate = 1.4; // 1.4x speed (lebih cepat)
            utterance.volume = 1;

            utterance.onstart = () => {
                updateAIVoiceCircle('speaking');
            };

            utterance.onend = () => {
                currentUtterance = null;
                updateAIVoiceCircle('idle');
                if (!isListening) {
                    updateAssistantStatus('Asisten Pertolongan Pertama', 'Tekan tombol mikrofon untuk mulai bertanya.');
                }
            };

            utterance.onerror = () => {
                currentUtterance = null;
                updateAIVoiceCircle('idle');
            };

            currentUtterance = utterance;
            speechSynthesisAPI.speak(utterance);
        }

        let aiVoicePopupOpen = false;
        let aiVoiceSubtitleHistory = [];
        let aiPopupKeyHandler = null; // Global variable untuk key handler

        function openAIVoicePopup() {
            activePopup = 'ai-voice'; // Set popup active
            const popup = document.getElementById('aiVoicePopup');
            if (popup) {
                popup.style.display = 'flex';
                aiVoicePopupOpen = true;
                document.body.style.overflow = 'hidden';

                const bubbles = popup.querySelectorAll('.ai-voice-bubble');
                if (bubbles.length === 0) {
                    for (let i = 0; i < 4; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'ai-voice-bubble';
                        popup.appendChild(bubble);
                    }
                }

                if (aiPopupKeyHandler) {
                    document.removeEventListener('keydown', aiPopupKeyHandler);
                    aiPopupKeyHandler = null;
                }

                aiPopupKeyHandler = function (e) {

                    if (!aiVoicePopupOpen || activePopup !== 'ai-voice') {
                        return;
                    }

                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                        return;
                    }

                    const key = e.key;
                    const isNumber = /^[1-2]$/.test(key);

                    if (isNumber) {
                        const num = parseInt(key);
                        e.preventDefault();

                        switch (num) {
                            case 1:

                                closeAIVoicePopup();
                                break;
                            case 2:

                                toggleAIVoiceListening();
                                break;
                        }
                        return;
                    }

                    if (e.key === 'Escape') {
                        closeAIVoicePopup();
                    }
                };

                document.addEventListener('keydown', aiPopupKeyHandler);
            }
        }

        function closeAIVoicePopup() {
            activePopup = null; // Clear popup state

            cancelSpeechIfSpeaking();

            const popup = document.getElementById('aiVoicePopup');
            if (popup) {
                popup.style.display = 'none';
                aiVoicePopupOpen = false;
                document.body.style.overflow = '';

                if (isListening) {
                    stopListening();
                }

                if (aiPopupKeyHandler) {
                    document.removeEventListener('keydown', aiPopupKeyHandler);
                    aiPopupKeyHandler = null;
                }
            }
        }

        function toggleAIVoiceListening() {
            if (isListening) {

                stopListening();
            } else {

                startListening();
            }
        }

        function addAISubtitle(text, type = 'ai') {
            const subtitleContent = document.getElementById('aiVoiceSubtitle');
            if (!subtitleContent) return;

            const placeholder = subtitleContent.querySelector('.ai-subtitle-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            let cleanedText = text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')  // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')  // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')  // Transport and Map
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')  // Flags
                .replace(/[\u{2600}-\u{26FF}]/gu, '')    // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')    // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')  // Supplemental Symbols and Pictographs
                .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '')  // Chess Symbols
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // Symbols and Pictographs Extended-A

            let formattedText = cleanedText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**  <strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic*  <em>
                .replace(/__(.*?)__/g, '<strong>$1</strong>')      // __bold__  <strong>
                .replace(/_(.*?)_/g, '<em>$1</em>')                // _italic_  <em>
                .replace(/\n/g, '<br>');                           // newline  <br>

            const lastEntry = subtitleContent.lastElementChild;
            if (lastEntry && !lastEntry.classList.contains('ai-subtitle-placeholder')) {
                const lastType = lastEntry.classList.contains('ai-subtitle-user') ? 'user' : 'ai';
                if (lastType === type) {

                    lastEntry.innerHTML += formattedText;
                } else {

                    const subtitleEntry = document.createElement('p');
                    subtitleEntry.className = type === 'user' ? 'ai-subtitle-user' : 'ai-subtitle-ai';
                    subtitleEntry.innerHTML = formattedText;
                    subtitleContent.appendChild(subtitleEntry);
                }
            } else {

                const subtitleEntry = document.createElement('p');
                subtitleEntry.className = type === 'user' ? 'ai-subtitle-user' : 'ai-subtitle-ai';
                subtitleEntry.innerHTML = formattedText;
                subtitleContent.appendChild(subtitleEntry);
            }

            subtitleContent.scrollTop = subtitleContent.scrollHeight;

            aiVoiceSubtitleHistory.push({ text, type, timestamp: Date.now() });
            if (aiVoiceSubtitleHistory.length > 50) {
                aiVoiceSubtitleHistory.shift();
            }
        }

        function updateAIVoiceCircle(state) {
            const circle = document.getElementById('aiVoiceCircle');
            const icon = document.getElementById('aiVoiceIcon');
            const controlBtn = document.getElementById('aiVoiceControlBtn');

            if (!circle) return;

            circle.classList.remove('listening', 'speaking');
            if (icon) icon.className = 'fas fa-microphone';
            if (controlBtn) {
                controlBtn.classList.remove('listening', 'speaking');

                const span = controlBtn.querySelector('span');
                if (span) {
                    span.innerHTML = 'Mulai Berbicara <span class="shortcut-hint" style="margin-left: 8px; font-size: 11px; opacity: 0.8;">[2]</span>';
                }
            }

            if (state === 'listening') {
                circle.classList.add('listening');
                if (icon) icon.className = 'fas fa-stop';
                if (controlBtn) {
                    controlBtn.classList.add('listening');
                    const span = controlBtn.querySelector('span');
                    if (span) {
                        span.innerHTML = 'Berhenti Mendengarkan <span class="shortcut-hint" style="margin-left: 8px; font-size: 11px; opacity: 0.8;">[2]</span>';
                    }
                }
            } else if (state === 'speaking') {
                circle.classList.add('speaking');
                if (icon) icon.className = 'fas fa-volume-up';
                if (controlBtn) {
                    controlBtn.classList.add('speaking');
                    const span = controlBtn.querySelector('span');
                    if (span) {
                        span.innerHTML = 'AI Sedang Berbicara... <span class="shortcut-hint" style="margin-left: 8px; font-size: 11px; opacity: 0.8;">[2]</span>';
                    }
                }
            }
        }

        voiceAssistantButton.addEventListener('click', async () => {
            safeResetAutoRedirect();
            hideVoiceAssistantTooltip();
            assistantTooltipDismissed = true;

            openAIVoicePopup();
        });

        if (voiceAssistantTooltipClose) {
            voiceAssistantTooltipClose.addEventListener('click', () => {
                assistantTooltipDismissed = true;
                hideVoiceAssistantTooltip();
            });
        }

        if (voiceAssistantPopoverClose) {
            voiceAssistantPopoverClose.addEventListener('click', () => {
                closeVoiceAssistantPopover();
            });
        }

        const voiceAssistantWrapper = document.querySelector('.voice-assistant-wrapper');

        document.addEventListener('click', (event) => {
            if (!voiceAssistantPopover || !voiceAssistantPopover.classList.contains('open')) {
                return;
            }
            if (voiceAssistantWrapperContains(event.target)) {
                return;
            }
            closeVoiceAssistantPopover();
        });

        function voiceAssistantWrapperContains(target) {
            if (!voiceAssistantWrapper) {
                return false;
            }
            return voiceAssistantWrapper.contains(target);
        }

        assistantTooltipTimer = setTimeout(() => {
            showVoiceAssistantTooltip();
        }, 1800);

        if (voiceAssistantStatus) {
            voiceAssistantStatus.addEventListener('click', (e) => {

                if (e.target.closest('.voice-assistant-button')) {
                    return;
                }

                isStatusMinimized = !isStatusMinimized;
                if (isStatusMinimized) {
                    voiceAssistantStatus.classList.add('minimized');
                } else {
                    voiceAssistantStatus.classList.remove('minimized');
                }
            });
        }

        const settingsBtn = document.getElementById('settingsBtn');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsClose = document.getElementById('settingsClose');

        function openSettings() {
            settingsSidebar.classList.add('active');
            settingsOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSettings() {
            settingsSidebar.classList.remove('active');
            settingsOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        settingsBtn.addEventListener('click', openSettings);
        settingsClose.addEventListener('click', closeSettings);
        settingsOverlay.addEventListener('click', closeSettings);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsSidebar.classList.contains('active')) {
                closeSettings();
            }
        });

        let autoRedirectTimer = null;
        const AUTO_REDIRECT_TIME = 3 * 60 * 1000; // 3 menit dalam milliseconds

        function startAutoRedirect() {

            if (autoRedirectTimer) {
                clearTimeout(autoRedirectTimer);
            }

            autoRedirectTimer = setTimeout(() => {

                window.location.href = 'scan.html';
            }, AUTO_REDIRECT_TIME);
        }

        function resetAutoRedirect() {
            startAutoRedirect();
        }

        ['click', 'touchstart', 'mousemove', 'keypress', 'scroll'].forEach(event => {
            document.addEventListener(event, resetAutoRedirect, { passive: true });
        });

        startAutoRedirect();

        function displayUserIdentity() {
            const userName = localStorage.getItem('user_name');
            const userNik = localStorage.getItem('user_nik');
            const userId = localStorage.getItem('user_id');
            const isGuest = localStorage.getItem('is_guest') === 'true';
            const accessType = localStorage.getItem('access_type');

            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeSubtitle = document.getElementById('welcomeSubtitle');
            const userIdentity = document.getElementById('userIdentity');
            const userNameEl = document.getElementById('userName');
            const userBadge = document.getElementById('userBadge');
            const userIcon = document.getElementById('userIcon');

            if (!userId || !userName || accessType === 'unknown' || userName.trim() === '') {

                localStorage.removeItem('user_id');
                localStorage.removeItem('user_name');
                localStorage.removeItem('user_nik');
                localStorage.removeItem('is_guest');
                localStorage.removeItem('access_type');

                welcomeTitle.textContent = 'Selamat Datang!';
                welcomeSubtitle.textContent = 'Pilih layanan darurat yang Anda butuhkan';
                if (userIdentity) userIdentity.style.display = 'none';
                return;
            }

            if (userName && userId) {

                welcomeTitle.textContent = `Selamat Datang, ${userName}!`;

                if (isGuest) {

                    userIdentity.style.display = 'block';
                    userIdentity.style.background = 'rgba(220, 38, 38, 0.1)';
                    userIcon.className = 'fas fa-exclamation-triangle';
                    userIcon.style.color = '#dc2626';
                    userNameEl.textContent = userName;
                    userNameEl.style.color = '#dc2626';
                    userBadge.innerHTML = '<i class="fas fa-shield-alt"></i> Mode Emergency - Akses Penuh';
                    userBadge.style.color = '#991b1b';
                } else {

                    userIdentity.style.display = 'block';
                    userIdentity.style.background = 'rgba(5, 150, 105, 0.1)';
                    userIcon.className = 'fas fa-user-check';
                    userIcon.style.color = '#059669';
                    userNameEl.textContent = userName;
                    userNameEl.style.color = '#059669';
                    userBadge.innerHTML = userNik ? `NIK: ${userNik}` : 'User Terdaftar';
                    userBadge.style.color = '#065f46';
                }
            } else {

                welcomeTitle.textContent = 'Selamat Datang!';
                welcomeSubtitle.textContent = 'Pilih layanan darurat yang Anda butuhkan';
                if (userIdentity) userIdentity.style.display = 'none';
            }
        }

        function showShortcutPopup() {
            const popup = document.getElementById('shortcutPopup');
            if (popup) {
                popup.style.display = 'flex';
            }
        }

        function closeShortcutPopup() {
            const popup = document.getElementById('shortcutPopup');
            if (popup) {
                popup.style.display = 'none';
            }
        }

        let activePopup = null; // 'emergency-type', 'confirm', 'success', 'error', 'emergency-call', 'service', 'ai-voice'

        function isAnyPopupActive() {
            return activePopup !== null;
        }

        document.addEventListener('keydown', function (e) {

            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }

            if (isAnyPopupActive()) {
                return; // Let popup handle its own shortcuts
            }

            const key = e.key.toLowerCase();
            const isNumber = /^[1-9]$/.test(e.key);

            if (isNumber) {
                const num = parseInt(e.key);
                e.preventDefault();

                switch (num) {
                    case 1:

                        const emergencyBtn = document.getElementById('emergencyButton');
                        if (emergencyBtn) {
                            showShortcutPopup();
                            setTimeout(() => {
                                sendEmergencyAlert();
                                closeShortcutPopup();
                            }, 500);
                        }
                        break;
                    case 2:

                        openEmergencyNumbersModal();
                        break;
                    case 3:

                        openServicePopup();
                        break;
                    case 4:

                        const voiceBtn = document.querySelector('.voice-assistant-button');
                        if (voiceBtn && !voiceBtn.classList.contains('disabled')) {
                            voiceBtn.click();
                        }
                        break;
                }
                return;
            }

            switch (key) {
                case 'v':

                    e.preventDefault();
                    const voiceButton = document.querySelector('.voice-assistant-button');
                    if (voiceButton && !voiceButton.classList.contains('disabled')) {
                        voiceButton.click();
                    }
                    break;
            }
        });

        window.onload = () => {
            displayUserIdentity();
            startInactivityTimer(); // Mulai timer inactivity
            startCountdown();
            checkSystemStatus();
            startAutoRedirect(); // Mulai auto redirect timer
            initKioskMode(); // Initialize Kiosk Mode

            document.querySelectorAll('button, a, .menu-item').forEach(element => {
                element.addEventListener('click', handleUserInteraction);
            });
        };
    </script>

    <div class="kiosk-password-modal" id="kioskPasswordModal">
        <div class="kiosk-password-content">
            <div class="kiosk-password-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="kiosk-password-title">Keluar dari Kiosk Mode</h2>
            <p class="kiosk-password-description">
                Masukkan password untuk keluar dari mode layar penuh dan mengakses kontrol browser.
            </p>
            <input type="password" class="kiosk-password-input" id="kioskPasswordInput" placeholder="Masukkan Password"
                maxlength="20">
            <div class="kiosk-password-error" id="kioskPasswordError">
                <i class="fas fa-exclamation-circle"></i> Password salah! Silakan coba lagi.
            </div>
            <div class="kiosk-password-buttons">
                <button class="kiosk-btn kiosk-btn-cancel" id="kioskCancelBtn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="kiosk-btn kiosk-btn-submit" id="kioskSubmitBtn">
                    <i class="fas fa-check"></i> Keluar
                </button>
            </div>
        </div>
    </div>

    <script>

        const SUPABASE_URL = 'https://fvayuhanwcwinkvvvisk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2YXl1aGFud2N3aW5rdnZ2aXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDk1NTYsImV4cCI6MjA3NTQ4NTU1Nn0.AP0ZYsrUQ1ACD7fmX1wTM88_zzMtvyKXmgc9wCVvRrM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isKioskModeActive = false;
        let kioskPasswordFromDB = null;
        let kioskActionType = null; // 'enter' atau 'exit'

        async function loadKioskPassword() {
            try {

                const { data, error } = await supabase
                    .from('kiosk_settings')
                    .select('password')
                    .eq('id', 1)
                    .single();

                if (error) throw error;

                if (data && data.password) {
                    kioskPasswordFromDB = data.password;
                } else {

                    kioskPasswordFromDB = 'smkmarhas2025';
                }
            } catch (error) {

                kioskPasswordFromDB = 'smkmarhas2025';
            }
        }

        function initKioskMode() {

            loadKioskPassword();

            document.addEventListener('keydown', preventF11);

            document.addEventListener('contextmenu', (e) => e.preventDefault());

            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);

            const enterKioskBtn = document.getElementById('enterKioskModeBtn');
            if (enterKioskBtn) {
                enterKioskBtn.addEventListener('click', () => {
                    kioskActionType = 'enter';
                    showPasswordModal('Masuk Kiosk Mode', 'Masukkan password untuk mengaktifkan mode layar penuh.');
                });
            }

            const exitKioskBtn = document.getElementById('exitKioskModeBtn');
            if (exitKioskBtn) {
                exitKioskBtn.addEventListener('click', () => {
                    kioskActionType = 'exit';
                    showPasswordModal('Keluar dari Kiosk Mode', 'Masukkan password untuk keluar dari mode layar penuh.');
                });
            }

            const kioskPasswordModal = document.getElementById('kioskPasswordModal');
            const kioskPasswordInput = document.getElementById('kioskPasswordInput');
            const kioskSubmitBtn = document.getElementById('kioskSubmitBtn');
            const kioskCancelBtn = document.getElementById('kioskCancelBtn');
            const kioskPasswordError = document.getElementById('kioskPasswordError');

            kioskSubmitBtn.addEventListener('click', async () => {
                const password = kioskPasswordInput.value;

                if (await verifyKioskPassword(password)) {
                    if (kioskActionType === 'enter') {
                        enterKioskModeWithPassword();
                    } else if (kioskActionType === 'exit') {
                        exitKioskModeWithPassword();
                    }
                    hidePasswordModal();
                    kioskPasswordInput.value = '';
                    kioskPasswordError.classList.remove('show');
                } else {

                    kioskPasswordInput.classList.add('error');
                    kioskPasswordError.classList.add('show');
                    setTimeout(() => {
                        kioskPasswordInput.classList.remove('error');
                    }, 500);
                    kioskPasswordInput.value = '';
                    kioskPasswordInput.focus();
                }
            });

            kioskCancelBtn.addEventListener('click', hidePasswordModal);

            kioskPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    kioskSubmitBtn.click();
                }
            });

            kioskPasswordModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hidePasswordModal();
                }
            });
        }

        function enterFullscreen() {
            const elem = document.documentElement;

            const options = {
                navigationUI: "hide" // Hide browser navigation UI
            };

            if (elem.requestFullscreen) {
                elem.requestFullscreen(options).then(() => {
                    applyKioskStyles();
                }).catch(err => {

                    tryAlternativeFullscreen();
                });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                applyKioskStyles();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
                applyKioskStyles();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
                applyKioskStyles();
            } else {

                tryAlternativeFullscreen();
            }
        }

        function tryAlternativeFullscreen() {

            document.body.style.position = 'fixed';
            document.body.style.top = '0';
            document.body.style.left = '0';
            document.body.style.width = '100vw';
            document.body.style.height = '100vh';
            document.body.style.overflow = 'hidden';
            document.body.style.zIndex = '999999';
            applyKioskStyles();
        }

        function applyKioskStyles() {

            document.documentElement.classList.add('kiosk-fullscreen');
            document.body.classList.add('kiosk-fullscreen');

            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';

            document.documentElement.style.width = '100vw';
            document.documentElement.style.height = '100vh';

            disableAdminMenuItems();
        }

        function removeKioskStyles() {
            document.documentElement.classList.remove('kiosk-fullscreen');
            document.body.classList.remove('kiosk-fullscreen');
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            document.documentElement.style.width = '';
            document.documentElement.style.height = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.width = '';
            document.body.style.height = '';
            document.body.style.zIndex = '';

            enableAdminMenuItems();
        }

        function exitFullscreen() {
            removeKioskStyles();

            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        function preventF11(e) {

            if (e.key === 'F11' && isKioskModeActive) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }

            if (e.key === 'Escape' && isKioskModeActive) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        function handleFullscreenChange() {

            const isFullscreen = document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;

            if (!isFullscreen && isKioskModeActive) {

                showToast(
                    ' Fullscreen Keluar',
                    'Fullscreen mode keluar. Silakan klik "Masuk Kiosk Mode" untuk masuk kembali.',
                    'info',
                    5000
                );

                isKioskModeActive = false;
                localStorage.removeItem('kiosk_mode_active');
                removeKioskStyles();
            }
        }

        async function verifyKioskPassword(inputPassword) {
            if (!kioskPasswordFromDB) {
                await loadKioskPassword();
            }
            return inputPassword === kioskPasswordFromDB;
        }

        let toastTimeout;

        function showToast(title, message, type = 'info', duration = 5000) {
            const toast = document.getElementById('toastNotification');
            const toastTitle = toast.querySelector('.toast-title');
            const toastMessage = toast.querySelector('.toast-message');
            const toastIcon = toast.querySelector('.toast-icon i');

            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }

            toast.classList.remove('success', 'error', 'info', 'show');

            toastTitle.textContent = title;
            toastMessage.innerHTML = message.replace(/\n/g, '<br>');

            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else {
                toastIcon.className = 'fas fa-info-circle';
            }

            toast.classList.add(type);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            toastTimeout = setTimeout(() => {
                hideToast();
            }, duration);
        }

        function hideToast() {
            const toast = document.getElementById('toastNotification');
            toast.classList.remove('show');

            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
        }

        function disableAdminMenuItems() {
            const adminPanelItem = document.getElementById('adminPanelItem');
            const emergencyDashboardItem = document.getElementById('emergencyDashboardItem');

            if (adminPanelItem) {
                adminPanelItem.classList.add('disabled');
                adminPanelItem.style.cursor = 'not-allowed';
            }

            if (emergencyDashboardItem) {
                emergencyDashboardItem.classList.add('disabled');
                emergencyDashboardItem.style.cursor = 'not-allowed';
            }
        }

        function enableAdminMenuItems() {
            const adminPanelItem = document.getElementById('adminPanelItem');
            const emergencyDashboardItem = document.getElementById('emergencyDashboardItem');

            if (adminPanelItem) {
                adminPanelItem.classList.remove('disabled');
                adminPanelItem.style.cursor = 'pointer';
            }

            if (emergencyDashboardItem) {
                emergencyDashboardItem.classList.remove('disabled');
                emergencyDashboardItem.style.cursor = 'pointer';
            }
        }

        function navigateToAdminPanel() {
            const adminPanelItem = document.getElementById('adminPanelItem');
            if (adminPanelItem && !adminPanelItem.classList.contains('disabled')) {
                window.location.href = 'login-admin.html';
            }
        }

        function navigateToEmergencyDashboard() {
            const emergencyDashboardItem = document.getElementById('emergencyDashboardItem');
            if (emergencyDashboardItem && !emergencyDashboardItem.classList.contains('disabled')) {
                window.location.href = 'login-emergency.html';
            }
        }

        function enterKioskModeWithPassword() {
            isKioskModeActive = true;

            localStorage.setItem('kiosk_mode_active', 'true');

            enterFullscreen();

            setTimeout(() => {
                const message = ` Kiosk Mode aktif!\n\n` +
                    ` Layar penuh diaktifkan.\n\n` +
                    ` Tips untuk full screen sempurna:\n` +
                    ` Tekan F11 sebelum masuk kiosk mode untuk hide browser UI\n` +
                    ` Atau gunakan Chrome Kiosk Mode: chrome.exe --kiosk\n` +
                    ` Taskbar Windows dapat di-hide via Settings`;
                showToast(' Kiosk Mode Aktif', message, 'success', 8000);
            }, 500);
        }

        function exitKioskModeWithPassword() {
            isKioskModeActive = false;

            localStorage.removeItem('kiosk_mode_active');

            exitFullscreen();
            showToast(' Kiosk Mode Dinonaktifkan', ' Kiosk Mode dinonaktifkan. Anda sekarang dapat mengakses kontrol browser.', 'info', 5000);
        }

        function showPasswordModal(title, description) {
            const modal = document.getElementById('kioskPasswordModal');
            const input = document.getElementById('kioskPasswordInput');
            const error = document.getElementById('kioskPasswordError');
            const modalTitle = document.querySelector('.kiosk-password-title');
            const modalDesc = document.querySelector('.kiosk-password-description');
            const submitBtn = document.getElementById('kioskSubmitBtn');

            if (modalTitle) modalTitle.textContent = title;
            if (modalDesc) modalDesc.textContent = description;

            if (kioskActionType === 'enter') {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Aktifkan';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Keluar';
            }

            modal.classList.add('active');
            error.classList.remove('show');
            input.value = '';

            const settingsSidebar = document.getElementById('settingsSidebar');
            if (settingsSidebar) {
                settingsSidebar.classList.remove('active');
            }

            setTimeout(() => {
                input.focus();
            }, 300);
        }

        function hidePasswordModal() {
            const modal = document.getElementById('kioskPasswordModal');
            const input = document.getElementById('kioskPasswordInput');
            const error = document.getElementById('kioskPasswordError');

            modal.classList.remove('active');
            error.classList.remove('show');
            input.value = '';
        }
    </script>

    <div class="toast-notification" id="toastNotification">
        <div class="toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">Notification</div>
            <div class="toast-message">Message content</div>
        </div>
        <button class="toast-close" onclick="hideToast()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>

        let serviceSocket = null;
        let servicePopupInitialized = false;

        function openServicePopup() {
            activePopup = 'service'; // Set popup active
            const popup = document.getElementById('servicePopup');
            const popupContent = document.getElementById('servicePopupContent');

            if (!popup || !popupContent) return;

            popup.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            if (!servicePopupInitialized) {
                loadServiceContent(popupContent);
                servicePopupInitialized = true;
            }

            const servicePopupKeyHandler = function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                const key = e.key;
                const isNumber = /^[8]$/.test(key);

                if (isNumber) {
                    const num = parseInt(key);
                    if (num === 8) {
                        e.preventDefault();
                        closeServicePopup();
                        document.removeEventListener('keydown', servicePopupKeyHandler);
                    }
                    return;
                }

                if (e.key === 'Escape') {
                    closeServicePopup();
                    document.removeEventListener('keydown', servicePopupKeyHandler);
                }
            };

            document.addEventListener('keydown', servicePopupKeyHandler);
            window.servicePopupKeyHandler = servicePopupKeyHandler;
        }

        function closeServicePopup() {
            activePopup = null; // Clear popup state
            const popup = document.getElementById('servicePopup');
            if (!popup) return;

            popup.style.display = 'none';
            document.body.style.overflow = '';

            if (window.servicePopupKeyHandler) {
                document.removeEventListener('keydown', window.servicePopupKeyHandler);
                window.servicePopupKeyHandler = null;
            }

            if (serviceSocket) {
                serviceSocket.disconnect();
                serviceSocket = null;
            }

            if (window.servicePopupKeyHandler) {
                document.removeEventListener('keydown', window.servicePopupKeyHandler);
                window.servicePopupKeyHandler = null;
            }
        }

        function loadServiceContent(container) {
            container.innerHTML = `
                <div class="service-chat-wrapper" style="display: flex; flex-direction: column; height: 100%; width: 100%;">
                    <div class="service-chat-header-controls">
                        <div class="service-online-status">
                            <div class="service-status-dot" id="serviceStatusDot"></div>
                            <span id="serviceOnlineCount">0 online</span>
                        </div>
                    </div>
                    <div class="service-chat-messages" id="serviceChatMessages" style="flex: 1; overflow-y: auto;"></div>
                    <div class="service-typing-indicator" id="serviceTypingIndicator" style="display: none;">
                        <span id="serviceTypingUser"></span>
                        <div class="service-typing-dots">
                            <div class="service-typing-dot"></div>
                            <div class="service-typing-dot"></div>
                            <div class="service-typing-dot"></div>
                        </div>
                    </div>
                    <div class="service-chat-input-container" style="display: block !important; position: fixed; bottom: 0; left: 0; right: 0; z-index: 99999; padding: 16px 20px; background: white; border-top: 2px solid #e5e7eb; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); min-height: 80px;">
                        <div class="service-shortcut-hint">
                            <i class="fas fa-info-circle"></i>
                            <span>Klik <span class="shortcut-key">8</span> untuk kembali</span>
                        </div>
                        <form class="service-chat-input-form" id="serviceChatForm" onsubmit="return false;" style="display: flex !important; gap: 12px; align-items: flex-end;">
                            <textarea class="service-chat-input" id="serviceMessageInput" placeholder="Ketik pesan..." rows="1" autocomplete="off" autocorrect="off" autocapitalize="sentences" spellcheck="true" inputmode="text" enterkeyhint="send" style="display: block !important; flex: 1; padding: 12px 16px; border: 2px solid #d1d5db; border-radius: 20px; font-size: 16px; resize: none; min-height: 48px; max-height: 120px; -webkit-appearance: none; touch-action: manipulation;"></textarea>
                            <button type="button" class="service-chat-btn service-btn-send" id="serviceSendButton" style="display: flex !important; align-items: center; justify-content: center; min-width: 48px; height: 48px; background: #3b82f6; color: white; border: none; border-radius: 50%; cursor: pointer; flex-shrink: 0;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            `;

            setTimeout(() => {
                initializeServiceChat();
            }, 100);
        }

        function initializeServiceChat() {
            serviceSocket = io(SERVER_URL);

            const chatMessages = document.getElementById('serviceChatMessages');
            const messageInput = document.getElementById('serviceMessageInput');
            const chatForm = document.getElementById('serviceChatForm');

            if (messageInput) {

                messageInput.addEventListener('focus', function() {
                    setTimeout(() => {
                        messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });

                messageInput.addEventListener('touchstart', function() {
                    this.focus();
                }, { passive: true });

                setTimeout(() => {
                    messageInput.focus();
                }, 500);
            }
            const onlineCount = document.getElementById('serviceOnlineCount');
            const statusDot = document.getElementById('serviceStatusDot');
            const typingIndicator = document.getElementById('serviceTypingIndicator');
            const typingUser = document.getElementById('serviceTypingUser');

            let currentUser = { name: 'User_' + Math.floor(Math.random() * 1000), role: 'user' };
            let isTyping = false;
            let typingTimeout = null;

            serviceSocket.on('connect', () => {
                if (statusDot) statusDot.style.backgroundColor = '#4CAF50';
                serviceSocket.emit('join-chat', currentUser);
            });

            serviceSocket.on('disconnect', () => {
                if (statusDot) statusDot.style.backgroundColor = '#f44336';
            });

            serviceSocket.on('user-joined', (data) => {
                addServiceSystemMessage(`${data.user.name} bergabung`);
                if (onlineCount) onlineCount.textContent = `${data.onlineCount} online`;
            });

            serviceSocket.on('user-left', (data) => {
                addServiceSystemMessage(`${data.user.name} keluar`);
                if (onlineCount) onlineCount.textContent = `${data.onlineCount} online`;
            });

            serviceSocket.on('online-users', (users) => {
                if (onlineCount) onlineCount.textContent = `${users.length} online`;
            });

            serviceSocket.on('chat-history', (messages) => {
                messages.forEach(message => addServiceMessage(message, currentUser.name));
            });

            serviceSocket.on('new-message', (message) => {
                addServiceMessage(message, currentUser.name);
            });

            serviceSocket.on('user-typing', (data) => {
                if (typingUser) typingUser.textContent = `${data.userName} sedang mengetik...`;
                if (typingIndicator) typingIndicator.style.display = 'flex';
            });

            serviceSocket.on('user-stop-typing', () => {
                if (typingIndicator) typingIndicator.style.display = 'none';
            });

            function addServiceMessage(message, currentUserName) {
                if (!chatMessages) return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `service-message ${message.userName === currentUserName ? 'service-message-own' : 'service-message-other'}`;
                const time = new Date(message.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                messageDiv.innerHTML = `
                    <div class="service-message-sender">${escapeHtml(message.userName)}</div>
                    <div class="service-message-text">${escapeHtml(message.text)}</div>
                    <div class="service-message-time">${time}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addServiceSystemMessage(message) {
                if (!chatMessages) return;
                const messageDiv = document.createElement('div');
                messageDiv.className = 'service-message service-message-system';
                messageDiv.innerHTML = `<div class="service-message-content">${escapeHtml(message)}</div>`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function sendServiceMessage() {
                if (!messageInput) return;
                const message = messageInput.value.trim();
                if (!message) return;
                serviceSocket.emit('send-message', { text: message });
                messageInput.value = '';
                messageInput.style.height = 'auto';
                if (isTyping) {
                    isTyping = false;
                    serviceSocket.emit('stop-typing');
                }
            }

            if (chatForm) {
                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sendServiceMessage();
                    return false;
                });
            }

            const sendButton = document.getElementById('serviceSendButton');
            if (sendButton) {
                sendButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sendServiceMessage();
                    return false;
                });
            }

            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        e.stopPropagation();
                        sendServiceMessage();
                        return false;
                    }
                });

                messageInput.addEventListener('input', () => {
                    if (messageInput) {
                        messageInput.style.height = 'auto';
                        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    }
                    if (!isTyping) {
                        isTyping = true;
                        serviceSocket.emit('typing');
                    }
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        if (isTyping) {
                            isTyping = false;
                            serviceSocket.emit('stop-typing');
                        }
                    }, 1000);
                });
            }
        }

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const popup = document.getElementById('servicePopup');
                if (popup && popup.style.display !== 'none') {
                    closeServicePopup();
                }
            }
        });

        displayUserIdentity();

        function generateVoiceBubbles() {
            const bubblesContainer = document.getElementById('voiceBubblesContainer');
            if (!bubblesContainer) return;

            bubblesContainer.innerHTML = '';

            const animations = ['floatUp1', 'floatUp2', 'floatDiagonal1', 'floatDiagonal2', 'floatCircular', 'floatWave'];

            const colors = [
                'rgba(59, 130, 246, 0.3)',   // Blue
                'rgba(147, 51, 234, 0.3)',   // Purple
                'rgba(6, 182, 212, 0.3)',    // Cyan
                'rgba(99, 102, 241, 0.3)',   // Indigo
                'rgba(168, 85, 247, 0.3)',   // Violet
                'rgba(14, 165, 233, 0.3)',   // Sky blue
                'rgba(139, 92, 246, 0.3)',   // Purple-blue
                'rgba(34, 211, 238, 0.3)'    // Light cyan
            ];

            const bubbleCount = 10;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'voice-bubble';

                const size = Math.random() * 60 + 20;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;

                const color = colors[Math.floor(Math.random() * colors.length)];
                bubble.style.background = color;

                const startX = Math.random() * 100; // 0-100%
                const startY = Math.random() * 100 + 20; // 20-120% (some start below visible area)
                bubble.style.left = `${startX}%`;
                bubble.style.top = `${startY}%`;

                const animation = animations[Math.floor(Math.random() * animations.length)];
                const duration = Math.random() * 10 + 8; // 8-18 seconds
                const delay = Math.random() * 3; // 0-3 seconds delay

                bubble.style.animation = `${animation} ${duration}s ease-in-out ${delay}s infinite`;

                bubblesContainer.appendChild(bubble);
            }
        }

        generateVoiceBubbles();

        function generateAiVoicePopupBubbles() {
            const bubblesContainer = document.getElementById('aiVoiceBubblesContainer');
            if (!bubblesContainer) return;

            bubblesContainer.innerHTML = '';

            const animations = ['floatUp1', 'floatUp2', 'floatDiagonal1', 'floatDiagonal2', 'floatCircular', 'floatWave'];

            const colors = [
                'rgba(37, 99, 235, 0.4)',    // Blue 600
                'rgba(29, 78, 216, 0.4)',    // Blue 700
                'rgba(59, 130, 246, 0.4)',   // Blue 500
                'rgba(96, 165, 250, 0.4)',   // Blue 400
                'rgba(147, 197, 253, 0.4)',  // Blue 300
                'rgba(30, 64, 175, 0.4)',    // Blue 800
                'rgba(191, 219, 254, 0.4)',  // Blue 200
                'rgba(23, 37, 84, 0.3)'      // Blue 950
            ];

            const bubbleCount = 15;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'ai-voice-bubble';

                const size = Math.random() * 70 + 30;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;

                const color = colors[Math.floor(Math.random() * colors.length)];
                bubble.style.background = color;

                const startX = Math.random() * 100; // 0-100%
                const startY = Math.random() * 100 + 20; // 20-120%
                bubble.style.left = `${startX}%`;
                bubble.style.top = `${startY}%`;

                const animation = animations[Math.floor(Math.random() * animations.length)];

                const duration = Math.random() * 4 + 4;

                const delay = Math.random() * 2; // 0-2s delay

                bubble.style.animation = `${animation} ${duration}s linear ${delay}s infinite`;

                bubblesContainer.appendChild(bubble);
            }
        }

        generateAiVoicePopupBubbles();
    </script>
</body>

</html>