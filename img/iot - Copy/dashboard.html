<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dashboard - Emergency Hotline System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load Emergency Configuration -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            color: #1a1a1a;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dashboard-main {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100vw;
        }

        .voice-assistant-wrapper {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 14px;
            z-index: 250;
        }

        .voice-assistant-status {
            max-width: 300px;
            background: rgba(59, 130, 246, 0.92);
            color: #fff;
            padding: 14px 16px;
            border-radius: 14px;
            font-size: 14px;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.35);
            display: none;
            backdrop-filter: blur(6px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 245;
        }

        .voice-assistant-status.show {
            display: block;
        }

        .voice-assistant-status.highlight {
            background: rgba(239, 68, 68, 0.96);
            box-shadow: 0 16px 36px rgba(239, 68, 68, 0.45);
        }

        .voice-assistant-status.minimized {
            max-width: 200px;
            padding: 10px 14px;
        }

        .voice-assistant-status.minimized strong {
            margin-bottom: 0;
        }

        .voice-assistant-status.minimized p {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-top: 0;
        }

        .voice-assistant-status strong {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.85;
            margin-bottom: 6px;
            transition: margin-bottom 0.3s ease;
        }

        .voice-assistant-status-toggle {
            font-size: 16px;
            opacity: 0.7;
            transition: transform 0.3s ease, opacity 0.2s ease;
        }

        .voice-assistant-status:hover .voice-assistant-status-toggle {
            opacity: 1;
        }

        .voice-assistant-status.minimized .voice-assistant-status-toggle {
            transform: rotate(180deg);
        }

        .voice-assistant-status p {
            margin: 0;
            line-height: 1.4;
            font-weight: 500;
            max-height: 300px;
            opacity: 1;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            padding-right: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        /* Scrollbar styling untuk pop-up */
        .voice-assistant-status p::-webkit-scrollbar {
            width: 6px;
        }
        
        .voice-assistant-status p::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .voice-assistant-status p::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .voice-assistant-status p::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .voice-assistant-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 18px 30px rgba(37, 99, 235, 0.35);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .voice-assistant-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 22px 38px rgba(37, 99, 235, 0.45);
        }

        .voice-assistant-button:active {
            transform: scale(0.96);
        }

        .voice-assistant-button .fa-microphone {
            font-size: 24px;
        }

        .voice-assistant-button.listening {
            animation: pulseGlow 1.2s infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 18px 30px rgba(239, 68, 68, 0.4);
        }

        .voice-assistant-button.disabled {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 18px 30px rgba(239, 68, 68, 0.3);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 24px 42px rgba(239, 68, 68, 0.5);
            }
        }

        @media (max-width: 640px) {
            .voice-assistant-wrapper {
                right: 16px;
                bottom: 18px;
            }

            .voice-assistant-button {
                width: 56px;
                height: 56px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 20px;
            }

            .voice-assistant-status {
                max-width: 200px;
                font-size: 12px;
                padding: 10px 12px;
            }

            .voice-assistant-status strong {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .voice-assistant-status p {
                font-size: 11px;
                line-height: 1.3;
                max-height: 200px;
                overflow-y: auto;
            }
        }

        .voice-assistant-tooltip {
            position: absolute;
            bottom: 88px;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.45;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.32);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            max-width: 260px;
            z-index: 255;
        }

        .voice-assistant-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .voice-assistant-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 18px;
            border-width: 8px;
            border-style: solid;
            border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
        }

        .voice-assistant-tooltip i {
            margin-top: 2px;
            color: #38bdf8;
        }

        .voice-tooltip-close {
            margin-left: auto;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.65);
            cursor: pointer;
            padding: 0;
            font-size: 12px;
            transition: color 0.2s ease;
        }

        .voice-tooltip-close:hover {
            color: #fff;
        }

        @media (max-width: 640px) {
            .voice-assistant-tooltip {
                max-width: 180px;
                font-size: 11px;
                padding: 8px 10px;
                bottom: 70px;
                gap: 6px;
            }

            .voice-assistant-tooltip::after {
                right: 14px;
                border-width: 6px;
            }
        }

        @media (max-width: 480px) {
            .voice-assistant-tooltip {
                max-width: 160px;
                font-size: 10px;
                padding: 6px 8px;
                bottom: 64px;
            }
        }

        @media (max-width: 400px) {
            .voice-assistant-tooltip {
                max-width: 140px;
                font-size: 9px;
                bottom: 60px;
            }
        }

        .voice-assistant-popover {
            position: absolute;
            bottom: 96px;
            right: 0;
            width: 320px;
            max-height: 420px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 22px 48px rgba(15, 23, 42, 0.25);
            padding: 18px;
            display: none;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(226, 232, 240, 0.7);
            z-index: 260;
        }

        .voice-assistant-popover.open {
            display: flex;
        }

        .voice-popover-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }

        .voice-popover-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
        }

        .voice-popover-header p {
            margin: 6px 0 0;
            font-size: 13px;
            color: #475569;
            line-height: 1.45;
        }

        .voice-popover-close {
            margin-left: auto;
            background: rgba(15, 23, 42, 0.05);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .voice-popover-close:hover {
            background: rgba(15, 23, 42, 0.12);
            color: #111827;
        }

        .voice-conversation-log {
            flex: 1;
            min-height: 160px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .voice-conversation-log::-webkit-scrollbar {
            width: 6px;
        }

        .voice-conversation-log::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 6px;
        }

        .voice-conversation-entry {
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(226, 232, 240, 0.7);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-conversation-entry .voice-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #2563eb;
            display: block;
            margin-bottom: 4px;
        }

        .voice-conversation-answer .voice-label {
            color: #0f172a;
        }

        .voice-conversation-entry p {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            color: #1e293b;
        }

        .voice-conversation-placeholder {
            background: rgba(59, 130, 246, 0.08);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            color: #1d4ed8;
            font-size: 13px;
            border: 1px dashed rgba(37, 99, 235, 0.4);
        }

        .voice-conversation-placeholder i {
            display: block;
            font-size: 20px;
            margin-bottom: 6px;
        }

        @media (max-width: 640px) {
            .voice-assistant-popover {
                width: calc(100vw - 32px);
                right: 16px;
                bottom: 92px;
            }

            .voice-assistant-tooltip {
                max-width: 220px;
            }
        }

        @media (max-width: 480px) {
            .voice-assistant-wrapper {
                right: 12px;
                bottom: 12px;
            }

            .voice-assistant-button {
                width: 52px;
                height: 52px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 18px;
            }

            .voice-assistant-status {
                max-width: 170px;
                font-size: 11px;
                padding: 8px 10px;
            }

            .voice-assistant-status strong {
                font-size: 10px;
                margin-bottom: 3px;
            }

            .voice-assistant-status p {
                font-size: 10px;
                line-height: 1.25;
                max-height: 180px;
                overflow-y: auto;
            }

            .voice-assistant-status.minimized {
                max-width: 140px;
                padding: 6px 8px;
            }

            .voice-assistant-status-toggle {
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            .voice-assistant-wrapper {
                right: 10px;
                bottom: 10px;
            }

            .voice-assistant-button {
                width: 48px;
                height: 48px;
            }

            .voice-assistant-button .fa-microphone {
                font-size: 16px;
            }

            .voice-assistant-status {
                max-width: 150px;
                font-size: 10px;
                padding: 7px 9px;
            }

            .voice-assistant-status strong {
                font-size: 9px;
            }

            .voice-assistant-status p {
                font-size: 9px;
                max-height: 150px;
                overflow-y: auto;
            }

            .voice-assistant-status.minimized {
                max-width: 120px;
                padding: 5px 7px;
            }
        }

        .app-header {
            width: 100%;
            background: #3b82f6;
            padding: 48px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .app-brand-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 14px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            max-width: 90%;
        }

        .app-logo {
            height: 56px;
            width: auto;
            object-fit: contain;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.025em;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-section h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .welcome-section p {
            font-size: 16px;
            color: #6b7280;
            font-weight: 400;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 500px;
            align-items: center;
            justify-content: center;
        }

        .red-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 40px;
            background: #dc2626;
            color: white;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            letter-spacing: -0.025em;
            width: 100%;
        }

        .red-btn::before {
            display: none;
        }

        .red-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .red-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .red-btn i {
            margin-right: 12px;
            font-size: 22px;
        }

        .emergency-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 32px;
            background: #3b82f6;
            color: white;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            letter-spacing: -0.025em;
            width: 100%;
        }

        .emergency-btn::before {
            display: none;
        }

        .emergency-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .emergency-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .emergency-btn i {
            margin-right: 8px;
            font-size: 18px;
        }

        .emergency-btn-service {
            background: #10b981 !important;
        }

        .emergency-btn-service:hover {
            background: #059669 !important;
        }

        .emergency-btn-admin {
            background: #dc2626 !important;
        }

        .emergency-btn-admin:hover {
            background: #b91c1c !important;
        }

        /* Settings Button */
        .settings-btn {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 20px;
            position: absolute;
            right: 24px;
            z-index: 10;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* Settings Sidebar */
        .settings-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-sidebar.active {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .settings-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .settings-content {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .settings-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .settings-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .settings-item-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .settings-item-icon.red {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }

        .settings-item-icon.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .settings-item-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .settings-item-content p {
            font-size: 13px;
            color: #6b7280;
        }

        .settings-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 24px 0;
        }

        .settings-info {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .settings-info-icon {
            color: #d97706;
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .settings-info-content {
            flex: 1;
        }

        .settings-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 6px;
        }

        .settings-info p {
            font-size: 13px;
            color: #78350f;
            line-height: 1.5;
        }

        /* Custom Popup Styles */
        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }

        .custom-popup {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            text-align: center;
            animation: slideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .popup-icon {
            display: none;
        }

        .popup-title {
            color: #0f172a;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .popup-message {
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            letter-spacing: -0.01em;
        }

        .popup-btn-confirm {
            background: #dc2626;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .popup-btn-confirm:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .popup-btn-cancel {
            background: #f3f4f6;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .popup-btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive popup */
        @media screen and (max-width: 768px) {
            .custom-popup {
                padding: 30px 20px;
                margin: 20px;
            }

            .popup-icon {
                width: 60px;
                height: 60px;
            }

            .popup-icon i {
                font-size: 2rem;
            }

            .popup-title {
                font-size: 1.5rem;
            }

            .popup-message {
                font-size: 1rem;
            }

            .popup-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .popup-btn {
                width: 100%;
            }
        }

        /* ===== KIOSK MODE / FULL SCREEN LOCK ===== */
        .kiosk-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            backdrop-filter: blur(10px);
        }

        .kiosk-password-modal.active {
            display: flex;
        }

        .kiosk-password-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: kioskSlideIn 0.4s ease-out;
        }

        @keyframes kioskSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .kiosk-password-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .kiosk-password-icon i {
            font-size: 36px;
            color: white;
        }

        .kiosk-password-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .kiosk-password-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .kiosk-password-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
            text-align: center;
            letter-spacing: 4px;
            font-weight: 600;
        }

        .kiosk-password-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .kiosk-password-input.error {
            border-color: #ef4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .kiosk-password-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: -12px;
            margin-bottom: 16px;
            display: none;
        }

        .kiosk-password-error.show {
            display: block;
        }

        .kiosk-password-buttons {
            display: flex;
            gap: 12px;
        }

        .kiosk-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .kiosk-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .kiosk-btn-cancel:hover {
            background: #e5e7eb;
        }

        .kiosk-btn-submit {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .kiosk-btn-submit:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .settings-item-icon.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .footer {
            width: 100%;
            background: #3b82f6;
            padding: 16px 20px;
            text-align: center;
            color: #ffffff;
            font-size: 14px;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
        }

        .system-status {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .system-status.ready {
            background: #d1fae5;
            border-color: #6ee7b7;
            color: #065f46;
        }

        .system-status.warning {
            background: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }

        .system-status.error {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        /* ===== TOAST NOTIFICATION (No Alert Popups) ===== */
        .toast-notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000000;
            min-width: 300px;
            max-width: 500px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #3b82f6;
        }

        .toast-notification.show {
            display: flex;
        }

        .toast-notification.success {
            border-left-color: #10b981;
        }

        .toast-notification.success .toast-icon {
            color: #10b981;
        }

        .toast-notification.error {
            border-left-color: #ef4444;
        }

        .toast-notification.error .toast-icon {
            color: #ef4444;
        }

        .toast-notification.info {
            border-left-color: #3b82f6;
        }

        .toast-notification.info .toast-icon {
            color: #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .toast-message {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #4b5563;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast-notification.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        @media (max-width: 640px) {
            .toast-notification {
                bottom: 20px;
                right: 20px;
                left: 20px;
                min-width: auto;
                max-width: none;
            }
        }

        /* ===== KIOSK FULLSCREEN MODE ===== */
        html.kiosk-fullscreen,
        body.kiosk-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }

        html.kiosk-fullscreen {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%) !important;
        }

        .kiosk-fullscreen .dashboard-main {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }

        /* Hide scrollbars in kiosk mode */
        .kiosk-fullscreen::-webkit-scrollbar {
            display: none !important;
        }

        .kiosk-fullscreen {
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        @media screen and (max-width: 768px) {
            .app-logo {
                height: 40px;
            }

            .app-title {
                font-size: 16px;
            }

            .app-header {
                padding: 24px 16px;
            }

            .app-brand-container {
                padding: 10px 16px;
                gap: 8px;
            }

            .welcome-section h1 {
                font-size: 24px;
            }

            .welcome-section p {
                font-size: 14px;
            }

            .red-btn {
                font-size: 16px;
                padding: 18px 32px;
            }

            .emergency-btn {
                font-size: 14px;
                padding: 14px 24px;
            }

            .content-area {
                padding: 24px 16px;
            }
        }

        @media screen and (max-width: 480px) {
            .app-logo {
                height: 36px;
            }

            .app-title {
                font-size: 14px;
            }

            .app-header {
                padding: 20px 12px;
            }

            .app-brand-container {
                padding: 8px 12px;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .welcome-section {
                margin-bottom: 24px;
            }

            .welcome-section h1 {
                font-size: 20px;
            }

            .welcome-section p {
                font-size: 13px;
            }

            .red-btn {
                font-size: 15px;
                padding: 16px 28px;
            }

            .emergency-btn {
                font-size: 13px;
                padding: 12px 20px;
            }

            .content-area {
                padding: 20px 12px;
            }

            .footer {
                padding: 12px 16px;
                font-size: 12px;
            }
        }

        /* Custom Error Popup */
        .error-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .error-popup-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-popup-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .error-popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .error-popup-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }

        .error-popup-message {
            font-size: 15px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
            text-align: left;
            white-space: pre-line;
        }

        .error-popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Android 7.1.2 Specific (360x640 typical) */
        @media screen and (max-width: 400px) {
            .app-header {
                padding: 16px 8px;
            }

            .app-brand-container {
                padding: 6px 10px;
                gap: 6px;
                max-width: 95%;
            }

            .app-logo {
                height: 32px;
            }

            .app-title {
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .welcome-section h1 {
                font-size: 18px;
            }

            .welcome-section p {
                font-size: 12px;
            }

            .red-btn {
                font-size: 14px;
                padding: 14px 24px;
                width: 100%;
                max-width: 280px;
            }

            .emergency-btn {
                font-size: 12px;
                padding: 10px 18px;
                width: 100%;
                max-width: 280px;
            }
        }

        /* Landscape orientation */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .app-header {
                padding: 32px 20px;
            }

            .app-logo {
                height: 40px;
            }

            .app-title {
                font-size: 16px;
            }

            .content-area {
                padding: 20px 16px;
            }

            .welcome-section {
                margin-bottom: 20px;
            }

            .welcome-section h1 {
                font-size: 20px;
            }

            .welcome-section p {
                font-size: 13px;
            }

            .red-btn {
                padding: 16px 28px;
                font-size: 16px;
            }

            .emergency-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Error Popup Overlay -->
    <div class="error-popup-overlay" id="errorPopupOverlay">
        <div class="error-popup-content">
            <div class="error-popup-icon" id="errorPopupIcon">❌</div>
            <div class="error-popup-title" id="errorPopupTitle">Error</div>
            <div class="error-popup-message" id="errorPopupMessage"></div>
            <button class="error-popup-btn" onclick="closeErrorPopup()">OK</button>
        </div>
    </div>

    <div class="dashboard-main">
        <div class="app-header">
            <div class="app-brand-container">
                <img src="./img/logo.png" alt="EHS Logo" class="app-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="logo-fallback" style="display:none; font-size: 2rem; color: #e74c3c;">🚨</div>
                <div class="app-title">Emergency Hotline System</div>
            </div>
            <button class="settings-btn" id="settingsBtn" title="Pengaturan">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <div class="content-area">
            <div class="welcome-section">
                <h1 id="welcomeTitle">Selamat Datang!</h1>
                <p id="welcomeSubtitle">Pilih layanan darurat yang Anda butuhkan</p>
                <div id="userIdentity" style="margin-top: 16px; padding: 12px 20px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                        <i id="userIcon" class="fas fa-user" style="color: #3b82f6;"></i>
                        <div style="text-align: left;">
                            <div id="userName" style="font-weight: 600; color: #1f2937; font-size: 16px;"></div>
                            <div id="userBadge" style="font-size: 12px; color: #6b7280; margin-top: 4px;"></div>
                        </div>
                    </div>
                </div>
                <div id="systemStatus" class="system-status" style="margin-top: 20px; padding: 10px; border-radius: 8px; font-size: 0.9rem; display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="statusText">Checking system status...</span>
                </div>
            </div>

            <div class="button-container">
                <button class="red-btn" onclick="sendEmergencyAlert()">
                    <i class="fas fa-hand-paper"></i>
                    <span>TEKAN UNTUK MEMANGGIL</span>
                </button>

                <a href="emergency-numbers.html" class="emergency-btn">
                    <i class="fas fa-phone-volume"></i>
                    <span>EMERGENCY CALL</span>
                </a>

                <a href="service.html" class="emergency-btn emergency-btn-service">
                    <i class="fas fa-comments"></i>
                    <span>SERVICE</span>
                </a>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 Emergency Hotline System. All rights reserved.</p>
        </div>
    </div>

    <!-- Voice Assistant UI -->
    <div class="voice-assistant-wrapper" aria-live="polite">
        <div class="voice-assistant-tooltip" id="voiceAssistantTooltip">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Butuh bantuan cepat?</strong>
                <p>Jika ingin bertanya untuk penanganan medis, tekan tombol mikrofon ini.</p>
            </div>
            <button type="button" class="voice-tooltip-close" id="voiceAssistantTooltipClose" aria-label="Tutup petunjuk">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="voice-assistant-popover" id="voiceAssistantPopover" aria-hidden="true" role="dialog">
            <div class="voice-popover-header">
                <div>
                    <h3>Asisten Pertolongan Pertama</h3>
                    <p>Tekan tombol mikrofon, ajukan pertanyaan, dan dengarkan panduan langkah demi langkah.</p>
                </div>
                <button class="voice-popover-close" id="voiceAssistantPopoverClose" type="button" aria-label="Tutup asisten">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="voice-conversation-log" id="voiceAssistantConversation">
                <div class="voice-conversation-placeholder">
                    <i class="fas fa-headset"></i>
                    <p>Mulai percakapan dengan menekan mikrofon. Pertanyaan dan jawaban akan muncul di sini.</p>
                </div>
            </div>
        </div>
        <div class="voice-assistant-status" id="voiceAssistantStatus">
            <strong id="voiceAssistantStatusLabel">
                Asisten Pertolongan Pertama
                <i class="fas fa-chevron-up voice-assistant-status-toggle"></i>
            </strong>
            <p id="voiceAssistantStatusMessage">Tekan tombol mikrofon untuk mulai bertanya.</p>
        </div>
        <button id="voiceAssistantButton" class="voice-assistant-button" type="button" aria-label="Asisten suara pertolongan pertama">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay"></div>

    <!-- Settings Sidebar -->
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-header">
            <h2>
                <i class="fas fa-cog"></i>
                Pengaturan
            </h2>
            <button class="settings-close" id="settingsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="settings-content">
            <!-- Admin Section -->
            <div class="settings-section">
                <div class="settings-section-title">Administrator</div>
                
                <a href="login-admin.html" class="settings-item" style="text-decoration: none; color: inherit;">
                    <div class="settings-item-icon red">
                        <i class="fas fa-shield-halved"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Admin Panel</h3>
                        <p>Akses dashboard administrator</p>
                    </div>
                </a>
            </div>

            <div class="settings-divider"></div>

            <!-- Emergency Responder Section -->
            <div class="settings-section">
                <div class="settings-section-title">Emergency Response</div>
                
                <a href="login-emergency.html" class="settings-item" style="text-decoration: none; color: inherit;">
                    <div class="settings-item-icon orange">
                        <i class="fas fa-truck-medical"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Emergency Dashboard</h3>
                        <p>Monitor & tangani kasus darurat</p>
                    </div>
                </a>
            </div>

            <div class="settings-divider"></div>

            <!-- Kiosk Mode Exit Section -->
            <div class="settings-section">
                <div class="settings-section-title">Kiosk Mode</div>
                
                <div class="settings-item" id="enterKioskModeBtn" style="cursor: pointer;">
                    <div class="settings-item-icon green">
                        <i class="fas fa-expand"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Masuk Kiosk Mode</h3>
                        <p>Aktifkan mode layar penuh (perlu password)</p>
                    </div>
                </div>

                <div class="settings-item" id="exitKioskModeBtn" style="cursor: pointer;">
                    <div class="settings-item-icon purple">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="settings-item-content">
                        <h3>Keluar dari Kiosk Mode</h3>
                        <p>Keluar dari mode layar penuh (perlu password)</p>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <!-- Info Section -->
            <div class="settings-info">
                <div class="settings-info-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="settings-info-content">
                    <h4>Auto Redirect</h4>
                    <p>Halaman ini akan otomatis kembali ke scan wajah setelah 3 menit untuk keamanan.</p>
                </div>
            </div>

            <!-- Version Info -->
            <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 12px; color: #9ca3af;">Emergency Hotline System</p>
                <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Version 2.0.0 - October 2025</p>
            </div>
        </div>
    </div>

    <script>
        // ===== KONFIGURASI DARI FILE EKSTERNAL =====
        // Konfigurasi Emergency untuk Telegram Bot
        
        // Konfigurasi Emergency Contacts untuk Telegram Bot
        const EMERGENCY_CONTACTS = [
            { name: 'Petugas Utama', phone: '+628814554581' },
            { name: 'Petugas Backup 1', phone: '+6288362272732' },
            { name: 'Petugas Backup 2', phone: '+6288647356283' }
        ];
        
        // Konfigurasi Lokasi Emergency
        const EMERGENCY_LOCATION = {
            name: 'SMK MARHAS Margahayu',
            address: 'Jl. Raya Margahayu No.186, Margahayu, Kec. Margahayu, Kabupaten Bandung, Jawa Barat',
            latitude: -6.9759367,
            longitude: 107.5704834,
            googleMaps: 'https://maps.app.goo.gl/iUSHhmnRQdGKwj8x8'
        };
        // Konfigurasi Message Template
        const MESSAGE_TEMPLATE = {
            title: '🚨 NOTIFIKASI DARURAT 🚨',
            footer: 'Pesan otomatis dari Emergency Hotline System - Kiosk SMK MARHAS Margahayu'
        };
        
        // Konfigurasi Auto Redirect (15 menit = 900 detik)
        const AUTO_REDIRECT_SECONDS = 900;

        // Fungsi untuk menampilkan popup konfirmasi custom
        function showCustomConfirm(title, message, onConfirm, onCancel) {
            const overlay = document.createElement('div');
            overlay.className = 'custom-popup-overlay';
            overlay.innerHTML = `
                <div class="custom-popup">
                    <div class="popup-title">${title}</div>
                    <div class="popup-message">${message}</div>
                    <div class="popup-buttons">
                        <button class="popup-btn popup-btn-confirm" onclick="handleConfirm()">
                            Ya, Lanjutkan
                        </button>
                        <button class="popup-btn popup-btn-cancel" onclick="handleCancel()">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Fungsi untuk handle confirm
            window.handleConfirm = function() {
                document.body.removeChild(overlay);
                delete window.handleConfirm;
                delete window.handleCancel;
                if (onConfirm) onConfirm();
            };
            
            // Fungsi untuk handle cancel
            window.handleCancel = function() {
                document.body.removeChild(overlay);
                delete window.handleConfirm;
                delete window.handleCancel;
                if (onCancel) onCancel();
            };
            
            // Close popup saat klik overlay
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    window.handleCancel();
                }
            });
        }

        // Fungsi untuk mengirim Emergency Alert via Telegram Bot
        async function sendEmergencyAlert() {
            // Tampilkan dialog pemilihan tipe emergency
            showEmergencyTypeDialog();
        }

        // Fungsi untuk menampilkan dialog pemilihan tipe emergency
        function showEmergencyTypeDialog() {
            const overlay = document.createElement('div');
            overlay.id = 'emergency-type-overlay';
            overlay.innerHTML = `
                <div class="emergency-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(4px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                    box-sizing: border-box;
                ">
                    <div class="emergency-dialog" style="
                        background: #fff;
                        border-radius: 12px;
                        max-width: 420px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                        animation: slideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                    ">
                        <div class="emergency-header" style="
                            padding: 24px 24px 16px;
                            border-bottom: 1px solid #f1f5f9;
                        ">
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">Jenis Keadaan Darurat</h2>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #64748b;">Pilih kategori yang sesuai</p>
                        </div>
                        
                        <div class="emergency-body" style="padding: 20px 24px 24px;">
                            <div class="emergency-type-grid" style="
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 12px;
                                margin-bottom: 20px;
                            ">
                                <button class="emergency-type-btn" data-type="medical" style="
                                    background: #fff;
                                    color: #dc2626;
                                    border: 1.5px solid #fecaca;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-heartbeat" style="font-size: 24px;"></i>
                                    <span>Medis</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="fire" style="
                                    background: #fff;
                                    color: #ea580c;
                                    border: 1.5px solid #fed7aa;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-fire-alt" style="font-size: 24px;"></i>
                                    <span>Kebakaran</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="crime" style="
                                    background: #fff;
                                    color: #2563eb;
                                    border: 1.5px solid #bfdbfe;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-shield-alt" style="font-size: 24px;"></i>
                                    <span>Kriminal</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="accident" style="
                                    background: #fff;
                                    color: #7c3aed;
                                    border: 1.5px solid #ddd6fe;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-car-crash" style="font-size: 24px;"></i>
                                    <span>Kecelakaan</span>
                                </button>
                                
                                <button class="emergency-type-btn" data-type="other" style="
                                    background: #fff;
                                    color: #475569;
                                    border: 1.5px solid #e2e8f0;
                                    border-radius: 8px;
                                    padding: 18px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 8px;
                                    grid-column: span 2;
                                ">
                                    <i class="fas fa-ellipsis-h" style="font-size: 24px;"></i>
                                    <span>Lainnya</span>
                                </button>
                            </div>
                            
                            <button class="cancel-btn" onclick="closeEmergencyTypeDialog()" style="
                                width: 100%;
                                background: #f8fafc;
                                color: #64748b;
                                border: 1px solid #e2e8f0;
                                border-radius: 8px;
                                padding: 12px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                                transition: all 0.2s;
                            ">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    .emergency-type-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                    }
                    
                    .emergency-type-btn:active {
                        transform: translateY(0);
                    }

                    .cancel-btn:hover {
                        background: #f1f5f9;
                        border-color: #cbd5e1;
                    }
                    
                    /* Responsive untuk mobile */
                    @media screen and (max-width: 480px) {
                        .emergency-overlay {
                            padding: 16px !important;
                        }
                        
                        .emergency-dialog {
                            max-width: 100% !important;
                        }
                        
                        .emergency-header {
                            padding: 20px 20px 14px !important;
                        }
                        
                        .emergency-header h2 {
                            font-size: 16px !important;
                        }
                        
                        .emergency-header p {
                            font-size: 12px !important;
                        }
                        
                        .emergency-body {
                            padding: 16px 20px 20px !important;
                        }
                        
                        .emergency-type-grid {
                            gap: 10px !important;
                        }
                        
                        .emergency-type-btn {
                            padding: 16px 10px !important;
                            font-size: 13px !important;
                        }

                        .emergency-type-btn i {
                            font-size: 22px !important;
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(overlay);
            
            // Add click handlers untuk setiap tombol
            const buttons = overlay.querySelectorAll('.emergency-type-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    selectEmergencyType(type);
                });
            });
        }

        function closeEmergencyTypeDialog() {
            const overlay = document.getElementById('emergency-type-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function selectEmergencyType(type) {
            // Simpan tipe emergency
            const typeNames = {
                'medical': 'Medis',
                'fire': 'Kebakaran',
                'crime': 'Kriminal',
                'accident': 'Kecelakaan',
                'other': 'Lainnya'
            };
            
            const typeIcons = {
                'medical': '🏥',
                'fire': '🔥',
                'crime': '🚨',
                'accident': '🚗',
                'other': '⚠️'
            };
            
            const selectedTypeName = typeNames[type] || 'Lainnya';
            const selectedTypeIcon = typeIcons[type] || '⚠️';
            
            // Close dialog
            closeEmergencyTypeDialog();
            
            // Tampilkan konfirmasi dengan closure yang benar
            showCustomConfirm(
                `${selectedTypeIcon} KONFIRMASI EMERGENCY`,
                `Tipe Emergency: <strong>${selectedTypeName}</strong><br><br>Sistem akan mengirim notifikasi darurat ke grup Telegram emergency.<br><br>Semua petugas akan mendapat notifikasi realtime!<br><br>Apakah Anda yakin ingin melanjutkan?`,
                async function() {
                    // User klik "Ya, Lanjutkan" - PENTING: gunakan closure untuk preserve 'type'
                    await proceedWithEmergencyAlert(type);
                },
                function() {
                    // User klik "Batal"
                }
            );
        }

        // Fungsi untuk melanjutkan proses emergency alert
        async function proceedWithEmergencyAlert(accidentType = 'other') {

            // Tampilkan loading
            showLoadingAlert('Mengirim notifikasi emergency ke Telegram...');

            try {
                
                // Get scan_id dari localStorage - prioritas dari lastPhotoData (scan manual)
                let scanId = null;
                let scanTimestamp = null;
                let imagePath = null;
                let userName = null;
                let userPhoto = null;
                
                // Coba baca dari lastPhotoData (scan manual)
                try {
                    const lastPhotoData = localStorage.getItem('lastPhotoData');
                    if (lastPhotoData) {
                        const photoData = JSON.parse(lastPhotoData);
                        scanId = photoData.scanId;
                        scanTimestamp = photoData.timestamp;
                        userPhoto = photoData.photoUrl;
                    }
                } catch (e) {
                    // Silent error handling
                }
                
                // Fallback ke localStorage individual items
                scanId = scanId || localStorage.getItem('current_scan_id') || `EMERGENCY-${Date.now()}`;
                scanTimestamp = scanTimestamp || localStorage.getItem('scan_timestamp') || new Date().toLocaleString('id-ID');
                imagePath = imagePath || localStorage.getItem('image_path') || 'N/A';
                userName = userName || localStorage.getItem('user_name') || 'User';
                userPhoto = userPhoto || localStorage.getItem('user_photo') || null;

                // Kirim notifikasi via server dengan semua data emergency
                const response = await fetch('http://localhost:3003/send-emergency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'Emergency Alert',
                        message: `Emergency button pressed - ${accidentType}`,
                        userName: userName,
                        userPhoto: userPhoto,
                        emergencyButtonPressed: true,
                        accidentType: accidentType, // CRITICAL: Ensure this is sent
                        scanId: scanId,
                        scanPhoto: userPhoto,
                        location: {
                            latitude: EMERGENCY_LOCATION.latitude,
                            longitude: EMERGENCY_LOCATION.longitude
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Hapus loading
                hideLoadingAlert();

                // Tampilkan hasil
                if (result.success) {
                    showSuccessAlert(result, accidentType);
                } else {
                    showErrorPopup(
                        '❌ Gagal Mengirim Emergency Alert!',
                        'Error: ' + (result.error || 'Unknown error') + '\n\n' +
                        'Pastikan:\n' +
                        '1. Telegram Bot sudah dikonfigurasi\n' +
                        '2. Backend server berjalan di port 3003\n' +
                        '3. Bot sudah ditambahkan ke grup emergency'
                    );
                }

            } catch (error) {
                hideLoadingAlert();
                showErrorPopup(
                    '❌ Terjadi Kesalahan!',
                    'Gagal mengirim emergency alert.\n' +
                    'Error: ' + error.message + '\n\n' +
                    'Pastikan backend server berjalan di port 3003.'
                );
            }
        }

        function showErrorPopup(title, message) {
            const overlay = document.getElementById('errorPopupOverlay');
            const titleEl = document.getElementById('errorPopupTitle');
            const messageEl = document.getElementById('errorPopupMessage');

            titleEl.textContent = title;
            messageEl.textContent = message;
            overlay.classList.add('active');
        }

        function closeErrorPopup() {
            const overlay = document.getElementById('errorPopupOverlay');
            overlay.classList.remove('active');
        }

        // Fungsi untuk mengirim SMS via Twilio
        async function sendSMSViaTwilio(toNumber, message, contactName = 'Unknown') {
            try {
                
                // Twilio API Endpoint
                const twilioUrl = `https://api.twilio.com/2010-04-01/Accounts/${TWILIO_CONFIG.accountSid}/Messages.json`;
                
                // Prepare data
                const formData = new URLSearchParams();
                formData.append('To', toNumber);
                formData.append('From', TWILIO_CONFIG.phoneNumber);
                formData.append('Body', message);

                // Send request
                const response = await fetch(twilioUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(TWILIO_CONFIG.accountSid + ':' + TWILIO_CONFIG.authToken),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    return { 
                        success: true, 
                        phone: toNumber, 
                        contactName: contactName,
                        messageSid: data.sid,
                        data: data 
                    };
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { message: errorText };
                    }
                    
                    return { 
                        success: false, 
                        phone: toNumber, 
                        contactName: contactName,
                        error: errorData,
                        statusCode: response.status
                    };
                }

            } catch (error) {
                return { 
                    success: false, 
                    phone: toNumber, 
                    contactName: contactName,
                    error: { message: error.message, type: 'Network Error' }
                };
            }
        }

        // Fungsi untuk menampilkan loading
        function showLoadingAlert(message = 'Mengirim notifikasi darurat...') {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-alert';
            loadingDiv.innerHTML = `
                <div class="loading-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(25, 118, 210, 0.95);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    padding: 15px;
                ">
                    <div class="loading-card" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
                        padding: 40px;
                        border-radius: 20px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(25, 118, 210, 0.3);
                        border: 2px solid rgba(25, 118, 210, 0.1);
                        max-width: 400px;
                        width: 100%;
                    ">
                        <div class="loading-spinner" style="
                            width: 60px;
                            height: 60px;
                            border: 4px solid rgba(25, 118, 210, 0.2);
                            border-top: 4px solid #1976D2;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 25px;
                        "></div>
                        <div class="loading-message" style="
                            color: #1976D2;
                            font-size: 1.2rem;
                            font-weight: 600;
                            margin-bottom: 10px;
                        ">${message}</div>
                        <div class="loading-subtitle" style="
                            color: #1565C0;
                            font-size: 0.9rem;
                            opacity: 0.8;
                        ">Mohon tunggu sebentar...</div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    /* Responsive loading untuk Android */
                    @media screen and (max-width: 480px) {
                        .loading-overlay {
                            padding: 10px !important;
                        }
                        
                        .loading-card {
                            padding: 30px 20px !important;
                            border-radius: 16px !important;
                        }
                        
                        .loading-spinner {
                            width: 50px !important;
                            height: 50px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .loading-message {
                            font-size: 1rem !important;
                            margin-bottom: 8px !important;
                        }
                        
                        .loading-subtitle {
                            font-size: 0.85rem !important;
                        }
                    }
                    
                    @media screen and (max-width: 360px) {
                        .loading-card {
                            padding: 25px 15px !important;
                        }
                        
                        .loading-message {
                            font-size: 0.95rem !important;
                        }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }

        // Fungsi untuk menghapus loading
        function hideLoadingAlert() {
            const el = document.getElementById('loading-alert');
            if (el) el.remove();
        }

        // Fungsi untuk menampilkan alert sukses
        function showSuccessAlert(result, accidentType = 'other') {
            const typeNames = {
                'medical': 'Medis',
                'fire': 'Kebakaran',
                'crime': 'Kriminal',
                'accident': 'Kecelakaan',
                'other': 'Lainnya'
            };
            
            const typeIcons = {
                'medical': '🏥',
                'fire': '🔥',
                'crime': '🚨',
                'accident': '🚗',
                'other': '⚠️'
            };
            
            const typeName = typeNames[accidentType] || 'Lainnya';
            const typeIcon = typeIcons[accidentType] || '⚠️';
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'success-alert';
            alertDiv.innerHTML = `
                <div class="success-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(25, 118, 210, 0.95);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 15px;
                ">
                    <div class="success-card" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
                        padding: 40px;
                        border-radius: 20px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(25, 118, 210, 0.3);
                        border: 2px solid rgba(25, 118, 210, 0.1);
                        max-width: 500px;
                        width: 100%;
                        animation: slideIn 0.3s ease-out;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 25px;
                            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
                        ">
                            <i class="fas fa-check" style="font-size: 2.5rem; color: white;"></i>
                        </div>
                        <div class="success-title" style="
                            color: #1976D2;
                            font-size: 1.8rem;
                            font-weight: 700;
                            margin-bottom: 15px;
                        ">Emergency Alert Terkirim!</div>
                        <div class="success-subtitle" style="
                            color: #1565C0;
                            font-size: 1.1rem;
                            line-height: 1.6;
                            margin-bottom: 25px;
                        ">Notifikasi darurat telah berhasil dikirim ke semua petugas.</div>
                        <div class="success-info" style="
                            background: rgba(25, 118, 210, 0.1);
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 25px;
                            text-align: left;
                        ">
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Tipe Emergency:</span>
                                <span style="color: #1976D2; text-align: right;">${typeIcon} ${typeName}</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Telegram:</span>
                                <span style="color: #1976D2; text-align: right;">Pesan terkirim</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Grup:</span>
                                <span style="color: #1976D2; text-align: right;">Emergency Team</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Status:</span>
                                <span style="color: #1976D2; text-align: right;">Realtime (instant)</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Lokasi:</span>
                                <span style="color: #1976D2; text-align: right;">SMK MARHAS Margahayu</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.95rem; gap: 10px;">
                                <span style="color: #1565C0; font-weight: 600; flex-shrink: 0;">Waktu:</span>
                                <span style="color: #1976D2; text-align: right;">${new Date().toLocaleString('id-ID')}</span>
                            </div>
                        </div>
                        <button onclick="hideSuccessAlert()" style="
                            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 12px;
                            font-size: 1.1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(25, 118, 210, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(25, 118, 210, 0.3)'">
                            Tutup
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    /* Responsive styles untuk Android dan mobile devices */
                    @media screen and (max-width: 480px) {
                        .success-overlay {
                            padding: 10px !important;
                        }
                        
                        .success-card {
                            padding: 25px 20px !important;
                            border-radius: 16px !important;
                            max-height: 95vh !important;
                        }
                        
                        .success-card > div:first-child {
                            width: 60px !important;
                            height: 60px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .success-card > div:first-child i {
                            font-size: 2rem !important;
                        }
                        
                        .success-title {
                            font-size: 1.4rem !important;
                            margin-bottom: 12px !important;
                        }
                        
                        .success-subtitle {
                            font-size: 0.95rem !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .success-info {
                            padding: 15px !important;
                            margin-bottom: 20px !important;
                        }
                        
                        .info-row {
                            font-size: 0.85rem !important;
                            margin-bottom: 6px !important;
                            flex-wrap: wrap;
                        }
                        
                        .success-card button {
                            padding: 12px 25px !important;
                            font-size: 1rem !important;
                            width: 100%;
                        }
                    }
                    
                    /* Untuk device sangat kecil (< 360px) */
                    @media screen and (max-width: 360px) {
                        .success-card {
                            padding: 20px 15px !important;
                        }
                        
                        .success-title {
                            font-size: 1.2rem !important;
                        }
                        
                        .success-subtitle {
                            font-size: 0.9rem !important;
                        }
                        
                        .info-row {
                            font-size: 0.8rem !important;
                        }
                    }
                </style>
            `;
            document.body.appendChild(alertDiv);
        }

        // Fungsi untuk menghapus alert sukses
        function hideSuccessAlert() {
            const el = document.getElementById('success-alert');
            if (el) el.remove();
        }

        // ===== AUTO-REDIRECT TIMER SYSTEM =====
        let inactivityTimeout;
        let hasUserInteraction = false;
        const INITIAL_TIMEOUT = 60 * 1000; // 60 detik = 1 menit
        const EXTENDED_TIMEOUT = 5 * 60 * 1000; // 5 menit setelah ada interaksi
        
        function startInactivityTimer() {
            clearTimeout(inactivityTimeout);
            
            // Jika belum ada interaksi, gunakan 60 detik
            // Jika sudah ada interaksi, gunakan 5 menit
            const timeoutDuration = hasUserInteraction ? EXTENDED_TIMEOUT : INITIAL_TIMEOUT;
            
            inactivityTimeout = setTimeout(() => {
                window.location.href = 'scan.html';
            }, timeoutDuration);
        }
        
        // Fungsi dipanggil saat ada interaksi dengan tombol
        function handleUserInteraction() {
            if (!hasUserInteraction) {
                hasUserInteraction = true;
            }
            startInactivityTimer(); // Reset timer
        }
        
        // Override fungsi-fungsi yang sudah ada untuk menambah tracking interaksi
        const originalProceedEmergency = window.proceedWithEmergencyAlert;
        window.proceedWithEmergencyAlert = function(accidentType) {
            handleUserInteraction();
            if (originalProceedEmergency) return originalProceedEmergency(accidentType);
        };
        
        // Countdown display (opsional - untuk menampilkan sisa waktu)
        function startCountdown() {
            let secondsLeft = AUTO_REDIRECT_SECONDS;
            const countdownInterval = setInterval(() => {
                secondsLeft -= 60;
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 60000);
        }
        
        // Fungsi untuk test Telegram Bot system
        // Fungsi untuk mengecek status sistem
        async function checkSystemStatus() {
            
            const statusElement = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            
            if (statusElement && statusText) {
                statusElement.style.display = 'flex';
                statusElement.className = 'system-status warning';
                statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengecek Telegram Bot server...';
            }
            
            try {
                // Test backend connection
                const response = await fetch('http://localhost:3003/health');
                if (!response.ok) {
                    throw new Error('Backend server tidak berjalan');
                }
                
                // Test Telegram Bot connection
                const telegramResponse = await fetch('http://localhost:3003/telegram-status');
                const telegramData = await telegramResponse.json();
                
                if (telegramData.success) {
                    
                    if (statusElement && statusText) {
                        statusElement.className = 'system-status ready';
                        statusText.innerHTML = '<i class="fas fa-check-circle"></i> Sistem siap untuk emergency alert';
                    }
                } else {
                    throw new Error('Telegram Bot tidak dikonfigurasi: ' + telegramData.error);
                }
                
            } catch (error) {
                
                if (statusElement && statusText) {
                    statusElement.className = 'system-status error';
                    statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Telegram Bot tidak dikonfigurasi';
                }
            }
        }
        
        // ============================================
        // VOICE ASSISTANT (OPTION 1 - BROWSER ONLY)
        // ============================================
    const voiceAssistantButton = document.getElementById('voiceAssistantButton');
    const voiceAssistantStatus = document.getElementById('voiceAssistantStatus');
    const voiceAssistantStatusLabel = document.getElementById('voiceAssistantStatusLabel');
    const voiceAssistantStatusMessage = document.getElementById('voiceAssistantStatusMessage');
    const voiceAssistantTooltip = document.getElementById('voiceAssistantTooltip');
    const voiceAssistantTooltipClose = document.getElementById('voiceAssistantTooltipClose');
    const voiceAssistantPopover = document.getElementById('voiceAssistantPopover');
    const voiceAssistantPopoverClose = document.getElementById('voiceAssistantPopoverClose');
    const voiceAssistantConversation = document.getElementById('voiceAssistantConversation');

        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition || null;
        const speechSynthesisAPI = window.speechSynthesis;

        let recognitionInstance = null;
        let isListening = false;
        let hasGreetedUser = false;
    let assistantTooltipDismissed = false;
    let currentUtterance = null;
    let assistantTooltipTimer = null;
    let isStatusMinimized = false;
    let isProcessingAI = false;

    // Conversation history untuk context AI
    const conversationHistory = [];

        function safeResetAutoRedirect() {
            if (typeof resetAutoRedirect === 'function') {
                resetAutoRedirect();
            }
        }

        function updateAssistantStatus(label, message, { show = true, highlight = false } = {}) {
            // Hapus ikon chevron jika ada
            const labelText = label.replace(/<i[^>]*><\/i>/g, '').trim();
            voiceAssistantStatusLabel.innerHTML = `
                ${labelText}
                <i class="fas fa-chevron-up voice-assistant-status-toggle"></i>
            `;
            
            // Convert markdown formatting ke HTML
            let formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold** → <strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic* → <em>
                .replace(/__(.*?)__/g, '<strong>$1</strong>')      // __bold__ → <strong>
                .replace(/_(.*?)_/g, '<em>$1</em>')                // _italic_ → <em>
                .replace(/\n/g, '<br>');                           // newline → <br>
            
            voiceAssistantStatusMessage.innerHTML = formattedMessage;
            
            if (show) {
                voiceAssistantStatus.classList.add('show');
            } else {
                voiceAssistantStatus.classList.remove('show');
            }
            if (highlight) {
                voiceAssistantStatus.classList.add('highlight');
            } else {
                voiceAssistantStatus.classList.remove('highlight');
            }
        }

        function showVoiceAssistantTooltip() {
            if (!assistantTooltipDismissed && voiceAssistantTooltip) {
                voiceAssistantTooltip.classList.add('show');
            }
        }

        function hideVoiceAssistantTooltip() {
            if (voiceAssistantTooltip) {
                voiceAssistantTooltip.classList.remove('show');
            }
        }

        function openVoiceAssistantPopover() {
            if (!voiceAssistantPopover) {
                return;
            }
            voiceAssistantPopover.classList.add('open');
            voiceAssistantPopover.setAttribute('aria-hidden', 'false');
        }

        function closeVoiceAssistantPopover() {
            if (!voiceAssistantPopover) {
                return;
            }
            voiceAssistantPopover.classList.remove('open');
            voiceAssistantPopover.setAttribute('aria-hidden', 'true');
        }

        function appendConversationEntry(type, text) {
            if (!voiceAssistantConversation) {
                return;
            }

            const placeholder = voiceAssistantConversation.querySelector('.voice-conversation-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const entry = document.createElement('div');
            entry.className = 'voice-conversation-entry';
            if (type === 'answer') {
                entry.classList.add('voice-conversation-answer');
            }

            const label = document.createElement('span');
            label.className = 'voice-label';
            label.textContent = type === 'question' ? 'Anda' : 'Asisten';

            const body = document.createElement('p');
            const lines = (text || '').split('\n');
            lines.forEach((line, index) => {
                body.appendChild(document.createTextNode(line.trim()));
                if (index < lines.length - 1) {
                    body.appendChild(document.createElement('br'));
                }
            });

            entry.appendChild(label);
            entry.appendChild(body);
            voiceAssistantConversation.appendChild(entry);
            voiceAssistantConversation.scrollTop = voiceAssistantConversation.scrollHeight;
        }

        function cancelSpeechIfSpeaking() {
            if (speechSynthesisAPI && (speechSynthesisAPI.speaking || speechSynthesisAPI.pending)) {
                speechSynthesisAPI.cancel();
            }
            currentUtterance = null;
        }

        function speakText(text) {
            if (!speechSynthesisAPI) {
                return;
            }

            cancelSpeechIfSpeaking();
            
            // Bersihkan markdown formatting dari text
            let cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Hapus ** untuk bold
                .replace(/\*(.*?)\*/g, '$1')      // Hapus * untuk italic
                .replace(/__(.*?)__/g, '$1')      // Hapus __ untuk bold
                .replace(/_(.*?)_/g, '$1')        // Hapus _ untuk italic
                .replace(/```.*?```/gs, '')       // Hapus code blocks
                .replace(/`(.*?)`/g, '$1')        // Hapus inline code
                .replace(/#{1,6}\s/g, '')         // Hapus # untuk headers
                .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Hapus links, simpan text
                .replace(/\n+/g, '. ')            // Replace newlines dengan pause
                .trim();
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'id-ID';
            utterance.pitch = 1;
            utterance.rate = 1.25;
            utterance.volume = 1;
            utterance.onend = () => {
                currentUtterance = null;
                if (!isListening) {
                    updateAssistantStatus('Asisten Pertolongan Pertama', 'Tekan tombol mikrofon untuk mulai bertanya.');
                }
            };
            utterance.onerror = () => {
                currentUtterance = null;
            };
            currentUtterance = utterance;
            speechSynthesisAPI.speak(utterance);
        }

        function stopListening() {
            if (recognitionInstance && isListening) {
                recognitionInstance.stop();
            }
            isListening = false;
            voiceAssistantButton.classList.remove('listening');
            updateAssistantStatus('Asisten Pertolongan Pertama', 'Tekan tombol mikrofon untuk mulai bertanya.');
        }

        function handleUserQuery(queryText) {
            const cleanedQuery = (queryText || '').trim();

            if (!cleanedQuery) {
                const retryText = 'Maaf, saya tidak mendengar pertanyaan Anda. Tolong ulangi dengan suara yang lebih jelas.';
                updateAssistantStatus('Silakan ulangi', retryText);
                speakText(retryText);
                return;
            }

            updateAssistantStatus('Anda berkata', `"${cleanedQuery}"`);

            // Gunakan AI untuk generate response
            generateAIResponse(cleanedQuery);
        }

        /**
         * Generate response menggunakan OpenRouter AI (via Backend)
         */
        async function generateAIResponse(userQuestion) {
            if (isProcessingAI) {
                return;
            }

            isProcessingAI = true;
            updateAssistantStatus('AI Sedang Berpikir', 'Memproses pertanyaan Anda...', { highlight: true });

            try {
                // Tambahkan pertanyaan user ke history
                conversationHistory.push({
                    role: 'user',
                    content: userQuestion
                });

                // Call backend API endpoint
                const response = await fetch('/api/ai-assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: userQuestion,
                        conversationHistory: conversationHistory.slice(-10) // Last 10 messages only
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'AI response failed');
                }

                const aiAnswer = data.answer;

                // Tambahkan jawaban AI ke history
                conversationHistory.push({
                    role: 'assistant',
                    content: aiAnswer
                });

                // Batasi history untuk menghindari token overflow (max 10 pesan terakhir)
                if (conversationHistory.length > 10) {
                    conversationHistory.splice(0, conversationHistory.length - 10);
                }

                // Update UI dan speak
                setTimeout(() => {
                    updateAssistantStatus('Asisten AI Menjawab', aiAnswer);
                    speakText(aiAnswer);
                }, 300);

                isProcessingAI = false;

            } catch (error) {
                
                // Fallback ke knowledge base lokal jika AI gagal
                const fallbackResponse = generateAssistantResponseFallback(userQuestion);
                
                updateAssistantStatus('Asisten Menjawab', fallbackResponse);
                speakText(fallbackResponse);
                
                isProcessingAI = false;
            }
        }

        /**
         * Fallback response jika AI gagal (knowledge base lokal)
         */
        function generateAssistantResponseFallback(query) {
            const lower = query.toLowerCase();

            const knowledgeBase = [
                {
                    keywords: ['pertolongan pertama', 'first aid', 'p3k', 'drsabc', 'drs abc'],
                    answer: `Langkah dasar pertolongan pertama mengikuti prinsip DRS ABC:
1. Danger: pastikan lokasi aman dari bahaya bagi Anda dan korban.
2. Response: panggil korban, tepuk bahu, lihat apakah ada respons.
3. Send for help: jika tidak respons, segera panggil bantuan (112 atau 119).
4. Airway: buka jalan napas dengan head tilt-chin lift.
5. Breathing: periksa napas selama 10 detik, lihat dada naik turun.
6. Circulation: bila tidak ada napas normal, mulai CPR atau gunakan AED bila tersedia.
Sambil menunggu bantuan, terus pantau kondisi korban dan jaga tetap hangat.`
                },
                {
                    keywords: ['luka', 'perdarahan', 'darah', 'bleeding'],
                    answer: `Penanganan perdarahan eksternal:
1. Cuci tangan atau gunakan sarung tangan jika tersedia.
2. Tekan langsung luka dengan kain/perban bersih selama minimal 10 menit.
3. Angkat bagian tubuh yang luka di atas jantung bila memungkinkan.
4. Jangan lepaskan tekanan untuk melihat luka; tambahkan perban jika darah merembes.
5. Jika perdarahan tidak berhenti atau luka dalam, segera bawa ke fasilitas medis.`
                },
                {
                    keywords: ['cpr', 'resusitasi', 'jantung'],
                    answer: `Langkah CPR dewasa (jika tidak bernapas normal):
1. Panggil bantuan, aktifkan 112/119 atau minta orang lain hubungi.
2. Posisikan korban telentang, lutut di samping dada.
3. Letakkan telapak tangan di tengah dada (tulang dada), tangan kedua di atasnya.
4. Tekan sedalam 5–6 cm dengan ritme 100–120 kompresi per menit.
5. Jika terlatih, lakukan siklus 30 kompresi : 2 napas bantuan.
6. Lanjut sampai korban sadar, tim medis datang, atau Anda lelah.`
                },
                {
                    keywords: ['nomor darurat', 'telepon darurat', 'emergency call'],
                    answer: `Nomor layanan darurat nasional Indonesia:
• 112 – Layanan darurat terpadu (polisi, ambulans, pemadam kebakaran).
• 119 – Layanan gawat darurat medis.
• 110 – Polisi.
• 113 – Pemadam kebakaran.
• 115 – SAR/Basarnas.
• 118 – Ambulans (beberapa wilayah).`
                }
            ];

            const matched = knowledgeBase.find(item => item.keywords.some(keyword => lower.includes(keyword)));
            if (matched) {
                return matched.answer;
            }

            return 'Saya dapat membantu menjelaskan pertolongan pertama seperti menghentikan perdarahan, penanganan luka bakar, atau CPR. Silakan ajukan pertanyaan yang lebih spesifik agar saya bisa membantu dengan detail.';
        }

        function initialiseRecognition() {
            if (!SpeechRecognitionAPI) {
                voiceAssistantButton.classList.add('disabled');
                voiceAssistantButton.setAttribute('disabled', 'disabled');
                updateAssistantStatus('Perlu Browser Chrome', 'Browser Anda belum mendukung asisten suara. Gunakan Google Chrome atau Microsoft Edge versi terbaru.');
                return;
            }

            recognitionInstance = new SpeechRecognitionAPI();
            recognitionInstance.lang = 'id-ID';
            recognitionInstance.interimResults = false;
            recognitionInstance.maxAlternatives = 1;
            recognitionInstance.continuous = false;

            recognitionInstance.addEventListener('start', () => {
                isListening = true;
                voiceAssistantButton.classList.add('listening');
                updateAssistantStatus('Mendengarkan', 'Silakan bicara, saya siap membantu.');
            });

            recognitionInstance.addEventListener('result', (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join(' ');
                handleUserQuery(transcript);
            });

            recognitionInstance.addEventListener('end', () => {
                isListening = false;
                voiceAssistantButton.classList.remove('listening');
                safeResetAutoRedirect();
            });

            recognitionInstance.addEventListener('error', (event) => {
                let errorMessage = 'Terjadi kendala saat mendengarkan. Coba ulangi lagi.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Izin mikrofon dibutuhkan untuk menjalankan asisten suara. Mohon aktifkan izin mikrofon pada browser ini.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Saya tidak mendengar suara. Silakan bicara lebih dekat ke mikrofon.';
                }
                updateAssistantStatus('Asisten Pertolongan Pertama', errorMessage);
                speakText(errorMessage);
                stopListening();
            });
        }

        voiceAssistantButton.addEventListener('click', () => {
            safeResetAutoRedirect();
            hideVoiceAssistantTooltip();
            assistantTooltipDismissed = true;
            // Jangan buka popover, biarkan hanya status biru yang muncul
            // openVoiceAssistantPopover();

            if (!SpeechRecognitionAPI) {
                speakText('Browser Anda belum mendukung fitur mikrofon otomatis. Silakan gunakan Google Chrome versi terbaru.');
                return;
            }

            if (!recognitionInstance) {
                initialiseRecognition();
            }

            if (!recognitionInstance) {
                return;
            }

            const wasSpeaking = speechSynthesisAPI && (speechSynthesisAPI.speaking || speechSynthesisAPI.pending);
            if (wasSpeaking) {
                cancelSpeechIfSpeaking();
            }

            if (isListening) {
                stopListening();
                return;
            }

            if (!hasGreetedUser) {
                const greeting = 'Halo, saya asisten pertolongan pertama. Apakah Anda ingin mengetahui tentang pertolongan pertama, atau ingin bertanya apa?';
                speakText(greeting);
                updateAssistantStatus('Asisten Siap Membantu', 'Saya baru saja menyapa Anda. Tekan lagi dan sampaikan pertanyaan Anda.');
                hasGreetedUser = true;
                return;
            }

            try {
                recognitionInstance.start();
            } catch (err) {
                updateAssistantStatus('Asisten Pertolongan Pertama', 'Saya mengalami kendala saat mulai mendengarkan. Coba ulangi dalam beberapa detik.');
            }
        });

        if (voiceAssistantTooltipClose) {
            voiceAssistantTooltipClose.addEventListener('click', () => {
                assistantTooltipDismissed = true;
                hideVoiceAssistantTooltip();
            });
        }

        if (voiceAssistantPopoverClose) {
            voiceAssistantPopoverClose.addEventListener('click', () => {
                closeVoiceAssistantPopover();
            });
        }

        const voiceAssistantWrapper = document.querySelector('.voice-assistant-wrapper');

        document.addEventListener('click', (event) => {
            if (!voiceAssistantPopover || !voiceAssistantPopover.classList.contains('open')) {
                return;
            }
            if (voiceAssistantWrapperContains(event.target)) {
                return;
            }
            closeVoiceAssistantPopover();
        });

        function voiceAssistantWrapperContains(target) {
            if (!voiceAssistantWrapper) {
                return false;
            }
            return voiceAssistantWrapper.contains(target);
        }

        assistantTooltipTimer = setTimeout(() => {
            showVoiceAssistantTooltip();
        }, 1800);

        // Toggle minimize/maximize status popup
        if (voiceAssistantStatus) {
            voiceAssistantStatus.addEventListener('click', (e) => {
                // Jangan toggle jika sedang klik tombol mikrofon
                if (e.target.closest('.voice-assistant-button')) {
                    return;
                }
                
                isStatusMinimized = !isStatusMinimized;
                if (isStatusMinimized) {
                    voiceAssistantStatus.classList.add('minimized');
                } else {
                    voiceAssistantStatus.classList.remove('minimized');
                }
            });
        }

        // ============================================
        // SETTINGS SIDEBAR FUNCTIONALITY
        // ============================================
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsClose = document.getElementById('settingsClose');

        function openSettings() {
            settingsSidebar.classList.add('active');
            settingsOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSettings() {
            settingsSidebar.classList.remove('active');
            settingsOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        settingsBtn.addEventListener('click', openSettings);
        settingsClose.addEventListener('click', closeSettings);
        settingsOverlay.addEventListener('click', closeSettings);

        // Close sidebar dengan ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsSidebar.classList.contains('active')) {
                closeSettings();
            }
        });

        // ============================================
        // AUTO REDIRECT TO SCAN.HTML AFTER 3 MINUTES
        // ============================================
        let autoRedirectTimer = null;
        const AUTO_REDIRECT_TIME = 3 * 60 * 1000; // 3 menit dalam milliseconds

        function startAutoRedirect() {
            // Clear timer yang ada jika ada
            if (autoRedirectTimer) {
                clearTimeout(autoRedirectTimer);
            }

            // Set timer baru
            autoRedirectTimer = setTimeout(() => {
                
                // JANGAN exit kiosk mode - biarkan localStorage tetap aktif
                // Halaman scan.html akan otomatis masuk fullscreen karena membaca localStorage
                // if (isKioskModeActive) {
                //     isKioskModeActive = false;
                //     exitFullscreen();
                // }
                
                // Redirect ke scan.html (kiosk mode akan continue di halaman baru)
                window.location.href = 'scan.html';
            }, AUTO_REDIRECT_TIME);
        }

        function resetAutoRedirect() {
            startAutoRedirect();
        }

        // Events yang reset timer
        ['click', 'touchstart', 'mousemove', 'keypress', 'scroll'].forEach(event => {
            document.addEventListener(event, resetAutoRedirect, { passive: true });
        });

        // Mulai auto redirect saat page load
        startAutoRedirect();
        
        // Tampilkan identitas user dari localStorage
        function displayUserIdentity() {
            const userName = localStorage.getItem('user_name');
            const userNik = localStorage.getItem('user_nik');
            const isGuest = localStorage.getItem('is_guest') === 'true';
            const accessType = localStorage.getItem('access_type');
            
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeSubtitle = document.getElementById('welcomeSubtitle');
            const userIdentity = document.getElementById('userIdentity');
            const userNameEl = document.getElementById('userName');
            const userBadge = document.getElementById('userBadge');
            const userIcon = document.getElementById('userIcon');
            
            if (userName) {
                // Tampilkan identitas user
                welcomeTitle.textContent = `Selamat Datang, ${userName}!`;
                
                if (isGuest) {
                    // Guest Emergency Mode
                    userIdentity.style.display = 'block';
                    userIdentity.style.background = 'rgba(220, 38, 38, 0.1)';
                    userIcon.className = 'fas fa-exclamation-triangle';
                    userIcon.style.color = '#dc2626';
                    userNameEl.textContent = userName;
                    userNameEl.style.color = '#dc2626';
                    userBadge.innerHTML = '<i class="fas fa-shield-alt"></i> Mode Emergency - Akses Penuh';
                    userBadge.style.color = '#991b1b';
                } else {
                    // Registered User
                    userIdentity.style.display = 'block';
                    userIdentity.style.background = 'rgba(5, 150, 105, 0.1)';
                    userIcon.className = 'fas fa-user-check';
                    userIcon.style.color = '#059669';
                    userNameEl.textContent = userName;
                    userNameEl.style.color = '#059669';
                    userBadge.innerHTML = userNik ? `NIK: ${userNik}` : 'User Terdaftar';
                    userBadge.style.color = '#065f46';
                }
            } else {
                // Tidak ada identitas, tampilkan default
                welcomeTitle.textContent = 'Selamat Datang!';
                welcomeSubtitle.textContent = 'Pilih layanan darurat yang Anda butuhkan';
            }
        }

        window.onload = () => {
            displayUserIdentity();
            startInactivityTimer(); // Mulai timer inactivity
            startCountdown();
            checkSystemStatus();
            startAutoRedirect(); // Mulai auto redirect timer
            initKioskMode(); // Initialize Kiosk Mode
            
            // Tambahkan event listener untuk semua tombol
            document.querySelectorAll('button, a, .menu-item').forEach(element => {
                element.addEventListener('click', handleUserInteraction);
            });
        };
    </script>

    <!-- Kiosk Mode Password Modal -->
    <div class="kiosk-password-modal" id="kioskPasswordModal">
        <div class="kiosk-password-content">
            <div class="kiosk-password-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="kiosk-password-title">Keluar dari Kiosk Mode</h2>
            <p class="kiosk-password-description">
                Masukkan password untuk keluar dari mode layar penuh dan mengakses kontrol browser.
            </p>
            <input 
                type="password" 
                class="kiosk-password-input" 
                id="kioskPasswordInput" 
                placeholder="Masukkan Password"
                maxlength="20"
            >
            <div class="kiosk-password-error" id="kioskPasswordError">
                <i class="fas fa-exclamation-circle"></i> Password salah! Silakan coba lagi.
            </div>
            <div class="kiosk-password-buttons">
                <button class="kiosk-btn kiosk-btn-cancel" id="kioskCancelBtn">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="kiosk-btn kiosk-btn-submit" id="kioskSubmitBtn">
                    <i class="fas fa-check"></i> Keluar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://fvayuhanwcwinkvvvisk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2YXl1aGFud2N3aW5rdnZ2aXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDk1NTYsImV4cCI6MjA3NTQ4NTU1Nn0.AP0ZYsrUQ1ACD7fmX1wTM88_zzMtvyKXmgc9wCVvRrM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== KIOSK MODE / FULL SCREEN LOCK SYSTEM =====
        let isKioskModeActive = false;
        let kioskPasswordFromDB = null;
        let kioskActionType = null; // 'enter' atau 'exit'

        // Load password from Supabase on page load
        async function loadKioskPassword() {
            try {
                // Query password dari table kiosk_settings
                const { data, error } = await supabase
                    .from('kiosk_settings')
                    .select('password')
                    .eq('id', 1)
                    .single();

                if (error) throw error;

                if (data && data.password) {
                    kioskPasswordFromDB = data.password;
                } else {
                    // Fallback password jika database kosong
                    kioskPasswordFromDB = 'smkmarhas2025';
                }
            } catch (error) {
                // Fallback password
                kioskPasswordFromDB = 'smkmarhas2025';
            }
        }

        function initKioskMode() {
            // Load password dari database
            loadKioskPassword();

            // Prevent F11 key (ALWAYS active)
            document.addEventListener('keydown', preventF11);

            // Prevent right click
            document.addEventListener('contextmenu', (e) => e.preventDefault());

            // Monitor fullscreen changes
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);

            // Enter Kiosk Mode button
            const enterKioskBtn = document.getElementById('enterKioskModeBtn');
            if (enterKioskBtn) {
                enterKioskBtn.addEventListener('click', () => {
                    kioskActionType = 'enter';
                    showPasswordModal('Masuk Kiosk Mode', 'Masukkan password untuk mengaktifkan mode layar penuh.');
                });
            }

            // Exit Kiosk Mode button
            const exitKioskBtn = document.getElementById('exitKioskModeBtn');
            if (exitKioskBtn) {
                exitKioskBtn.addEventListener('click', () => {
                    kioskActionType = 'exit';
                    showPasswordModal('Keluar dari Kiosk Mode', 'Masukkan password untuk keluar dari mode layar penuh.');
                });
            }

            // Password modal controls
            const kioskPasswordModal = document.getElementById('kioskPasswordModal');
            const kioskPasswordInput = document.getElementById('kioskPasswordInput');
            const kioskSubmitBtn = document.getElementById('kioskSubmitBtn');
            const kioskCancelBtn = document.getElementById('kioskCancelBtn');
            const kioskPasswordError = document.getElementById('kioskPasswordError');

            // Submit password
            kioskSubmitBtn.addEventListener('click', async () => {
                const password = kioskPasswordInput.value;
                
                // Verify password dengan database
                if (await verifyKioskPassword(password)) {
                    if (kioskActionType === 'enter') {
                        enterKioskModeWithPassword();
                    } else if (kioskActionType === 'exit') {
                        exitKioskModeWithPassword();
                    }
                    hidePasswordModal();
                    kioskPasswordInput.value = '';
                    kioskPasswordError.classList.remove('show');
                } else {
                    // Wrong password
                    kioskPasswordInput.classList.add('error');
                    kioskPasswordError.classList.add('show');
                    setTimeout(() => {
                        kioskPasswordInput.classList.remove('error');
                    }, 500);
                    kioskPasswordInput.value = '';
                    kioskPasswordInput.focus();
                }
            });

            // Cancel button
            kioskCancelBtn.addEventListener('click', hidePasswordModal);

            // Enter key to submit
            kioskPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    kioskSubmitBtn.click();
                }
            });

            // Escape key to cancel
            kioskPasswordModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hidePasswordModal();
                }
            });
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            
            // Request fullscreen dengan opsi untuk hide UI
            const options = {
                navigationUI: "hide" // Hide browser navigation UI
            };
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen(options).then(() => {
                    applyKioskStyles();
                }).catch(err => {
                    // Fallback ke metode lain
                    tryAlternativeFullscreen();
                });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                applyKioskStyles();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
                applyKioskStyles();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
                applyKioskStyles();
            } else {
                // Browser tidak support fullscreen API
                tryAlternativeFullscreen();
            }
        }

        function tryAlternativeFullscreen() {
            // Fallback: Maximize window dengan CSS
            document.body.style.position = 'fixed';
            document.body.style.top = '0';
            document.body.style.left = '0';
            document.body.style.width = '100vw';
            document.body.style.height = '100vh';
            document.body.style.overflow = 'hidden';
            document.body.style.zIndex = '999999';
            applyKioskStyles();
        }

        function applyKioskStyles() {
            // Tambah class untuk styling fullscreen
            document.documentElement.classList.add('kiosk-fullscreen');
            document.body.classList.add('kiosk-fullscreen');
            
            // Hide scrollbars
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            
            // Ensure 100% viewport
            document.documentElement.style.width = '100vw';
            document.documentElement.style.height = '100vh';
        }

        function removeKioskStyles() {
            document.documentElement.classList.remove('kiosk-fullscreen');
            document.body.classList.remove('kiosk-fullscreen');
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            document.documentElement.style.width = '';
            document.documentElement.style.height = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.width = '';
            document.body.style.height = '';
            document.body.style.zIndex = '';
        }

        function exitFullscreen() {
            removeKioskStyles();
            
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        function preventF11(e) {
            // ONLY block F11 key when kiosk mode is active
            if (e.key === 'F11' && isKioskModeActive) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            // Block Escape key (prevents exiting fullscreen)
            if (e.key === 'Escape' && isKioskModeActive) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        function handleFullscreenChange() {
            // If user somehow exits fullscreen while kiosk mode is active
            const isFullscreen = document.fullscreenElement || 
                                document.webkitFullscreenElement || 
                                document.mozFullScreenElement || 
                                document.msFullscreenElement;
            
            if (!isFullscreen && isKioskModeActive) {
                // DISABLED: Auto re-enter fullscreen menyebabkan error "API can only be initiated by a user gesture"
                // User harus manual re-enter dengan klik tombol kiosk mode
                
                // Optional: Show toast notification
                showToast(
                    '⚠️ Fullscreen Keluar', 
                    'Fullscreen mode keluar. Silakan klik "Masuk Kiosk Mode" untuk masuk kembali.', 
                    'info', 
                    5000
                );
                
                // Auto-exit kiosk mode karena fullscreen sudah tidak aktif
                isKioskModeActive = false;
                localStorage.removeItem('kiosk_mode_active');
                removeKioskStyles();
            }
        }

        // Verify password dengan database
        async function verifyKioskPassword(inputPassword) {
            if (!kioskPasswordFromDB) {
                await loadKioskPassword();
            }
            return inputPassword === kioskPasswordFromDB;
        }

        // Toast Notification Functions
        let toastTimeout;
        
        function showToast(title, message, type = 'info', duration = 5000) {
            const toast = document.getElementById('toastNotification');
            const toastTitle = toast.querySelector('.toast-title');
            const toastMessage = toast.querySelector('.toast-message');
            const toastIcon = toast.querySelector('.toast-icon i');
            
            // Clear previous timeout
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            
            // Remove existing type classes
            toast.classList.remove('success', 'error', 'info', 'show');
            
            // Set content
            toastTitle.textContent = title;
            toastMessage.innerHTML = message.replace(/\n/g, '<br>');
            
            // Set icon based on type
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else {
                toastIcon.className = 'fas fa-info-circle';
            }
            
            // Add type class and show
            toast.classList.add(type);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto hide after duration
            toastTimeout = setTimeout(() => {
                hideToast();
            }, duration);
        }
        
        function hideToast() {
            const toast = document.getElementById('toastNotification');
            toast.classList.remove('show');
            
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
        }

        // Enter Kiosk Mode dengan password
        function enterKioskModeWithPassword() {
            isKioskModeActive = true;
            
            // Save kiosk mode status to localStorage untuk halaman lain
            localStorage.setItem('kiosk_mode_active', 'true');
            
            enterFullscreen();
            
            // Show notification dengan instruksi
            setTimeout(() => {
                const message = `✅ Kiosk Mode aktif!\n\n` +
                    `🔒 Layar penuh diaktifkan.\n\n` +
                    `💡 Tips untuk full screen sempurna:\n` +
                    `• Tekan F11 sebelum masuk kiosk mode untuk hide browser UI\n` +
                    `• Atau gunakan Chrome Kiosk Mode: chrome.exe --kiosk\n` +
                    `• Taskbar Windows dapat di-hide via Settings`;
                showToast('🔒 Kiosk Mode Aktif', message, 'success', 8000);
            }, 500);
        }

        // Exit Kiosk Mode dengan password
        function exitKioskModeWithPassword() {
            isKioskModeActive = false;
            
            // Remove kiosk mode status dari localStorage
            localStorage.removeItem('kiosk_mode_active');
            
            exitFullscreen();
            showToast('🔓 Kiosk Mode Dinonaktifkan', '✅ Kiosk Mode dinonaktifkan. Anda sekarang dapat mengakses kontrol browser.', 'info', 5000);
        }

        function showPasswordModal(title, description) {
            const modal = document.getElementById('kioskPasswordModal');
            const input = document.getElementById('kioskPasswordInput');
            const error = document.getElementById('kioskPasswordError');
            const modalTitle = document.querySelector('.kiosk-password-title');
            const modalDesc = document.querySelector('.kiosk-password-description');
            const submitBtn = document.getElementById('kioskSubmitBtn');
            
            // Update title dan description
            if (modalTitle) modalTitle.textContent = title;
            if (modalDesc) modalDesc.textContent = description;
            
            // Update button text
            if (kioskActionType === 'enter') {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Aktifkan';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Keluar';
            }
            
            modal.classList.add('active');
            error.classList.remove('show');
            input.value = '';
            
            // Close settings sidebar
            const settingsSidebar = document.getElementById('settingsSidebar');
            if (settingsSidebar) {
                settingsSidebar.classList.remove('active');
            }
            
            // Focus input after animation
            setTimeout(() => {
                input.focus();
            }, 300);
        }

        function hidePasswordModal() {
            const modal = document.getElementById('kioskPasswordModal');
            const input = document.getElementById('kioskPasswordInput');
            const error = document.getElementById('kioskPasswordError');
            
            modal.classList.remove('active');
            error.classList.remove('show');
            input.value = '';
        }

        // Prevent user from leaving page - DISABLED untuk menghindari alert saat auto-redirect
        // Kiosk mode tetap mencegah akses browser controls tanpa perlu beforeunload
        // window.addEventListener('beforeunload', (e) => {
        //     if (isKioskModeActive) {
        //         e.preventDefault();
        //         e.returnValue = 'Anda yakin ingin meninggalkan halaman ini?';
        //         return e.returnValue;
        //     }
        // });
    </script>

    <!-- Toast Notification Container -->
    <div class="toast-notification" id="toastNotification">
        <div class="toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">Notification</div>
            <div class="toast-message">Message content</div>
        </div>
        <button class="toast-close" onclick="hideToast()">
            <i class="fas fa-times"></i>
        </button>
    </div>
</body>
</html>
